"""
モロッコ観光ガイド - Streamlit版
Morocco Tourism Guide App powered by Streamlit
"""

import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
import json
import os
import traceback
import time
from functools import wraps
import logging
from datetime import datetime
from typing import Dict, List, Optional

# ログ設定
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# エラーハンドリングデコレーター
def handle_errors(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            logger.error(f"Error in {func.__name__}: {str(e)}")
            st.error(f"❌ エラーが発生しました: {str(e)}")
            with st.expander("🔍 エラー詳細", expanded=False):
                st.code(traceback.format_exc())
            return None
    return wrapper

# パフォーマンス測定デコレーター
def measure_performance(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        logger.info(f"{func.__name__} completed in {end_time - start_time:.3f} seconds")
        return result
    return wrapper

# ページ設定
st.set_page_config(
    page_title="モロッコ観光ガイド",
    page_icon="🕌",
    layout="wide",
    initial_sidebar_state="expanded"
)

# テーマ設定の初期化
def init_theme():
    """テーマ設定の初期化"""
    try:
        if "theme" not in st.session_state:
            st.session_state.theme = "ライト"
        return st.session_state.theme
    except Exception as e:
        logger.warning(f"Theme initialization failed: {e}")
        return "ライト"

def get_theme_css(theme):
    """テーマに応じたCSSを取得"""
    if theme == "ダーク":
        return """
        <style>
            /* ダークテーマ */
            .stApp {
                background-color: #1e1e1e;
                color: #ffffff;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
            
            .main-header {
                text-align: center;
                padding: 1rem;
                background: linear-gradient(90deg, #c0392b, #8b0000);
                color: white;
                border-radius: 10px;
                margin-bottom: 2rem;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
            
            .spot-card {
                border: 1px solid #444;
                border-radius: 10px;
                padding: 1rem;
                margin: 0.5rem 0;
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                color: #ffffff;
            }
            
            .spot-title {
                color: #ffffff;
                font-size: 1.2rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
            
            .spot-meta {
                color: #cccccc;
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .verified-badge {
                background: #27ae60;
                color: white;
                padding: 0.2rem 0.5rem;
                border-radius: 15px;
                font-size: 0.8rem;
            }
            
            .category-badge {
                background: #3498db;
                color: white;
                padding: 0.2rem 0.5rem;
                border-radius: 15px;
                font-size: 0.8rem;
                margin-right: 0.5rem;
            }
            
            /* Streamlitコンポーネントのダークテーマ調整 */
            .stSelectbox > div > div {
                background-color: #2d2d2d;
                border: 1px solid #444;
                color: #ffffff;
            }
            
            .stTextInput > div > div {
                background-color: #2d2d2d;
                border: 1px solid #444;
                color: #ffffff;
            }
            
            .stTextArea > div > div {
                background-color: #2d2d2d;
                border: 1px solid #444;
                color: #ffffff;
            }
            
            .stMultiSelect > div > div {
                background-color: #2d2d2d;
                border: 1px solid #444;
            }
            
            .stSidebar {
                background-color: #1a1a1a;
            }
            
            .css-1d391kg {
                background-color: #1a1a1a;
            }
            
            /* メトリクスカードのダークテーマ */
            [data-testid="metric-container"] {
                background: linear-gradient(90deg, #2d2d2d, #3a3a3a);
                border: 1px solid #444;
                padding: 1rem;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            /* タブのダークテーマ */
            .stTabs [data-baseweb="tab-list"] {
                background-color: #2d2d2d;
            }
            
            .stTabs [data-baseweb="tab"] {
                background-color: #2d2d2d;
                color: #ffffff;
            }
            
            /* チャット要素のダークテーマ */
            .stChatMessage {
                background-color: #2d2d2d;
                border: 1px solid #444;
            }
            
            /* マークダウンテキストのダークテーマ */
            .stMarkdown {
                color: #ffffff;
            }
            
            /* 情報ボックスのダークテーマ */
            .stInfo {
                background-color: #2d4a5a;
                border: 1px solid #3498db;
            }
            
            .stSuccess {
                background-color: #2d4a2d;
                border: 1px solid #27ae60;
            }
            
            .stWarning {
                background-color: #4a4a2d;
                border: 1px solid #f39c12;
            }
            
            .stError {
                background-color: #4a2d2d;
                border: 1px solid #e74c3c;
            }
            
            /* ボタンのダークテーマ */
            .stButton > button {
                background-color: #3a3a3a;
                border: 1px solid #555;
                color: #ffffff;
            }
            
            .stButton > button:hover {
                background-color: #4a4a4a;
                border: 1px solid #666;
            }
            
            /* リンクのダークテーマ */
            a {
                color: #5dade2;
            }
            
            a:hover {
                color: #85c1e9;
            }
            
            /* テーブルのダークテーマ */
            .stDataFrame {
                background-color: #2d2d2d;
                color: #ffffff;
            }
            
            /* セレクトボックスの詳細スタイル */
            .stSelectbox > div > div > div {
                background-color: #2d2d2d;
                color: #ffffff;
            }
            
            /* カスタムホバー効果 */
            .spot-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.4);
                transition: all 0.3s ease;
            }
            
            /* スクロール位置制御 */
            html {
                scroll-behavior: smooth;
                overflow-anchor: none;
            }
            
            body {
                scroll-behavior: smooth;
                overflow-anchor: none;
            }
            
            /* 詳細ページのスクロール制御 */
            #detail-page-top {
                position: relative;
                top: 0;
                scroll-margin-top: 0;
                scroll-snap-margin-top: 0;
            }
        </style>
        """
    else:
        return """
        <style>
            /* ライトテーマ */
            .stApp {
                background-color: #ffffff;
                color: #000000;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
            
            .main-header {
                text-align: center;
                padding: 1rem;
                background: linear-gradient(90deg, #e74c3c, #c0392b);
                color: white;
                border-radius: 10px;
                margin-bottom: 2rem;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            
            .spot-card {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 1rem;
                margin: 0.5rem 0;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                color: #000000;
            }
            
            .spot-title {
                color: #2c3e50;
                font-size: 1.2rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
            
            .spot-meta {
                color: #7f8c8d;
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .verified-badge {
                background: #27ae60;
                color: white;
                padding: 0.2rem 0.5rem;
                border-radius: 15px;
                font-size: 0.8rem;
            }
            
            .category-badge {
                background: #3498db;
                color: white;
                padding: 0.2rem 0.5rem;
                border-radius: 15px;
                font-size: 0.8rem;
                margin-right: 0.5rem;
            }
            
            /* メトリクスカードのライトテーマ */
            [data-testid="metric-container"] {
                background: linear-gradient(90deg, #f8f9fa, #e9ecef);
                border: 1px solid #dee2e6;
                padding: 1rem;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* カスタムホバー効果 */
            .spot-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            
            /* ボタンのライトテーマ */
            .stButton > button {
                background-color: #ffffff;
                border: 1px solid #ddd;
                color: #000000;
            }
            
            .stButton > button:hover {
                background-color: #f8f9fa;
                border: 1px solid #ccc;
            }
            
            /* スクロール位置制御 */
            html {
                scroll-behavior: smooth;
                overflow-anchor: none;
            }
            
            body {
                scroll-behavior: smooth;
                overflow-anchor: none;
            }
            
            /* 詳細ページのスクロール制御 */
            #detail-page-top {
                position: relative;
                top: 0;
                scroll-margin-top: 0;
                scroll-snap-margin-top: 0;
            }
        </style>
        """

# テーマの初期化とCSS適用
current_theme = init_theme()
st.markdown(get_theme_css(current_theme), unsafe_allow_html=True)

# 観光地データ
@st.cache_data
@handle_errors
@measure_performance
def load_spots_data():
    """観光地データを読み込み"""
    spots = [
        # マラケシュの観光地（15箇所）
        {
            'id': 1,
            'name': 'ジャマ・エル・フナ広場',
            'city': 'マラケシュ',
            'category': '広場・市場',
            'summary': 'モロッコ最大の文化交流の場として1000年以上親しまれるユネスコ世界遺産の広場',
            'features': {
                '景観': '赤レンガ造りの建物に囲まれた広大な石畳の広場、夜には幻想的なライトアップ',
                '歴史': '11世紀のアルモラヴィ朝時代から商業の中心地として発達、ユネスコ無形文化遺産',
                '文化': 'ベルベル、アラブ、アンダルシア文化が融合した「生きた文化博物館」'
            },
            'highlights': [
                'フレッシュオレンジジュース屋台（10-15DH）',
                '伝統的なヘナタトゥー体験',
                '大道芸人のパフォーマンス（蛇使い、音楽、語り部）',
                '夜の屋台グルメ（タジン、ケバブ、ハリラスープ）',
                '周辺スークでの買い物体験'
            ],
            'how_to_enjoy': {
                '昼間（10:00-16:00）': 'オレンジジュースを飲みながら広場の雰囲気を楽しむ、周辺スークでお土産探し',
                '夕方（16:00-19:00）': '夕日に染まる広場の美しさを堪能、屋台の準備風景を観察',
                '夜（19:00-23:00）': '本格的な屋台グルメと大道芸のメインタイム、現地の人々との交流'
            },
            'access_notes': {
                'アクセス': 'マラケシュ新市街から徒歩15分、タクシー利用可（20-30DH）',
                '注意点': '貴重品管理注意、しつこい客引きは丁寧に断る、屋台の値段交渉が必要',
                '服装': '歩きやすい靴推奨、夜は少し冷えるので羽織り物があると良い'
            },
            'verified': True,
            'lat': 31.625964,
            'lng': -7.989250,
            'best_time': '夕方〜夜',
            'duration': '2-3時間',
            'price_range': '無料（飲食・買い物は別）'
        },
        {
            'id': 2,
            'name': 'クトゥビア・モスク',
            'city': 'マラケシュ',
            'category': '宗教建築',
            'summary': 'マラケシュの象徴的ランドマーク、12世紀に建造された高さ77mの美しいミナレットを持つ歴史的モスク',
            'features': {
                '景観': '赤砂岩造りの荘厳なミナレット、街のどこからでも見える圧倒的な存在感',
                '歴史': '1150年頃アルモハード朝により建造、モロッコ・イスラム建築の最高傑作',
                '文化': '5回の礼拝時間に響く美しいアザーン（祈りの呼びかけ）'
            },
            'highlights': [
                '高さ77mの美しいミナレット',
                'ジャマ・エル・フナ広場からの絶景ビュー',
                '夜間の幻想的なライトアップ',
                '伝統的なイスラム建築様式の観察',
                '周辺の美しい庭園散策'
            ],
            'how_to_enjoy': {
                '日中（10:00-16:00）': '建築美を詳細に観察、周辺庭園でのんびり過ごす',
                '夕方（16:00-18:00）': '夕日に映える赤砂岩の美しさを堪能',
                '夜間（19:00-22:00）': 'ライトアップされたミナレットの撮影、広場からの眺望'
            },
            'access_notes': {
                'アクセス': 'ジャマ・エル・フナ広場から徒歩5分',
                '注意点': '非イスラム教徒は内部立入禁止、外観観賞のみ',
                '撮影': '外観の撮影は可能、respectful な態度で'
            },
            'verified': True,
            'lat': 31.624307,
            'lng': -7.993252,
            'best_time': '夕方〜夜（ライトアップ）',
            'duration': '30分〜1時間',
            'price_range': '無料（外観のみ）'
        },
        {
            'id': 3,
            'name': 'バイア宮殿',
            'city': 'マラケシュ',
            'category': '歴史建築',
            'summary': '19世紀の大臣が建てた「美しい」宮殿、精巧なタイル装飾と160の部屋を持つモロッコ建築の傑作',
            'features': {
                '景観': '8ヘクタールの庭園と中央中庭、大理石の床と美しい噴水',
                '歴史': '1880年代、アフメド・イブン・ムーサ大臣が14年かけて建設',
                '文化': 'モロッコ・アンダルシア建築様式、ゼリージュ（モザイクタイル）技術の最高峰'
            },
            'highlights': [
                '精巧なゼリージュ（モザイクタイル）装飾',
                '彫刻された石膏装飾とアラベスク模様',
                '色とりどりの天井画と幾何学文様',
                '中央中庭の大理石床と噴水',
                '8ヘクタールの美しい庭園散策'
            ],
            'how_to_enjoy': {
                '入館時（9:00-10:00）': '朝の光が差し込む中庭の美しさを堪能',
                '見学中（10:00-11:00）': '各部屋の装飾技法を詳細に観察、写真撮影',
                '庭園散策（11:00-12:00）': '宮殿を囲む庭園でリラックス、建築美を振り返る'
            },
            'access_notes': {
                'アクセス': 'ジャマ・エル・フナ広場から徒歩15分、またはタクシー',
                '営業時間': '9:00-17:00（金曜日は14:30-15:30休憩）',
                '注意点': '内部撮影可能だが一部制限あり、入場券は現地購入のみ'
            },
            'verified': True,
            'lat': 31.620947,
            'lng': -7.982908,
            'best_time': '午前中（光の入り方が美しい）',
            'duration': '1-2時間',
            'price_range': '70DH（約800円）'
        },
        {
            'id': 4,
            'name': 'マジョレル庭園',
            'city': 'マラケシュ',
            'category': '庭園',
            'summary': 'イヴ・サンローランが愛した「マジョレル・ブルー」の植物園、300種の植物とベルベル博物館を持つ芸術的オアシス',
            'features': {
                '景観': '鮮やかなコバルトブルーの建物、世界中から集めた300種以上の植物、砂漠都市のオアシス',
                '歴史': '1924年フランス人画家ジャック・マジョレルが造成、1980年イヴ・サンローランが買取・復元',
                '文化': 'モロッコの植物文化とフランス芸術の融合、ベルベル文化の展示'
            },
            'highlights': [
                '「マジョレル・ブルー」のコバルトブルー建物',
                '300種以上の世界の植物（サボテン、椰子、バンブー）',
                'ベルベル博物館の伝統工芸品コレクション',
                'イヴ・サンローラン博物館（隣接）',
                '四季折々の美しい花々と庭園散策'
            ],
            'how_to_enjoy': {
                '早朝（8:00-10:00）': '涼しい時間帯に静かな庭園散策、写真撮影に最適な光',
                '午前中（10:00-12:00）': 'ベルベル博物館でモロッコ文化を学習、植物観察',
                '夕方（16:00-18:00）': '夕日に映える青い建物の美しさ、カフェでリラックス'
            },
            'access_notes': {
                'アクセス': '新市街ゲリーズ地区、マラケシュ中心部からタクシー15分',
                '営業時間': '8:00-18:00（10月-4月は17:30まで）',
                '注意点': '人気スポットのため混雑、朝一番の訪問がおすすめ'
            },
            'verified': True,
            'lat': 31.641214,
            'lng': -8.003674,
            'best_time': '早朝または夕方',
            'duration': '1-2時間',
            'price_range': '庭園150DH、博物館込み300DH'
        },
        {
            'id': 5,
            'name': 'サーディアン朝の墳墓群',
            'city': 'マラケシュ',
            'category': '歴史建築',
            'summary': '16世紀のサーディアン王朝の霊廟群、300年間封印されていた「12の柱の間」を持つイスラム装飾芸術の傑作',
            'features': {
                '景観': '白大理石の柱と鍾乳石装飾の天井、色とりどりのゼリージュタイル',
                '歴史': '1557年建設、1917年まで300年間城壁に封印、フランス統治時代に再発見',
                '文化': 'サーディアン朝の権力と富の象徴、イスラム建築・装飾技術の最高峰'
            },
            'highlights': [
                '「12の柱の間」の白大理石柱とムカルナス天井',
                '精巧なゼリージュ（モザイクタイル）装飾',
                'アラベスク文様の石膏彫刻と大理石象嵌',
                'アーマド・アル・マンスール王の豪華な石棺',
                '美しい中庭と庭園の散策'
            ],
            'how_to_enjoy': {
                '入場時（9:00-10:00）': '朝の静寂な霊廟で荘厳な雰囲気を体感',
                '見学中（10:00-11:00）': '各霊廟の装飾技法を詳細に観察、写真撮影',
                '退場前（11:00-12:00）': '庭園で建築美を振り返り、歴史に思いを馳せる'
            },
            'access_notes': {
                'アクセス': 'クトゥビア・モスクから徒歩10分、バイア宮殿から徒歩5分',
                '営業時間': '9:00-17:00',
                '注意点': '神聖な場所のため、respectful な態度で見学'
            },
            'verified': True,
            'lat': 31.621439,
            'lng': -7.984467,
            'best_time': '午前中',
            'duration': '45分〜1時間',
            'price_range': '70DH（約800円）'
        },
        {
            'id': 6,
            'name': 'メナラ庭園',
            'city': 'マラケシュ',
            'category': '庭園',
            'summary': '12世紀から続く王室庭園。アトラス山脈を映す人工湖とパビリオンが織りなす絵画のような風景で、夕日の美しさは格別です。',
            'features': {
                '景観': '人工湖に映るアトラス山脈、夕日に輝く湖面、約10万本のオリーブ畑',
                '歴史': '12世紀アルモハード朝の灌漑システム、サアード朝時代のパビリオン改築',
                '文化': 'モロッコ古典庭園の傑作、農業技術と美学の融合、王室の避暑地'
            },
            'highlights': [
                'アトラス山脈を背景にした湖面の反射美',
                '19世紀建造の美しいパビリオンとその内部装飾',
                '夕日時間帯の湖面が金色に染まる絶景',
                '10万本のオリーブの木が作り出す銀緑の風景',
                '古代から続く巧妙な水利システムの見学'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '湖畔散歩、オリーブ畑見学、パビリオン内部見学',
                '昼間（11:00-16:00）': 'ピクニック、読書、庭園でのんびり',
                '夕方（16:00-19:00）': '夕日鑑賞、アトラス山脈の撮影、ロマンチックなひととき'
            },
            'access_notes': 'マラケシュ市内からタクシーで15分（50DH）。徒歩は1時間程度。日陰が少ないため帽子・日焼け止め必須。夕方は特に美しいが混雑するため早めの到着推奨。',
            'verified': True,
            'lat': 31.605000,
            'lng': -8.024444,
            'best_time': '夕方（サンセット）',
            'duration': '1-2時間',
            'price_range': '30DH（約350円）'
        },
        {
            'id': 7,
            'name': 'ベン・ユーセフ・マドラサ',
            'city': 'マラケシュ',
            'category': '歴史建築',
            'summary': '14世紀マリーン朝が建設したマグリブ地域最大の神学校。900人の学生が学んだ教育の聖地で、精緻な装飾美術の傑作。',
            'features': {
                '建築': '中央中庭を囲むアーケード、130の学生寮、3階建ての壮大な構造',
                '装飾': '大理石とゼリージュの柱廊、杉材の精巧な天井、アラビア書道の石膏細工',
                '歴史': '14-16世紀の教育センター、イスラム学術の中心地、マリーン朝建築の最高傑作'
            },
            'highlights': [
                '中央中庭の息を呑む美しい装飾柱廊',
                '130の小さな学生寮と生活空間の再現',
                '幾何学模様とアラビア書道が施された壁面装飾',
                '杉材で作られた精巧な天井の木工細工',
                '当時の学生生活と教育システムの展示'
            ],
            'how_to_enjoy': {
                '入場（30分）': '音声ガイドで歴史を学び、建築美を鑑賞',
                '中庭散策（20分）': '装飾の詳細を観察、写真撮影',
                '学生寮見学（15分）': '当時の学生生活を想像しながら小部屋を見学'
            },
            'access_notes': 'ジャマ・エル・フナ広場から徒歩10分。スーク散策と合わせて訪問がおすすめ。午前中は光が差し込み撮影に最適。フラッシュ撮影禁止。',
            'verified': True,
            'lat': 31.631667,
            'lng': -7.989167,
            'best_time': '午前中（10:00-12:00）',
            'duration': '1-1.5時間',
            'price_range': '50DH（約570円）'
        },
        {
            'id': 8,
            'name': 'アグダル庭園',
            'city': 'マラケシュ',
            'category': '庭園',
            'summary': '12世紀から続く400ヘクタールの王室庭園。現在も機能する古代水利システムと果樹園が織りなす農業遺産の傑作。',
            'features': {
                '規模': '400ヘクタールの広大な敷地、東京ドーム85個分の巨大庭園',
                '農業': 'オリーブ、オレンジ、ザクロ、イチジク、アーモンドの果樹園',
                '水利': '800年前の灌漑システム、2つの大型貯水池、現役の給水機能'
            },
            'highlights': [
                '12世紀から変わらない古代灌漑システムの驚異',
                '季節ごとに実る豊富な果樹（オレンジ、ザクロ、イチジク）',
                '王室の離宮として使用される歴史的建造物',
                '400ヘクタールの圧倒的なスケールの自然景観',
                'アトラス山脈を背景にした絵画のような風景'
            ],
            'how_to_enjoy': {
                '入園（15分）': '王室庭園の歴史解説を聞き、全体map確認',
                '果樹園散策（60分）': '季節の果樹観察、古代灌漑システム見学',
                '貯水池エリア（30分）': '水利技術の見学、景観撮影'
            },
            'access_notes': '金・土曜日のみ開園（週2日限定）。マラケシュ中心部からタクシー20分。広大なため歩きやすい靴必須。日陰少なく帽子・水分持参推奨。',
            'verified': True,
            'lat': 31.609722,
            'lng': -7.965556,
            'best_time': '金・土曜日の午前中（9:00-12:00）',
            'duration': '1.5-2.5時間',
            'price_range': '10DH（約115円）'
        },
        # カサブランカの観光地（12箇所）
        {
            'id': 9,
            'name': 'ハッサン2世モスク',
            'city': 'カサブランカ',
            'category': '宗教建築',
            'summary': '世界第3位の規模を誇る海に浮かぶモスク、高さ210mのミナレットとガラス床を持つ現代イスラム建築の傑作',
            'features': {
                '景観': '大西洋に面した圧巻の立地、世界最高210mのミナレット、10万人収容の巨大空間',
                '歴史': '1993年完成、ハッサン2世国王の命により7年かけて建設、モロッコの国家プロジェクト',
                '文化': '伝統と現代の融合、モロッコの職人技術と最新テクノロジーの結晶'
            },
            'highlights': [
                '世界最高210mのミナレット（レーザー光でメッカ方向を指示）',
                'ガラス床から大西洋を見下ろす唯一無二の体験',
                '25,000平方mの巨大礼拝堂と精巧な装飾',
                'モロッコ全土から集められた最高級素材',
                '屋外広場から望む大西洋の絶景'
            ],
            'how_to_enjoy': {
                'ガイドツアー（9:00-10:00）': '内部見学で建築技術と装飾の詳細を学習',
                '自由見学（10:00-11:00）': 'ガラス床体験、ミナレット展望、写真撮影',
                '海岸散策（11:00-12:00）': '外観を海側から眺める、周辺コルニッシュ散歩'
            },
            'access_notes': {
                'アクセス': 'カサブランカ市街地からタクシー20分、トラム利用可',
                'ツアー時間': '金曜以外9:00,10:00,11:00,14:00開始',
                '注意点': '非ムスリムはガイドツアーのみ入場可、適切な服装必須'
            },
            'verified': True,
            'lat': 33.608311,
            'lng': -7.632815,
            'best_time': '午前中（ガイドツアー）',
            'duration': '1-2時間',
            'price_range': 'ツアー130DH（約1500円）'
        },
        {
            'id': 10,
            'name': 'リック・カフェ',
            'city': 'カサブランカ',
            'category': '文化施設',
            'summary': '映画「カサブランカ」の世界を完璧再現した伝説のカフェ・レストラン。「君の瞳に乾杯」の舞台で映画ファン必見の聖地。',
            'features': {
                '映画再現': '1940年代の内装完全再現、映画小道具、アンティーク家具配置',
                '雰囲気': '毎夜のピアノ演奏、薄暗い照明、ノスタルジックな音楽',
                '料理': 'モロッコ・フランス融合料理、名物タジン、厳選ワインセレクション'
            },
            'highlights': [
                '映画「カサブランカ」の名シーン再現スポット',
                '毎夜演奏される「時の過ぎゆくままに」ピアノライブ',
                '映画ポスターとアンティーク家具で彩られた1940年代内装',
                '「君の瞳に乾杯」を実際に体験できる特別な瞬間',
                'ハンフリー・ボガートとイングリッド・バーグマンの写真展示'
            ],
            'how_to_enjoy': {
                'アペリティフ（18:00-19:00）': '映画の世界観に浸りながらカクテルタイム',
                'ディナー（19:00-21:00）': '本格モロッコ・フランス料理を映画音楽と共に',
                'ピアノタイム（21:00-22:00）': '生演奏を聞きながら映画の名シーンを回想'
            },
            'access_notes': 'カサブランカ旧市街内、ハッサン2世モスクから徒歩15分。要予約（特に夕食時）。ドレスコード：スマートカジュアル。',
            'verified': True,
            'lat': 33.594629,
            'lng': -7.619054,
            'best_time': '夕方〜夜（18:00-22:00）',
            'duration': '2-3時間',
            'price_range': 'ディナー300-500DH（約3500-5800円）'
        },
        {
            'id': 11,
            'name': 'カサブランカ旧市街（メディナ）',
            'city': 'カサブランカ',
            'category': '都市・建築',
            'description': '18世紀に建設されたカサブランカの旧市街。白い家々が立ち並ぶ小さな迷路のような街並みは、大都市カサブランカの中にある静かなオアシスです。伝統的なモロッコ建築、小さなモスク、地元の工芸品店、昔ながらのハマム（公衆浴場）などが点在し、現代都市の喧騒を忘れさせてくれます。特に朝の散歩がおすすめで、地元の人々の日常生活を垣間見ることができます。',
            'verified': True,
            'lat': 33.598056,
            'lng': -7.611944,
            'best_time': '午前中',
            'duration': '1-2時間',
            'price_range': '無料'
        },
        {
            'id': 12,
            'name': 'モハメッド5世広場',
            'city': 'カサブランカ',
            'category': '広場・市場',
            'summary': 'フランス保護領時代の都市計画が生んだカサブランカの行政中枢。政府建物に囲まれた格調高い広場で夜のライトアップが美しい。',
            'features': {
                '建築': 'フランス植民地時代の都市計画、新古典主義建築、対称的な広場設計',
                '政治': 'モロッコの行政中心地、重要政府機関の集積地、国家行事の舞台',
                '文化': '中央郵便局の美しい建築、ムーレイ・ユーセフ・モスクとの調和'
            },
            'highlights': [
                '夜間のライトアップされた美しい中央噴水',
                'フランス植民地時代の新古典主義建築群',
                '重要な政府建物（裁判所、中央郵便局）の外観',
                'ムーレイ・ユーセフ・モスクとの宗教・世俗の調和',
                'カサブランカの都市計画の傑作としての景観'
            ],
            'how_to_enjoy': {
                '昼間（10:00-16:00）': '政府建築の外観見学、中央郵便局訪問、都市計画の美しさを鑑賞',
                '夕方（16:00-19:00）': '広場でのカフェタイム、地元のビジネスマンの往来観察',
                '夜間（19:00-22:00）': 'ライトアップされた噴水と建物群の夜景撮影'
            },
            'access_notes': 'カサブランカ中央駅から徒歩10分。周辺に多数のカフェ・レストラン。平日は政府関係者で混雑。夜景撮影は20:00以降がおすすめ。',
            'verified': True,
            'lat': 33.596944,
            'lng': -7.622222,
            'best_time': '夕方〜夜',
            'duration': '30分〜1時間',
            'price_range': '無料'
        },
        {
            'id': 13,
            'name': 'ノートルダム・ド・ルルド教会',
            'city': 'カサブランカ',
            'category': '宗教建築',
            'summary': 'モロッコ最大都市に建つ美しいカトリック教会。イスラム国家における宗教的多様性と寛容さを象徴する現代建築の傑作。',
            'features': {
                '建築': 'モダン建築とモロッコ伝統要素の融合、独特の現代的デザイン、機能的な美しさ',
                '宗教': 'イスラム国家でのカトリック信仰、宗教的寛容性、フランス植民地の遺産',
                '芸術': '美しいステンドグラス、現代的祭壇デザイン、静寂な祈りの空間'
            },
            'highlights': [
                '色とりどりの美しいステンドグラスアート',
                'モダン建築とモロッコ様式の絶妙な融合',
                'イスラム国家での宗教的多様性を体現する空間',
                '毎日行われるミサと国際的な信者コミュニティ',
                '静寂で神聖な祈りの雰囲気と建築美'
            ],
            'how_to_enjoy': {
                '見学（20分）': '建築デザインの鑑賞、ステンドグラス観察',
                'ミサ参加（60分）': '宗教体験、多文化コミュニティとの交流（日曜8:00/10:00）',
                '静寂タイム（15分）': '祈りと瞑想、心の平安を得る時間'
            },
            'access_notes': 'カサブランカ中心部、モハメッド5世広場から徒歩15分。ミサ時間：平日7:00、日曜8:00/10:00。適切な服装で入場。写真撮影は許可制。',
            'verified': True,
            'lat': 33.589722,
            'lng': -7.623889,
            'best_time': '午前中（9:00-11:00）',
            'duration': '30-60分',
            'price_range': '無料（寄付歓迎）'
        },
        {
            'id': 14,
            'name': 'カサブランカ・ツインセンター',
            'city': 'カサブランカ',
            'category': '現代建築',
            'summary': 'モロッコ最高層115メートルの双子タワー。現代モロッコの経済発展を象徴し、市街と大西洋の絶景展望台を持つランドマーク。',
            'features': {
                '建築': '2つの28階建てタワー、モロッコ最高層115メートル、現代建築の傑作',
                '機能': 'ショッピングモール、国際オフィス、5つ星ホテル、展望デッキ',
                '象徴': '現代モロッコの経済発展、アフリカのビジネスハブ、国際都市の証'
            },
            'highlights': [
                '展望デッキからのカサブランカ市街360度パノラマ',
                '大西洋の水平線まで見渡せる絶景ビュー',
                '夜間の美しいライトアップとイルミネーション',
                'モロッコ最大級のショッピングモール体験',
                '高層階からのハッサン2世モスクの俯瞰'
            ],
            'how_to_enjoy': {
                'ショッピング（2時間）': '高級ブランドショップ、国際的なフードコート体験',
                '展望デッキ（30分）': '市街パノラマ、大西洋絶景、写真撮影',
                '夜景鑑賞（1時間）': 'ライトアップされたカサブランカの夜景を堪能'
            },
            'access_notes': 'カサブランカ市街中心部、タクシーで主要ホテルから10分。展望デッキは天候により閉鎖の場合あり。ショッピングモールは10:00-22:00営業。',
            'verified': True,
            'lat': 33.588889,
            'lng': -7.630556,
            'best_time': '夕方（16:00-19:00）展望デッキ',
            'duration': '1-3時間',
            'price_range': '展望デッキ50DH（約580円）'
        },
        {
            'id': 15,
            'name': 'ムーレイ・ユーセフ・モスク',
            'city': 'カサブランカ',
            'category': '宗教建築',
            'summary': 'カサブランカ最古級のモスクで、伝統的モロッコ・アンダルシア建築の美しい代表例。モハメッド5世広場の重要なランドマーク。',
            'features': {
                '建築': '伝統的モロッコ・アンダルシア様式、白い壁と緑のタイル装飾、優雅なミナレット',
                '歴史': '20世紀初頭創建、フランス保護領時代の改築、カサブランカの宗教的発展',
                '文化': '日常的な礼拝の場、金曜日の集団礼拝、地域イスラム共同体の中心'
            },
            'highlights': [
                '伝統的モロッコ・アンダルシア建築の美しい外観',
                '白い壁面に映える緑のゼリージュ（モザイクタイル）',
                'シンプルで優雅なミナレットのデザイン',
                'モハメッド5世広場との調和した都市景観',
                '金曜日の集団礼拝時の信者たちの様子'
            ],
            'how_to_enjoy': {
                '外観鑑賞（15分）': '建築美の観察、写真撮影（適切な距離から）',
                '周辺散策（30分）': '旧市街との組み合わせ散策、カフェでの休憩',
                '文化観察（15分）': '礼拝時間の信者の様子を見学（敬意を持って）'
            },
            'access_notes': 'モハメッド5世広場から徒歩2分。非ムスリムは外観見学のみ。礼拝時間は騒音を避ける。写真撮影は建物に敬意を払って適切な距離から。',
            'verified': True,
            'lat': 33.598333,
            'lng': -7.620833,
            'best_time': '午前中（10:00-12:00）',
            'duration': '30分（外観見学）',
            'price_range': '無料'
        },
        # フェズの観光地（10箇所）
        {
            'id': 16,
            'name': 'フェズ・エル・バリ',
            'city': 'フェズ',
            'category': '都市・建築',
            'summary': '世界最大の車両進入禁止都市、ユネスコ世界遺産。1200年続く迷宮都市で28万人が暮らす生きた中世都市の奇跡。',
            'features': {
                '都市構造': '9000本の路地が網目状、世界最大の歩行者専用都市、幅1メートルの迷路',
                '文化遺産': '1200年続く伝統工芸、革なめし・金属細工・陶器作りの職人街',
                '生活': '28万人の住民、生きた歴史都市、中世から変わらぬ日常生活'
            },
            'highlights': [
                '世界最大の車両進入禁止歴史都市の散策',
                '1200年前から変わらない迷宮のような路地構造',
                '現役で稼働する伝統工芸の職人街見学',
                '中世イスラム都市の完璧に保存された街並み',
                '28万人が暮らす生きた歴史都市の日常風景'
            ],
            'how_to_enjoy': {
                '午前（9:00-12:00）': 'ガイド付き迷宮探索、主要モスクと学校見学',
                '昼（12:00-15:00）': '職人街見学、伝統工芸体験、スーク散策',
                '午後（15:00-18:00）': '住宅地散策、地元生活観察、カフェ休憩'
            },
            'access_notes': '徒歩でのみアクセス可能。迷子防止のため公認ガイド推奨（300-500DH）。狭い路地で道に迷いやすい。貴重品管理注意。',
            'verified': True,
            'lat': 34.063611,
            'lng': -4.972222,
            'best_time': '午前中（9:00-12:00）涼しい時間帯',
            'duration': '半日〜1日',
            'price_range': 'ガイド300-500DH（約3500-5800円）'
        },
        {
            'id': 17,
            'name': 'カラウィーン大学・モスク',
            'city': 'フェズ',
            'category': '歴史建築',
            'description': '859年にファーティマ・アル・フィフリーヤによって創設された世界最古の大学の一つ。ギネスブックにも認定されているこの学府は、1200年以上にわたって学問の中心地として機能し続けています。図書館には40万冊以上の写本があり、その中にはイブン・ルシュド（アヴェロエス）やマイモニデスの貴重な著作も含まれています。現在も8000人以上の学生が学ぶ現役の宗教教育機関で、イスラム世界の知的遺産の宝庫です。',
            'verified': True,
            'lat': 34.064444,
            'lng': -4.974167,
            'best_time': '午前中',
            'duration': '1時間（外観・中庭）',
            'price_range': '無料（ムスリム以外は中庭まで）'
        },
        {
            'id': 18,
            'name': 'シュワラ皮なめし場',
            'city': 'フェズ',
            'category': '伝統工芸',
            'description': '11世紀から続く世界最大かつ最古の皮なめし工場。数百の石製の染色槽が並ぶ光景は圧巻で、職人たちが素足で槽に入り、1000年変わらない伝統技法で革をなめしています。鳩の糞、石灰、塩、各種植物染料を使用する天然製法で作られるフェズレザーは世界的に有名。ミントを鼻に当てながら見学する独特の体験は、フェズでしかできない貴重なものです。周辺の革製品店での買い物も楽しめます。',
            'verified': True,
            'lat': 34.066667,
            'lng': -4.971389,
            'best_time': '午前中（暑さを避ける）',
            'duration': '1時間',
            'price_range': '見学無料（チップあり）'
        },
        {
            'id': 19,
            'name': 'ボウ・イナニア・マドラサ',
            'city': 'フェズ',
            'category': '歴史建築',
            'description': '1356年にマリーン朝のスルタン・アブー・イナーンによって建設された神学校。マリーン朝建築の最高傑作とされ、精緻な装飾技術の粋を集めた建物です。入口の青銅製の扉、中庭の大理石の柱、壁面を覆う幾何学模様のゼリージュ、アラベスク文様の石膏彫刻、そして天井の杉材の装飾など、あらゆる装飾要素が完璧に調和しています。現在も祈りの場として使用されている生きた遺産です。',
            'verified': True,
            'lat': 34.065556,
            'lng': -4.973333,
            'best_time': '午前中',
            'duration': '45分〜1時間',
            'price_range': '20DH（約230円）'
        },
        {
            'id': 20,
            'name': 'ダール・バタ博物館',
            'city': 'フェズ',
            'category': '博物館',
            'description': '19世紀の宮殿を改装したモロッコ工芸美術博物館。フェズの伝統工芸品の宝庫で、精巧な木工細工、金属工芸、陶器、絨毯、刺繍、書道作品などが展示されています。特に有名なのは青と白の美しいフェズ陶器のコレクション。建物自体も美しく、中庭の噴水と庭園、装飾タイル、彫刻された石膏など、アンダルシア建築の傑作です。フェズの文化遺産を包括的に理解できる重要な施設です。',
            'verified': True,
            'lat': 34.062778,
            'lng': -4.976389,
            'best_time': '午前中',
            'duration': '1-2時間',
            'price_range': '20DH（約230円）'
        },
        {
            'id': 21,
            'name': 'メリニード朝の墳墓群',
            'city': 'フェズ',
            'category': '歴史建築',
            'description': 'フェズを見下ろす丘の上にある14世紀マリーン朝の王族墓地。廃墟となった霊廟群ですが、フェズ・エル・バリの全景を一望できる絶景スポットとして人気です。特に夕日の時間帯は、旧市街の無数のミナレットや赤い屋根瓦が夕日に染まり、1000年の歴史を持つ古都の美しさを実感できます。写真撮影の名所でもあり、多くの観光客が訪れる定番スポットです。',
            'verified': True,
            'lat': 34.072222,
            'lng': -4.970000,
            'best_time': '夕方（サンセット）',
            'duration': '1時間',
            'price_range': '無料'
        },
        {
            'id': 22,
            'name': 'アッタリーン・マドラサ',
            'city': 'フェズ',
            'category': '歴史建築',
            'description': '1325年にマリーン朝によって建設された小さいながらも最も美しい神学校の一つ。「香辛料商のマドラサ」という意味の名前が示すように、スパイス市場に隣接しています。3階建ての建物は中庭を囲むように設計され、学生寮の小部屋が並んでいます。装飾の密度と質の高さは驚異的で、特に中庭の柱廊のタイルワークと石膏装飾は必見。小規模だからこそ、細部まで行き届いた職人技の素晴らしさを堪能できます。',
            'verified': True,
            'lat': 34.064722,
            'lng': -4.974722,
            'best_time': '午前中',
            'duration': '30分〜45分',
            'price_range': '20DH（約230円）'
        },
        # メルズーガとサハラ砂漠の観光地（6箇所）
        {
            'id': 23,
            'name': 'エルグ・シェビ砂丘',
            'city': 'メルズーガ',
            'category': '自然',
            'summary': 'モロッコで最も美しいサハラ砂漠の砂丘群。高さ150mの金色の砂丘が連なる、砂漠体験の聖地として知られています。',
            'features': {
                '景観': '金色の砂丘群、360度の砂漠パノラマ、満天の星空',
                '自然': '高さ150mの砂丘、サハラ砂漠の中心部、砂の色彩変化',
                '体験': 'ラクダトレッキング、砂漠キャンプ、ベルベル音楽鑑賞'
            },
            'highlights': [
                '金色からオレンジ、赤、紫へと変化する砂丘の色彩',
                '砂丘頂上からの360度砂漠パノラマビュー',
                '満天の星空の下でのベルベル音楽体験',
                'ラクダに乗って砂丘を登る伝統的な砂漠体験'
            ],
            'how_to_enjoy': {
                '日の出前（5:30-6:30）': '砂丘登頂、日の出の色彩変化観賞',
                '午前（7:00-11:00）': 'ラクダトレッキング、砂漠散策',
                '日中（11:00-17:00）': '砂漠キャンプ休憩、ベルベル文化体験',
                '夕方（17:00-19:00）': '日没観賞、砂丘の色彩変化',
                '夜間（19:00-翌朝）': 'キャンプファイヤー、星空観察、ベルベル音楽'
            },
            'access_notes': '- メルズーガから4WDまたはラクダでアクセス\n- 砂漠ツアーは1-2日のキャンプが一般的\n- 日の出・日没時間の確認が重要\n- 砂漠用の服装と日焼け止めが必須',
            'description': 'モロッコで最も美しい砂丘群の一つ。高さ150メートルの金色の砂丘が連なるこの地域は、サハラ砂漠体験の聖地です。ラクダトレッキングで砂丘の頂上に登れば、360度の砂漠パノラマが広がります。日の出と日没時の色彩変化は息をのむ美しさで、砂丘が金色からオレンジ、赤、紫へと変化する様子は一生の思い出になります。砂漠キャンプでは満天の星空の下でベルベル音楽を楽しめます。',
            'verified': True,
            'lat': 31.099167,
            'lng': -4.010556,
            'best_time': '日の出・日没',
            'duration': '1-2日（キャンプ含む）',
            'price_range': 'ツアー500-1500DH'
        },
        {
            'id': 24,
            'name': 'ハッシ・ラブド砂丘',
            'city': 'メルズーガ',
            'category': '自然',
            'summary': 'エルグ・シェビの北に位置する静寂な砂丘エリア。観光客が少なく、手つかずのサハラ砂漠と化石発見地として知られています。',
            'features': {
                '景観': '360度砂丘パノラマ、手つかずの砂漠風景、静寂な環境',
                '自然': '化石発見地、三葉虫化石、原始的な砂漠環境',
                '体験': 'サンドボード、クワッドバイク、化石探し'
            },
            'highlights': [
                '観光客が少ない静寂なサハラ砂漠体験',
                '三葉虫の化石が発見される地質学的価値',
                '360度砂丘に囲まれた壮大な環境',
                'サンドボードで砂丘を滑り降りる爽快感'
            ],
            'how_to_enjoy': {
                '午前（9:00-12:00）': '4WDでアクセス、砂丘散策',
                '昼（12:00-14:00）': '化石探し、地質観察',
                '午後（14:00-16:00）': 'サンドボード、クワッドバイク',
                '夕方（16:00-18:00）': '砂丘登頂、夕日観賞',
                '夜間': '星空観察（キャンプ宿泊の場合）'
            },
            'access_notes': '- 4WDまたはクワッドバイクでのアクセスが必要\n- エルグ・シェビより観光客が少ない穴場\n- 化石は持ち帰り禁止\n- 砂漠用装備と水分補給が重要',
            'description': 'エルグ・シェビの北に位置する静寂な砂丘エリア。観光客が少なく、より手つかずのサハラ砂漠を体験できます。化石の発見地としても知られ、三葉虫の化石が多数発見されています。360度砂丘に囲まれた環境で、砂漠の静寂と壮大さを純粋に感じることができる隠れた名所。サンドボードやクワッドバイクのアクティビティも楽しめます。',
            'verified': True,
            'lat': 31.094167,
            'lng': -4.045556,
            'best_time': '午後〜夕方',
            'duration': '半日',
            'price_range': 'ツアー300-600DH'
        },
        # シャウエンの観光地（8箇所）
        {
            'id': 25,
            'name': 'シャウエン旧市街（メディナ）',
            'city': 'シャウエン',
            'category': '都市・建築',
            'summary': '「青い真珠」と称される山間の美しい街、青く塗られた家々が織りなすおとぎ話のような旧市街',
            'features': {
                '景観': '様々な青色に塗られた家々、迷路のような石畳の小径、花で飾られたバルコニー',
                '歴史': '1471年アンダルシアからのムーア人が建設、レコンキスタ後の避難地',
                '文化': 'アンダルシア・ムーア建築様式、ベルベル文化とイスラム文化の融合'
            },
            'highlights': [
                '様々な青色のトーンで塗られた壁面',
                '石畳の迷路のような細い路地',
                '青いドアと窓枠の美しいコントラスト',
                '伝統工芸品の工房とお土産屋',
                '屋上テラスからのリフ山脈の眺望'
            ],
            'how_to_enjoy': {
                '午前中（8:00-12:00）': '美しい朝の光に映える青い街並み散策、写真撮影',
                '昼間（12:00-16:00）': '工房見学、伝統工芸品ショッピング、カフェで休憩',
                '夕方（16:00-19:00）': '夕日に染まる青い街の幻想的な美しさを堪能'
            },
            'access_notes': {
                'アクセス': 'フェズから車で約4時間、タンジェから約2時間半',
                '散策コツ': '迷路のような路地、目印を覚えながら歩くこと',
                '注意点': '観光客向け価格に注意、値段交渉を忘れずに'
            },
            'verified': True,
            'lat': 35.168889,
            'lng': -5.268333,
            'best_time': '午前中（光の加減が美しい）',
            'duration': '半日〜1日',
            'price_range': '散策無料'
        },
        {
            'id': 26,
            'name': 'ウタ・エル・ハマム広場',
            'city': 'シャウエン',
            'category': '広場・市場',
            'summary': 'シャウエンの心臓部となる中央広場。青い街並みを背景にした写真撮影の聖地で、地元の人々との交流の場。',
            'features': {
                '景観': '周囲を青い建物に囲まれた石畳広場、中央の美しい噴水、赤茶色カスバとの色彩対比',
                '文化': '地元民の社交の場、伝統的な茶文化、山間の町ののどかな生活',
                '撮影': 'シャウエンで最も写真映えするスポット、青い街並みの絶好の背景'
            },
            'highlights': [
                '中央噴水と青い街並みの完璧な構図',  
                '夕方の地元民の茶飲み社交風景',
                'カスバの赤茶色と街の青色の美しいコントラスト',
                '周囲のカフェテラスから広場を見下ろす眺望',
                'モロッコ山間部の伝統的な広場文化の体験'
            ],
            'how_to_enjoy': {
                '午前（9:00-12:00）': '静かな広場で朝の光に映える青い街並み撮影',
                '昼（12:00-16:00）': 'カフェでミントティーを飲みながら人間観察',
                '夕方（16:00-19:00）': '地元の人々の社交を見学、夕日に染まる広場'
            },
            'access_notes': 'シャウエン旧市街の中心部、徒歩でのみアクセス可能。周囲にカフェ・レストラン多数。写真撮影時は地元の人への配慮を忘れずに。',
            'verified': True,
            'lat': 35.169444,
            'lng': -5.268056,
            'best_time': '夕方（16:00-18:00）',
            'duration': '1-2時間',
            'price_range': '無料（カフェ利用20-30DH）'
        },
        {
            'id': 27,
            'name': 'シャウエン・カスバ',
            'city': 'シャウエン',
            'category': '歴史建築',
            'summary': '15世紀に建設された要塞で、現在は博物館として機能。城壁からシャウエンの青い街並みとリフ山脈の絶景を一望できます。',
            'features': {
                '景観': '青い街並みの俯瞰、リフ山脈パノラマ、青い屋根瓦のコントラスト',
                '歴史': '15世紀の要塞建築、ベルベル文化の歴史展示',
                '文化': '地域博物館、伝統工芸品展示、文化遺産保存'
            },
            'highlights': [
                '屋上からの青い街全体のパノラマビュー',
                '15世紀の要塞建築と城壁',
                'ベルベル文化と地域史の展示',
                'リフ山脈の雄大な山岳風景',
                '青い屋根瓦と白い壁の美しいコントラスト'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '博物館見学、ベルベル文化について学習',
                '昼（11:00-13:00）': '城壁散策、歴史建築観察',
                '午後（13:00-16:00）': '屋上展望台、青い街並み撮影',
                '夕方（16:00-18:00）': '夕日に染まるリフ山脈観賞'
            },
            'access_notes': '- メディナ中心部から徒歩5分\n- 入場料10DH、カメラ撮影可\n- 屋上は風が強いため注意\n- 階段が多いため歩きやすい靴推奨',
            'description': '15世紀に建設された要塞で、現在は博物館として機能しています。城壁からはシャウエンの青い街並みとリフ山脈の絶景を一望できます。内部には地域の歴史、ベルベル文化、伝統工芸品が展示されており、この地域の豊かな文化遺産を学ぶことができます。特に屋上からのパノラマビューは圧巻で、青い屋根瓦と白い壁のコントラストが美しい町全体を見渡せます。',
            'verified': True,
            'lat': 35.169167,
            'lng': -5.268611,
            'best_time': '午後（展望のため）',
            'duration': '1時間',
            'price_range': '10DH（約115円）'
        },
        {
            'id': 28,
            'name': 'アケチャウル滝',
            'city': 'シャウエン',
            'category': '自然',
            'summary': 'シャウエンから徒歩45分のリフ山脈にある美しい滝。天然プールでの水遊びとハイキングが楽しめる自然スポットです。',
            'features': {
                '景観': 'リフ山脈の清流、滝壺の天然プール、緑豊かな山間風景',
                '自然': '水量豊富な滝、清涼な山の水、四季の自然変化',
                '体験': 'ハイキング、水遊び、自然観察、森林浴'
            },
            'highlights': [
                '春から初夏の水量豊富な迫力ある滝',
                '滝壺の天然プールでの水遊び',
                'リフ山脈の緑豊かなハイキングコース',
                '青い街とは対照的な自然環境',
                '地元の人々も利用する憩いの場'
            ],
            'how_to_enjoy': {
                '出発前（8:00-9:00）': 'ハイキング準備、水分・軽食持参',
                '道中（9:00-10:00）': '山間ハイキング、自然観察',
                '滞在（10:00-14:00）': '滝見学、水遊び、休憩',
                '帰路（14:00-15:00）': 'ハイキング、シャウエン帰還'
            },
            'access_notes': '- シャウエン中心部から徒歩約45分\n- ハイキングシューズと水着持参推奨\n- 春〜初夏が水量豊富でベスト\n- 冬場は水量少なく寒いため注意',
            'description': 'シャウエンの町から徒歩約45分の場所にある美しい滝。リフ山脈の清流が作り出すこの滝は、特に春から初夏にかけて水量が豊富で迫力があります。滝壺は天然のプールのようになっており、夏場は地元の人々が水遊びを楽しむ人気スポット。ハイキングコースとしても整備されており、山間の自然を満喫しながら滝までの道のりを楽しめます。青い街とは対照的な緑豊かな自然が魅力です。',
            'verified': True,
            'lat': 35.150000,
            'lng': -5.275000,
            'best_time': '春〜初夏',
            'duration': '半日（往復）',
            'price_range': '無料'
        },
        # エッサウィラの観光地（8箇所）
        {
            'id': 29,
            'name': 'エッサウィラ・メディナ',
            'city': 'エッサウィラ',
            'category': '都市・建築',
            'summary': '大西洋に面した「風の街」の要塞都市、ユネスコ世界遺産に登録されたヨーロッパ・アフリカ建築融合の傑作',
            'features': {
                '景観': '白い城壁に囲まれた旧市街、大西洋の青と建物の白のコントラスト',
                '歴史': '18世紀フランス人建築家テオドール・コルニュ設計、ポルトガル・フランス植民地遺産',
                '文化': 'ヨーロッパとアフリカ建築の融合、グナワ音楽の聖地、国際的アート都市'
            },
            'highlights': [
                'ユネスコ世界遺産の完璧に保存された要塞都市',
                '大西洋を望む白い城壁と青い海のコントラスト',
                'ポルトガル・フランス・モロッコ建築の融合美',
                'グナワ音楽祭の会場と音楽文化',
                'ウィンドサーフィン・カイトサーフィンの聖地'
            ],
            'how_to_enjoy': {
                '午前中（9:00-12:00）': '城壁散策と大西洋の絶景、旧市街の建築美を堪能',
                '昼間（12:00-16:00）': 'アートギャラリー巡り、グナワ音楽体験、海鮮ランチ',
                '夕方（16:00-19:00）': '漁港見学、夕日鑑賞、風の音を聞きながら散策'
            },
            'access_notes': {
                'アクセス': 'マラケシュから車で約3時間、カサブランカから約4時間',
                '特徴': '年中強い貿易風、ウォータースポーツ最適',
                '注意点': '風が強いため帽子や軽いものに注意'
            },
            'verified': True,
            'lat': 31.513056,
            'lng': -9.769444,
            'best_time': '午前中',
            'duration': '半日〜1日',
            'price_range': '散策無料'
        },
        {
            'id': 30,
            'name': 'スカラ・デュ・ポール',
            'city': 'エッサウィラ',
            'category': '歴史建築',
            'summary': '18世紀建設の海に面した要塞。ポルトガル様式の大砲が設置され、大西洋の絶景と映画撮影地として有名です。',
            'features': {
                '景観': '大西洋パノラマビュー、夕日の絶景、漁港の活気ある風景',
                '歴史': '18世紀ポルトガル様式要塞、古い大砲設置、海洋防衛史',
                '文化': '映画撮影地、海洋博物館、エッサウィラの歴史展示'
            },
            'highlights': [
                'ポルトガル様式の歴史的大砲と城壁',
                '大西洋に沈む美しい夕日のサンセットビュー',
                '映画「オセロ」「キングダム・オブ・ヘブン」撮影地',
                '要塞からの漁港と大西洋のパノラマ',
                '18世紀の海洋防衛建築の見学'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '要塞見学、大砲と城壁観察',
                '昼（11:00-14:00）': '海洋博物館、エッサウィラ史学習',
                '午後（14:00-17:00）': '大西洋展望、漁港観察',
                '夕方（17:00-19:00）': 'サンセット鑑賞、幻想的な要塞シルエット'
            },
            'access_notes': '- メディナから徒歩5分\n- 入場料10DH、夕日時間は混雑\n- 風が強いため防寒着推奨\n- カメラ撮影に最適な絶景スポット',
            'description': '18世紀に建設された海に面した要塞。ポルトガル様式の大砲が設置された城壁からは、大西洋の絶景と漁港の活気ある様子を一望できます。映画「オセロ」や「キングダム・オブ・ヘブン」の撮影地としても有名。夕日の時間帯は特に美しく、オレンジ色に染まる大西洋と要塞のシルエットが幻想的な雰囲気を作り出します。要塞内には小さな博物館もあり、エッサウィラの海洋史を学べます。',
            'verified': True,
            'lat': 31.511944,
            'lng': -9.771389,
            'best_time': '夕方（サンセット）',
            'duration': '1時間',
            'price_range': '10DH（約115円）'
        },
        {
            'id': 31,
            'name': 'エッサウィラ港',
            'city': 'エッサウィラ',
            'category': '港・市場',
            'summary': 'モロッコで最も絵になる漁港。青い漁船と活気ある魚市場で、新鮮な海の幸と漁師たちの生活を体験できます。',
            'features': {
                '景観': '青い漁船の並び、かもめが舞う港風景、大西洋の海岸線',
                '文化': '漁師の伝統的生活、魚市場の活気、海洋文化',
                'グルメ': '新鮮なイワシ、タコ、ウニ、カニ、港沿いシーフードレストラン'
            },
            'highlights': [
                '青い漁船が美しく並ぶ絵画的な港風景',
                '毎日の新鮮な魚介類の水揚げ作業',
                'かもめが舞い踊る活気ある魚市場',
                '港沿いレストランでの獲れたて海の幸',
                '映画のような漁師たちの働く姿'
            ],
            'how_to_enjoy': {
                '早朝（6:00-8:00）': '魚の水揚げ作業見学、漁師の活動観察',
                '午前（8:00-11:00）': '魚市場散策、新鮮な魚介類の見学',
                '昼（11:00-14:00）': '港沿いレストランでシーフードランチ',
                '午後（14:00-17:00）': '港の散策、青い漁船の写真撮影'
            },
            'access_notes': '- メディナから徒歩3分\n- 早朝の水揚げ時間が最も活気がある\n- 魚市場は新鮮な魚介類の購入可能\n- 港沿いレストランで海の幸を堪能',
            'description': 'モロッコで最も絵になる漁港の一つ。青い漁船が並ぶ港では、毎日新鮮な魚介類が水揚げされ、魚市場は活気に満ちています。特にイワシ、タコ、ウニ、カニなどが豊富で、港沿いのレストランでは獲れたての海の幸を味わえます。かもめが舞い踊る中で働く漁師たちの姿は、まるで映画の一場面のよう。朝早い時間帯に訪れると、船から魚を降ろす作業風景を見学できます。',
            'verified': True,
            'lat': 31.511389,
            'lng': -9.770833,
            'best_time': '早朝（魚の水揚げ）',
            'duration': '1時間',
            'price_range': '無料'
        },
        {
            'id': 32,
            'name': 'ムーレイ・ハッサン広場',
            'city': 'エッサウィラ',
            'category': '広場・市場',
            'summary': 'エッサウィラの中心広場で、メディナと新市街を結ぶ重要な場所。グナワ音楽と大道芸で賑わう文化の交差点です。',
            'features': {
                '景観': '時計塔、メディナ城壁の眺望、美しい都市計画の景観',
                '文化': 'グナワ音楽演奏、大道芸、伝統音楽の生演奏',
                '体験': 'カフェテラス、人間観察、地元と観光客の交流'
            },
            'highlights': [
                '夕方の大道芸人とミュージシャンの演奏',
                'グナワ音楽などの伝統音楽鑑賞',
                '時計塔とメディナ城壁の美しい眺望',
                'カフェテラスでのミントティータイム',
                '地元の人々と観光客の活気ある交流'
            ],
            'how_to_enjoy': {
                '午前（9:00-12:00）': '広場散策、周辺のお土産店巡り',
                '昼（12:00-15:00）': 'カフェランチ、人間観察',
                '午後（15:00-17:00）': 'ミントティー休憩、メディナ城壁眺望',
                '夕方（17:00-19:00）': '大道芸鑑賞、グナワ音楽体験'
            },
            'access_notes': '- メディナの中心部に位置\n- 周囲にカフェ、レストラン、お土産店\n- 夕方が最も賑やかで音楽演奏が多い\n- テラス席でのんびり過ごすのがおすすめ',
            'description': 'エッサウィラの中心広場で、メディナと新市街を結ぶ重要な場所。周囲をカフェ、レストラン、お土産店が囲み、常に地元の人々と観光客で賑わっています。夕方になると大道芸人やミュージシャンが集まり、グナワ音楽などの伝統音楽を楽しめます。広場からは時計塔やメディナの城壁を眺めることができ、エッサウィラの都市計画の美しさを実感できます。カフェのテラスでミントティーを飲みながらの人間観察も楽しいひとときです。',
            'verified': True,
            'lat': 31.512500,
            'lng': -9.768889,
            'best_time': '夕方',
            'duration': '1時間',
            'price_range': '無料'
        },
        # ラバトの観光地（6箇所）
        {
            'id': 33,
            'name': 'ハッサンの塔',
            'city': 'ラバト',
            'category': '歴史建築',
            'summary': '12世紀末アルモハード朝が建設した未完のモスクのミナレット。ユネスコ世界遺産でモロッコ首都のシンボルです。',
            'features': {
                '景観': '高さ44mの赤砂岩の塔、広大な遺跡敷地、ブールグレグ川の眺望',
                '歴史': '12世紀アルモハード朝建築、未完のモスク、ユネスコ世界遺産',
                '建築': 'アルモハード朝三大傑作、赤砂岩建築、イスラム建築様式'
            },
            'highlights': [
                '赤砂岩で造られた44mの壮大なミナレット',
                'アルモハード朝建築の三大傑作の一つ',
                '未完の巨大モスクの歴史的遺跡',
                'ユネスコ世界遺産としての価値',
                'ラバト首都のランドマークとしての存在感'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '遺跡全体散策、歴史について学習',
                '昼（11:00-14:00）': '塔の詳細観察、建築様式研究',
                '午後（14:00-17:00）': '周辺遺跡探索、写真撮影',
                '夕方（17:00-19:00）': '夕日に映える赤砂岩の美しさ鑑賞'
            },
            'access_notes': '- ラバト市内中心部に位置\n- 入場料10DH、ガイド利用推奨\n- ムハンマド5世霊廟と合わせて見学\n- 夕方の赤砂岩が美しい時間帯がベスト',
            'description': '12世紀末にアルモハード朝の第3代カリフ、ヤアクーブ・アル・マンスールによって建設が始められた未完のモスクのミナレット。高さ44メートルの赤砂岩の塔は、完成していれば80メートルになる予定でした。現在はユネスコ世界遺産に登録され、モロッコの首都ラバトのシンボルとなっています。同時代に建てられたセビリアのヒラルダの塔やマラケシュのクトゥビア・モスクと共に、アルモハード朝建築の三大傑作とされています。',
            'verified': True,
            'lat': 34.025833,
            'lng': -6.825000,
            'best_time': '夕方',
            'duration': '1時間',
            'price_range': '10DH（約115円）'
        },
        {
            'id': 34,
            'name': 'ムハンマド5世霊廟',
            'city': 'ラバト',
            'category': '歴史建築',
            'summary': 'モロッコ独立の父ムハンマド5世とハッサン2世国王が眠る白大理石の霊廟。1971年完成の美しい王室建築です。',
            'features': {
                '景観': '白大理石の美しい霊廟、精巧な大理石彫刻、壮麗な建築美',
                '歴史': 'ムハンマド5世・ハッサン2世国王の安置所、モロッコ独立史',
                '建築': '伝統モロッコ建築とモダン様式の融合、ゼリージュ、金箔天井'
            },
            'highlights': [
                '白大理石の壮麗な霊廟建築',
                '色とりどりのゼリージュと金箔天井の装飾',
                '精巧な大理石彫刻の芸術的価値',
                '衛兵の交代式の厳粛なセレモニー',
                'モロッコ王室の歴史と独立の象徴'
            ],
            'how_to_enjoy': {
                '午前（9:00-10:00）': '霊廟見学、建築美の観察',
                '午前（10:00-11:00）': '内部装飾鑑賞、ゼリージュ・金箔天井',
                '午前（11:00-12:00）': '衛兵交代式見学（時間要確認）',
                '見学後': 'ハッサンの塔と合わせて歴史学習'
            },
            'access_notes': '- ハッサンの塔と隣接、無料入場\n- 服装規定あり（露出控えめ）\n- 衛兵交代式の時間要事前確認\n- 静寂を保ち敬意を示すことが重要',
            'description': 'モロッコ独立の父であるムハンマド5世国王とハッサン2世国王が眠る白大理石の霊廟。現国王ムハンマド6世の祖父と父が安置されています。1971年に完成したこの霊廟は、伝統的なモロッコ建築とモダンな要素を融合させた美しい建物です。内部の装飾は息をのむ美しさで、色とりどりのゼリージュ、金箔を施した天井、精巧な大理石彫刻が施されています。衛兵の交代式も見どころの一つです。',
            'verified': True,
            'lat': 34.025278,
            'lng': -6.825278,
            'best_time': '午前中',
            'duration': '45分',
            'price_range': '無料'
        },
        {
            'id': 35,
            'name': 'ウダイヤ・カスバ',
            'city': 'ラバト',
            'category': '歴史建築',
            'summary': '12世紀アルモハード朝の要塞で、ユネスコ世界遺産。ブー・レグレグ川と大西洋の絶景オーシャンビューが楽しめます。',
            'features': {
                '景観': 'ブー・レグレグ川と大西洋の合流点、絶景オーシャンビュー、白と青の美しい住宅街',
                '歴史': '12世紀アルモハード朝要塞、ユネスコ世界遺産、中世防衛建築',
                '文化': 'アンダルシア庭園、地中海風住宅街、カフェ・マウデ'
            },
            'highlights': [
                'ブー・レグレグ川と大西洋の壮大な合流点の眺望',
                '白と青で彩られた地中海風の美しい住宅街',
                '12世紀アルモハード朝の歴史的要塞建築',
                '静寂なアンダルシア庭園での癒しの時間',
                'カフェ・マウデでの絶景ミントティー体験'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '要塞散策、12世紀建築の観察',
                '昼（11:00-14:00）': '白と青の住宅街散策、写真撮影',
                '午後（14:00-16:00）': 'アンダルシア庭園、静寂の時間',
                '夕方（16:00-18:00）': 'カフェ・マウデ、夕日オーシャンビュー'
            },
            'access_notes': '- ラバト市内から徒歩またはタクシー\n- アンダルシア庭園入場料10DH\n- 夕方の海景色が最も美しい\n- カフェ・マウデは絶景スポット',
            'description': '12世紀アルモハード朝時代に建設された要塞で、現在はユネスコ世界遺産に登録されています。ブー・レグレグ川と大西洋の合流点に建つこの要塞からは、絶景のオーシャンビューが楽しめます。城壁内には白と青で彩られた美しい住宅街が広がり、まるで地中海の漁村のような雰囲気。アンダルシア庭園も併設されており、静寂な空間で首都の喧騒を忘れることができます。カフェ・マウデでのミントティーも格別です。',
            'verified': True,
            'lat': 34.033889,
            'lng': -6.839167,
            'best_time': '夕方',
            'duration': '2時間',
            'price_range': '庭園10DH'
        },
        # メクネスの観光地（5箇所）
        {
            'id': 36,
            'name': 'ヴォルビリス遺跡',
            'city': 'メクネス',
            'category': '古代遺跡',
            'summary': '紀元前3世紀から11世紀のローマ帝国属州都市遺跡。北アフリカ最高の保存状態を誇るユネスコ世界遺産です。',
            'features': {
                '景観': '40ヘクタールの広大な遺跡、ゼルホン平野の絶景、古代都市の全景',
                '歴史': '紀元前3世紀〜11世紀のローマ都市、ユネスコ世界遺産、古代文明の証',
                '芸術': '見事なモザイク床、オルフェウスの家、ディオニュソスの家'
            },
            'highlights': [
                '北アフリカ最高保存状態のローマ遺跡',
                '「オルフェウスの家」「ディオニュソスの家」の芸術的モザイク',
                '古代ローマの凱旋門、神殿、公衆浴場の遺構',
                '40ヘクタールに広がる古代都市の壮大なスケール',
                'ゼルホン平野を見渡す絶景のロケーション'
            ],
            'how_to_enjoy': {
                '午前（9:00-10:30）': '遺跡入口、全体概要の把握、地図確認',
                '午前（10:30-12:00）': 'モザイク見学、オルフェウス・ディオニュソスの家',
                '昼（12:00-13:30）': '凱旋門、神殿、公衆浴場など主要遺構',
                '午後（13:30-15:00）': '居住区散策、ゼルホン平野展望'
            },
            'access_notes': '- メクネスから車で約30分\n- 入場料70DH、ガイド推奨\n- 午前中が涼しく見学に最適\n- 歩きやすい靴と日焼け対策必須',
            'description': '紀元前3世紀から11世紀まで存在したローマ帝国の属州都市の遺跡。北アフリカで最も保存状態の良いローマ遺跡の一つで、ユネスコ世界遺産に登録されています。40ヘクタールの敷地には、見事なモザイク床、凱旋門、神殿、公衆浴場、居住区などが残されています。特に「オルフェウスの家」「ディオニュソスの家」のモザイクは芸術的価値が極めて高く、古代ローマの豊かな文化を物語っています。遺跡からは肥沃なゼルホン平野の絶景も楽しめます。',
            'verified': True,
            'lat': 34.074444,
            'lng': -5.555556,
            'best_time': '午前中',
            'duration': '2-3時間',
            'price_range': '70DH（約800円）'
        },
        {
            'id': 37,
            'name': 'バブ・マンスール門',
            'city': 'メクネス',
            'category': '歴史建築',
            'summary': 'イスマーイール朝18世紀建設のモロッコ最美の門。高さ16m・幅8mの巨大な門で、夜間ライトアップが美しい象徴的建造物です。',
            'features': {
                '景観': '高さ16m・幅8mの巨大門、夜間ライトアップ、メクネスのランドマーク',
                '歴史': '18世紀イスマーイール朝建築、「モロッコのヴェルサイユ」の象徴',
                '建築': '緑と白のゼリージュ装飾、精巧な石膏彫刻、イスラム建築美'
            },
            'highlights': [
                'モロッコで最も美しいとされる歴史的な門',
                '緑と白のゼリージュ装飾と精巧な石膏彫刻',
                '高さ16メートルの圧倒的なスケール感',
                '夜間ライトアップの幻想的な美しさ',
                'イスマーイール朝の栄華を物語る象徴的建造物'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '門の建築詳細観察、ゼリージュ装飾鑑賞',
                '昼（11:00-15:00）': '歴史学習、イスマーイール朝について',
                '夕方（15:00-18:00）': '写真撮影、周辺散策',
                '夜間（18:00-20:00）': 'ライトアップ鑑賞、幻想的な夜景'
            },
            'access_notes': '- メクネス旧市街の入口に位置\n- 24時間見学可能、夜間照明あり\n- 建築家エル・マンスール・エル・アレジ設計\n- 周辺にカフェ・レストランあり',
            'description': 'イスマーイール朝のスルタン・ムーレイ・イスマーイールによって18世紀初頭に建設された、モロッコで最も美しい門の一つ。高さ16メートル、幅8メートルの巨大な門は、緑と白のゼリージュ装飾と精巧な石膏彫刻で装飾されています。門の名前は設計した建築家エル・マンスール・エル・アレジに由来します。夜間のライトアップは特に美しく、「ヴェルサイユのモロッコ版」と呼ばれたメクネスの栄華を物語る象徴的建造物です。',
            'verified': True,
            'lat': 33.893889,
            'lng': -5.556111,
            'best_time': '夕方〜夜',
            'duration': '30分',
            'price_range': '無料'
        },
        # ティトゥアンの観光地（3箇所）
        {
            'id': 38,
            'name': 'ティトゥアン旧市街',
            'city': 'ティトゥアン',
            'category': '都市・建築',
            'summary': '15世紀末アンダルシアのムーア人が建設したユネスコ世界遺産。「白いハト」の名の通り白い建物が美しい山間の古都です。',
            'features': {
                '景観': '白い建物群、美しい山間古都、アンダルシア風建築',
                '歴史': '15世紀末ムーア人建設、レコンキスタ後の文化継承、ユネスコ世界遺産',
                '文化': 'アンダルシア文化、精巧な木工装飾、伝統手工芸'
            },
            'highlights': [
                'アンダルシア追放ムーア人が築いた歴史的価値',
                '「白いハト」の名にふさわしい白い建物群',
                '精巧な木工装飾と美しい中庭を持つ住宅',
                '金属細工と木工芸品で有名な職人街',
                'ユネスコ世界遺産としての文化的意義'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '旧市街散策、白い建築群の観察',
                '午前（11:00-12:30）': '職人街見学、伝統手工芸の見学',
                '昼（12:30-14:00）': 'アンダルシア様式住宅と中庭見学',
                '午後（14:00-16:00）': '木工・金属細工工房体験、お土産購入'
            },
            'access_notes': '- ティトゥアン市内中心部\n- 散策は無料、工房見学は交渉次第\n- 午前中が涼しく散策に最適\n- アンダルシア文化の説明を聞くとより理解深まる',
            'description': '15世紀末にアンダルシアから追放されたムーア人によって建設されたユネスコ世界遺産の旧市街。「白いハト」という意味の名前の通り、白い建物が美しい山間の古都です。アンダルシア文化の影響が色濃く残る建築様式、精巧な木工装飾、美しい中庭を持つ住宅群など、独特の文化的価値を持っています。職人街では伝統的な手工芸が今も営まれており、特に金属細工と木工芸品で有名です。',
            'verified': True,
            'lat': 35.578611,
            'lng': -5.368611,
            'best_time': '午前中',
            'duration': '半日',
            'price_range': '散策無料'
        },
        # タンジェの観光地（4箇所）
        {
            'id': 39,
            'name': 'ヘラクレスの洞窟',
            'city': 'タンジェ',
            'category': '自然',
            'summary': 'タンジェ郊外の自然海蝕洞窟。開口部がアフリカ大陸の形に見え、ギリシャ神話のヘラクレス伝説で有名です。',
            'features': {
                '景観': 'アフリカ大陸形の開口部、大西洋絶景、夕日の幻想的光景',
                '自然': '海蝕洞窟、自然形成、ケープ・スパルテル近接',
                '文化': 'ギリシャ神話ヘラクレス伝説、大西洋と地中海の境界'
            },
            'highlights': [
                '洞窟開口部がアフリカ大陸の形に見える自然の造形',
                'ギリシャ神話の英雄ヘラクレスの休息伝説',
                '洞窟内から望む大西洋の絶景パノラマ',
                '夕日時間の幻想的で美しい光景',
                'ケープ・スパルテルとの地理学的重要性'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': '洞窟探索、自然形成の観察',
                '昼（11:00-14:00）': 'ケープ・スパルテル訪問、地理学習',
                '午後（14:00-17:00）': '洞窟内散策、大西洋展望',
                '夕方（17:00-19:00）': '夕日鑑賞、幻想的な光景撮影'
            },
            'access_notes': '- タンジェ市内から車で約20分\n- 無料見学、駐車場あり\n- 夕方の夕日時間が最も美しい\n- ケープ・スパルテルと合わせて訪問推奨',
            'description': 'タンジェ郊外に位置する自然が作り出した海蝕洞窟。洞窟の開口部がアフリカ大陸の形に見えることで有名です。ギリシャ神話の英雄ヘラクレスがここで休息したという伝説からこの名前が付けられました。洞窟内からは大西洋の絶景が望め、特に夕日の時間帯は幻想的な光景が楽しめます。近くのケープ・スパルテルは、大西洋と地中海が出会う地点として地理学的にも重要な場所です。',
            'verified': True,
            'lat': 35.792222,
            'lng': -5.929444,
            'best_time': '夕方',
            'duration': '1時間',
            'price_range': '無料'
        },
        {
            'id': 40,
            'name': 'タンジェ・メディナ',
            'city': 'タンジェ',
            'category': '都市・建築',
            'summary': 'ジブラルタル海峡を見下ろす丘の旧市街。アフリカとヨーロッパの交差点として栄えた歴史的な街並みが保存されています。',
            'features': {
                '景観': 'ジブラルタル海峡俯瞰、スペイン海岸線展望、丘陵地の美しい街並み',
                '歴史': 'アフリカ・ヨーロッパ交差点、古代からの港湾都市、多文化交流',
                '文化': '北アフリカ・地中海・アンダルシア文化の融合、職人工房'
            },
            'highlights': [
                'ジブラルタル海峡とスペイン海岸線の絶景',
                'アフリカとヨーロッパ文化が交わる独特な雰囲気',
                '迷路のような小径と白い壁の伝統的家屋',
                '職人工房での伝統的手工芸の見学',
                'カスバからの大西洋・地中海パノラマビュー'
            ],
            'how_to_enjoy': {
                '午前（9:00-11:00）': 'メディナ散策、迷路のような街並み探索',
                '午前（11:00-12:30）': '職人工房見学、伝統工芸体験',
                '昼（12:30-14:00）': '伝統カフェでミントティー、地元グルメ',
                '午後（14:00-16:00）': 'カスバ見学、ジブラルタル海峡絶景'
            },
            'access_notes': '- タンジェ市内中心部、港から徒歩圏内\n- 散策無料、一部施設は入場料あり\n- 午前中が涼しく散策しやすい\n- ヨーロッパフェリー港からもアクセス良好',
            'description': 'ジブラルタル海峡を見下ろす丘に位置する旧市街。アフリカとヨーロッパの交差点として栄えたタンジェの歴史を物語る街並みが保存されています。迷路のような小径、白い壁の家々、職人の工房、伝統的なカフェなど、北アフリカの典型的なメディナの特徴を持ちながら、地中海とアンダルシアの影響も感じられる独特の雰囲気があります。カスバからはスペインの海岸線まで見渡せる絶景が楽しめます。',
            'verified': True,
            'lat': 35.782778,
            'lng': -5.810556,
            'best_time': '午前中',
            'duration': '2-3時間',
            'price_range': '散策無料'
        }
    ]
    
    return spots

def init_ai_service():
    """AI機能の初期化（高精度対応版）"""
    # 環境変数からAPIキーを安全に取得（表示しない）
    api_key = os.getenv('OPENAI_API_KEY')
    
    return {
        'available': bool(api_key),
        'api_key_masked': '****' if api_key else None,
        'knowledge_base': get_ai_knowledge_base(),
        'fallback_responses': get_enhanced_fallback_responses()
    }

def get_ai_knowledge_base():
    """AI用の詳細知識ベース"""
    return {
        'country_info': {
            'name': 'モロッコ王国',
            'capital': 'ラバト',
            'largest_city': 'カサブランカ',
            'population': '約3700万人',
            'area': '446,550平方キロメートル',
            'languages': ['アラビア語', 'ベルベル語（タマジグト語）', 'フランス語'],
            'currency': 'モロッコ・ディルハム（MAD）',
            'climate': '地中海性気候、大陸性気候、砂漠気候',
            'time_zone': 'GMT+1',
            'religion': 'イスラム教（スンニ派）99%'
        },
        'cultural_context': {
            'berber_heritage': 'ベルベル人（アマジグ人）は北アフリカの先住民族で、モロッコ文化の基盤',
            'islamic_influence': '7世紀のイスラム征服以降、アラブ・イスラム文化が根付く',
            'andalusian_legacy': '15世紀にスペインから移住したムーア人がアンダルシア文化を伝承',
            'french_colonial': '1912-1956年のフランス保護領時代の影響が現代にも残存',
            'modern_identity': '伝統と現代が調和した独特の文化アイデンティティ'
        },
        'travel_tips': {
            'best_seasons': {
                'spring': '3-5月: 温暖で観光に最適',
                'summer': '6-8月: 内陸部は酷暑、沿岸部は涼しい',
                'autumn': '9-11月: 過ごしやすく観光シーズン',
                'winter': '12-2月: 温和だがアトラス山脈は寒い'
            },
            'cultural_etiquette': {
                'greetings': 'アッサラーム・アライクム（平和があなたに）',
                'dress_code': '控えめな服装、特に宗教施設では肌の露出を避ける',
                'photography': 'モスク内部や人物撮影は許可を得る',
                'haggling': 'スークでの価格交渉は文化の一部',
                'meal_customs': '右手で食事、パンで料理をすくう'
            },
            'practical_info': {
                'visa': '日本国民は90日以内の観光は査証不要',
                'health': '特別な予防接種は不要',
                'safety': '観光地は比較的安全、夜間の一人歩きは避ける',
                'internet': 'WiFiは都市部で普及、通信速度は中程度',
                'transportation': 'ONCF鉄道、CTMバス、グランタクシーが主要交通手段'
            }
        }
    }

def get_enhanced_fallback_responses():
    """拡張されたフォールバック応答"""
    return {
        'マラケシュ': '''マラケシュは「赤い街」として知られるモロッコの帝国都市です。

**主要観光地（15箇所）:**
• ジャマ・エル・フナ広場: 1000年の歴史を持つユネスコ世界遺産
• クトゥビア・モスク: 12世紀建造、高さ77mのミナレット
• バイア宮殿: 19世紀の豪華な宮殿、精巧なタイル装飾
• マジョレル庭園: イヴ・サンローラン所有の美しい植物園
• サーディアン朝の墳墓群、エル・バディ宮殿などもご案内

**おすすめ体験:**
• 夕方のジャマ・エル・フナ広場で大道芸観賞
• 伝統的なリヤドホテルでの宿泊
• スークでのお土産探し
• アトラス山脈日帰りツアー''',

        'カサブランカ': '''カサブランカはモロッコ最大の経済都市で、現代的な魅力を持ちます。

**主要観光地（12箇所）:**
• ハッサン2世モスク: 世界第3位の規模、海に面した美しい立地
• リック・カフェ: 映画「カサブランカ」の世界を再現
• 旧市街メディナ: 18世紀の白い街並み
• コーニッシュ海岸、モロッコ・モールなども充実  
• ツインセンター: 現代モロッコのシンボル

**文化的特徴:**
• フランス植民地時代の建築遺産
• モロッコ経済の中心地
• 国際的な雰囲気と伝統の融合''',

        'フェズ': '''フェズは1200年の歴史を持つモロッコの古都で、イスラム文化の宝庫です。

**主要観光地（10箇所）:**
• フェズ・エル・バリ: 世界最大の車両進入禁止都市
• カラウィーン大学: 859年創設の世界最古の大学
• シュワラ皮なめし場: 11世紀から続く伝統技法
• ボウ・イナニア・マドラサ: マリーン朝建築の傑作

**文化的価値:**
• イスラム学問の中心地
• 伝統工芸の継承地
• 中世の街並みが完全保存''',

        'メルズーガ': '''メルズーガはサハラ砂漠観光の玄関口で、砂漠体験の聖地です。

**主要観光地（6箇所）:**
• エルグ・シェビ砂丘: 高さ150mの美しい砂丘群
• ハッシ・ラブド砂丘: より静寂な砂漠体験

**おすすめ体験:**
• ラクダトレッキングで砂丘登頂
• 砂漠キャンプで満天の星空観賞
• ベルベル音楽と伝統料理
• 日の出・日没の絶景撮影''',

        'シャウエン': '''シャウエンは「青い真珠」と呼ばれる山間の美しい町です。

**主要観光地（8箇所）:**
• 青い旧市街: 青く塗られた家々の独特な景観
• ウタ・エル・ハマム広場: 町の中心広場
• カスバ: 15世紀の要塞、町を一望
• アケチャウル滝: 自然の美しい滝
• スペイン・モスク、神の橋なども魅力的

**特徴:**
• アンダルシア・ムーア人の建築様式
• リフ山脈の美しい自然
• アーティストや写真家に人気''',

        'エッサウィラ': '''エッサウィラは「アフリカの風の街」として知られる大西洋沿岸の港町です。

**主要観光地（8箇所）:**
• 要塞都市メディナ: ユネスコ世界遺産
• スカラ・デュ・ポール: 18世紀の海上要塞
• 活気ある漁港: 新鮮な海の幸
• ムーレイ・ハッサン広場: 町の中心
• シディ・モハメド・ベン・アブドラ博物館などが充実

**文化的特徴:**
• グナワ音楽の聖地
• ウィンドサーフィンの名所
• ポルトガル・フランス建築の融合''',

        'general': '''モロッコは北アフリカに位置する王国で、豊かな文化遺産と自然の美しさで知られています。

**基本情報:**
• 首都: ラバト（政治）、カサブランカ（経済）
• 人口: 約3700万人
• 言語: アラビア語、ベルベル語（公用語）、フランス語
• 宗教: イスラム教（スンニ派）99%
• 通貨: モロッコ・ディルハム（MAD）

**文化的特徴:**
• アラブ、ベルベル、アンダルシア、アフリカ文化の融合
• 豊富なユネスコ世界遺産
• 伝統工芸と現代アートの共存
• 多様な気候と地形（砂漠、山脈、海岸）'''
    }

@handle_errors
@measure_performance
def main():
    """メインアプリケーション"""
    
    # データ検証
    try:
        spots = load_spots_data()
        logger.info(f"Successfully loaded {len(spots) if spots else 0} tourist spots")
        if not spots:
            st.error("❌ 観光地データの読み込みに失敗しました")
            st.stop()
    except Exception as e:
        st.error(f"❌ データ読み込みエラー: {str(e)}")
        logger.error(f"Failed to load spots data: {e}")
        st.stop()
    
    # シンプルなページ管理
    # URLパラメータまたはセッション状態から現在のページを決定
    query_params = st.query_params
    
    if 'spot_id' in query_params:
        # 詳細ページの表示
        try:
            spot_id = int(query_params['spot_id'])
            # 有効なIDかチェック
            valid_ids = [spot['id'] for spot in spots]
            if spot_id not in valid_ids:
                st.error(f"❌ 無効な観光地ID: {spot_id}")
                st.info("🏠 ホームページに戻ります")
                st.query_params.clear()
                st.rerun()
            else:
                show_spot_detail_by_id(spot_id)
        except ValueError:
            st.error("❌ 無効なURLパラメータです")
            st.query_params.clear()
            st.rerun()
    else:
        # 通常のページ表示
        show_main_app()

def show_main_app():
    """メインアプリケーションの表示"""
    # ヘッダー
    st.markdown("""
    <div class="main-header">
        <h1>🕌 モロッコ観光ガイド</h1>
        <p>Morocco Tourism Guide - あなたの完璧なモロッコ旅行をサポート</p>
    </div>
    """, unsafe_allow_html=True)
    
    # サイドバー
    st.sidebar.title("🧭 ナビゲーション")
    
    # ページ選択
    current_page = st.session_state.get('current_page', '🏠 ホーム')
    page_options = ["🏠 ホーム", "🗺️ マップ", "📍 観光地一覧", "🏛️ モロッコ文化・歴史", "🤖 AI観光ガイド", "⚙️ 設定"]
    
    page_index = 0
    if current_page in page_options:
        page_index = page_options.index(current_page)
    
    page = st.sidebar.selectbox(
        "ページを選択",
        page_options,
        index=page_index
    )
    
    # 現在のページをセッション状態に保存
    st.session_state.current_page = page
    
    # テーマ表示
    st.sidebar.markdown("---")
    current_theme = st.session_state.get("theme", "ライト")
    theme_emoji = "🌞" if current_theme == "ライト" else "🌙"
    st.sidebar.markdown(f"**🎨 現在のテーマ: {theme_emoji} {current_theme}**")
    st.sidebar.markdown("*テーマ変更は設定ページで行えます*")
    
    # データ読み込み
    spots = load_spots_data()
    ai_service = init_ai_service()
    
    # ページ表示
    if page == "🏠 ホーム":
        show_home_page(spots)
    elif page == "🗺️ マップ":
        show_map_page(spots)
    elif page == "📍 観光地一覧":
        show_spots_page(spots)
    elif page == "🏛️ モロッコ文化・歴史":
        show_culture_history_page()
    elif page == "🤖 AI観光ガイド":
        show_ai_page(ai_service)
    elif page == "⚙️ 設定":
        show_settings_page()

def show_spot_detail_by_id(spot_id):
    """IDによる詳細ページ表示"""
    spots = load_spots_data()
    
    # IDで観光地を検索
    spot = None
    for s in spots:
        if s['id'] == spot_id:
            spot = s
            break
    
    if not spot:
        st.error("⚠️ 指定された観光地が見つかりません")
        if st.button("← 観光地一覧に戻る"):
            st.query_params.clear()
            st.rerun()
        return
    
    # 詳細ページのヘッダー
    st.markdown(f"""
    <div class="detail-header">
        <h1>📍 {spot['name']}</h1>
        <p>{spot['city']} - {spot['category']}</p>
    </div>
    """, unsafe_allow_html=True)
    
    # サイドバー
    st.sidebar.title("📍 観光地詳細")
    st.sidebar.markdown(f"**{spot['name']}**")
    st.sidebar.markdown(f"📍 {spot['city']}")
    st.sidebar.markdown(f"🏷️ {spot['category']}")
    if spot.get('verified'):
        st.sidebar.success("✅ 認定スポット")
    
    st.sidebar.markdown("---")
    if st.sidebar.button("← 観光地一覧に戻る", use_container_width=True):
        st.query_params.clear()
        st.rerun()
    
    # 詳細情報を表示
    show_spot_details(spot)




def show_home_page(spots):
    """ホームページ"""
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("📍 観光地数", len(spots))
    
    with col2:
        cities = set(spot['city'] for spot in spots)
        st.metric("🏙️ 都市数", len(cities))
    
    with col3:
        verified_count = sum(1 for spot in spots if spot.get('verified', False))
        st.metric("✅ 認定スポット", verified_count)
    
    with col4:
        categories = set(spot['category'] for spot in spots)
        st.metric("🎯 カテゴリ数", len(categories))
    
    st.markdown("---")
    
    # おすすめ観光地
    st.subheader("🌟 おすすめ観光地")
    
    recommended_spots = [spot for spot in spots if spot.get('verified', False)][:6]
    
    for i, spot in enumerate(recommended_spots):
        with st.container():
            st.markdown(f"""
            <div class="spot-card">
                <div class="spot-title">{spot['name']}</div>
                <div class="spot-meta">
                    📍 {spot['city']} • <span class="category-badge">{spot['category']}</span>
                    {' • <span class="verified-badge">認定済み</span>' if spot.get('verified') else ''}
                </div>
                <p>{(spot.get('summary') or spot.get('description', '詳細情報なし'))[:100]}...</p>
            </div>
            """, unsafe_allow_html=True)
            st.markdown("---")  # 区切り線を追加

def show_map_page(spots):
    """マップページ"""
    st.subheader("🗺️ モロッコ観光地マップ")
    
    # 高度なフィルター機能
    st.markdown("### 🎯 マップフィルター")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        cities = sorted(set(spot['city'] for spot in spots))
        selected_cities = st.multiselect(
            "🏙️ 表示する都市（複数選択可）",
            options=cities,
            default=cities,  # デフォルトで全都市選択
            placeholder="都市を選択"
        )
    
    with col2:
        categories = sorted(set(spot['category'] for spot in spots))
        selected_categories = st.multiselect(
            "🎯 表示するカテゴリ（複数選択可）",
            options=categories,
            default=categories,  # デフォルトで全カテゴリ選択
            placeholder="カテゴリを選択"
        )
    
    with col3:
        map_options = st.multiselect(
            "⚙️ マップオプション",
            options=["認定済みのみ", "詳細情報表示", "価格情報表示"],
            default=["詳細情報表示"],
            placeholder="オプションを選択"
        )
    
    # フィルタリング
    filtered_spots = spots
    
    # 都市フィルター（複数選択）
    if selected_cities:
        filtered_spots = [spot for spot in filtered_spots if spot['city'] in selected_cities]
    
    # カテゴリフィルター（複数選択）
    if selected_categories:
        filtered_spots = [spot for spot in filtered_spots if spot['category'] in selected_categories]
    
    # 認定済みフィルター
    if "認定済みのみ" in map_options:
        filtered_spots = [spot for spot in filtered_spots if spot.get('verified', False)]
    
    # マップ作成
    if filtered_spots:
        try:
            # マップの中心を計算
            center_lat = sum(spot['lat'] for spot in filtered_spots) / len(filtered_spots)
            center_lng = sum(spot['lng'] for spot in filtered_spots) / len(filtered_spots)
            
            m = folium.Map(
                location=[center_lat, center_lng], 
                zoom_start=6,
                tiles="OpenStreetMap"
            )
        except Exception as e:
            st.error(f"❌ 地図の初期化に失敗しました: {str(e)}")
            st.info("📍 デフォルトの地図を表示します")
            m = folium.Map(
                location=[31.7917, -7.0926],  # モロッコの中心
                zoom_start=6,
                tiles="OpenStreetMap"
            )
        
        # マーカーを追加
        for spot in filtered_spots:
            # 詳細情報の表示判定
            show_details = "詳細情報表示" in map_options
            show_price = "価格情報表示" in map_options
            
            # ポップアップHTMLの構築
            popup_content = f"""
            <div style="width: 300px; font-family: Arial, sans-serif;">
                <h4 style="color: #2c3e50; margin-bottom: 8px;">{spot['name']}</h4>
                <p style="margin: 4px 0;"><b>📍 {spot['city']}</b> • <b>🏷️ {spot['category']}</b></p>
            """
            
            if spot.get('verified'):
                popup_content += '<p style="margin: 4px 0;"><span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">✅ 認定済み</span></p>'
            
            if show_details:
                # descriptionまたはsummaryを使用
                description = spot.get('description') or spot.get('summary') or '詳細情報なし'
                popup_content += f'<p style="margin: 8px 0; line-height: 1.4;">{description[:150]}...</p>'
                
                if spot.get('best_time'):
                    popup_content += f'<p style="margin: 4px 0;"><b>⏰ ベストタイム:</b> {spot["best_time"]}</p>'
                
                if spot.get('duration'):
                    popup_content += f'<p style="margin: 4px 0;"><b>⏱️ 所要時間:</b> {spot["duration"]}</p>'
            else:
                # descriptionまたはsummaryを使用
                description = spot.get('description') or spot.get('summary') or '詳細情報なし'
                popup_content += f'<p style="margin: 8px 0; line-height: 1.4;">{description[:80]}...</p>'
            
            if show_price and spot.get('price_range'):
                popup_content += f'<p style="margin: 4px 0;"><b>💰 料金:</b> {spot["price_range"]}</p>'
            
            popup_content += '</div>'
            
            popup_html = popup_content
            
            folium.Marker(
                location=[spot['lat'], spot['lng']],
                popup=folium.Popup(popup_html, max_width=300),
                tooltip=spot['name'],
                icon=folium.Icon(
                    color='red' if spot.get('verified') else 'blue',
                    icon='check' if spot.get('verified') else 'info-sign'
                )
            ).add_to(m)
        
        # マップ表示
        map_data = st_folium(m, width=700, height=500)
        
        # 観光地リスト
        st.subheader(f"📍 観光地一覧 ({len(filtered_spots)}件)")
        
        for spot in filtered_spots:
            with st.expander(f"{spot['name']} - {spot['city']}"):
                st.write(spot.get('summary') or spot.get('description', '詳細情報なし'))
                st.write(f"**カテゴリ:** {spot['category']}")
                if spot.get('verified'):
                    st.success("✅ 認定済み")
                
                # 詳細ボタン
                if st.button(f"📖 詳細", key=f"list_detail_{spot['id']}", use_container_width=True):
                    st.query_params['spot_id'] = spot['id']
                    st.rerun()
    else:
        st.warning("選択した条件に一致する観光地がありません。")

@handle_errors
def show_spot_details(spot):
    """観光地の詳細情報を表示 - 改良版レイアウト"""
    
    # カスタムCSS for 詳細ページ
    st.markdown("""
    <style>
    .detail-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .detail-hero h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .detail-hero .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 1rem;
    }
    .info-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        margin-bottom: 1rem;
    }
    .info-card h3 {
        color: #667eea;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 20px;
        font-size: 0.9rem;
        margin: 0.25rem;
    }
    .coordinates {
        background: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-family: monospace;
        border: 1px solid #e9ecef;
    }
    .section-divider {
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border: none;
        border-radius: 2px;
        margin: 2rem 0;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # ヒーローセクション
    verified_badge = "✅ 認定観光地" if spot.get('verified') else ""
    st.markdown(f"""
    <div class="detail-hero">
        <h1>� {spot['name']}</h1>
        <div class="subtitle">
            🏙️ {spot['city']} • 🎯 {spot['category']} {verified_badge}
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # メイン内容エリア
    col1, col2 = st.columns([2, 1])
    
    with col1:
        # 詳細情報タブ
        if spot.get('summary'):
            # 構造化された情報がある場合
            tab1, tab2, tab3, tab4, tab5 = st.tabs([
                "🎯 一言でどんな場所か", "✨ 特徴", "👀 見どころ", "🎪 楽しみ方・周り方", "🚗 アクセス・注意点"
        ])
        
            with tab1:
                st.markdown("### 🎯 一言でどんな場所か（要約）")
                st.write(spot.get('summary', '情報なし'))
        
            with tab2:
                st.markdown("### ✨ 特徴（景観・歴史・文化など）")
                features = spot.get('features', {})
                if isinstance(features, dict):
                    for key, value in features.items():
                        st.markdown(f"**{key}:** {value}")
                else:
                    st.write(features)
        
            with tab3:
                st.markdown("### 👀 見どころ")
                highlights = spot.get('highlights', [])
                if isinstance(highlights, list):
                    for highlight in highlights:
                        st.markdown(f"• {highlight}")
                else:
                    st.write(highlights)
        
            with tab4:
                st.markdown("### 🎪 楽しみ方・周り方")
                how_to_enjoy = spot.get('how_to_enjoy', {})
                if isinstance(how_to_enjoy, dict):
                    for time_period, activity in how_to_enjoy.items():
                        st.markdown(f"**{time_period}:** {activity}")
                else:
                    st.write(how_to_enjoy)
            
            with tab5:
                st.markdown("### 🚗 アクセス・注意点")
                access_notes = spot.get('access_notes', '情報なし')
                if isinstance(access_notes, str):
                    # 改行を適切に処理
                    access_text = access_notes.replace('\\n', '\n')
                    st.write(access_text)
                else:
                    st.write(access_notes)
        else:
            # 基本的な説明のみ
            st.markdown(f"""
            <div class="info-card">
                <h3>📝 詳細情報</h3>
                <p>{spot.get('description', '詳細情報なし')}</p>
            </div>
            """, unsafe_allow_html=True)
    
    with col2:
        # サイドバー情報
        st.markdown("### 📊 基本情報")
        
        # カテゴリバッジ
        st.markdown(f'<div class="badge">{spot["category"]}</div>', unsafe_allow_html=True)
        
        # 座標情報
        if spot.get('coordinates'):
            lat, lon = spot['coordinates']
            st.markdown("**📍 座標**")
            st.markdown(f'<div class="coordinates">緯度: {lat:.4f}<br>経度: {lon:.4f}</div>', unsafe_allow_html=True)
        
        # 認定ステータス
        if spot.get('verified'):
            st.success("✅ 認定観光地")
        
        # 追加情報（将来の拡張用）
        st.markdown("---")
        st.markdown("### 🎯 アクション")
        if st.button("🗺️ 地図で見る", use_container_width=True):
            st.info("地図セクションにスクロールします")
        if st.button("📤 シェア", use_container_width=True):
            st.info("シェア機能は今後実装予定です")
    
    # セクション区切り
    st.markdown('<hr class="section-divider">', unsafe_allow_html=True)
    
    # 地図表示（座標がある場合）
    if spot.get('coordinates'):
        st.markdown("### 🗺️ 位置情報")
        
        import folium
        from streamlit_folium import st_folium
        
        lat, lon = spot['coordinates']
        
        # 地図スタイルの改良
        m = folium.Map(
            location=[lat, lon], 
            zoom_start=13,
            tiles='OpenStreetMap'
        )
        
        # カスタムマーカー
        folium.Marker(
            [lat, lon],
            popup=folium.Popup(f"""
                <div style="width: 200px;">
                    <h4>{spot['name']}</h4>
                    <p><strong>📍 {spot['city']}</strong></p>
                    <p><strong>🎯 {spot['category']}</strong></p>
                    {'<p><strong>✅ 認定観光地</strong></p>' if spot.get('verified') else ''}
                </div>
            """, max_width=250),
            tooltip=f"📍 {spot['name']}",
            icon=folium.Icon(
                color='red', 
                icon='star' if spot.get('verified') else 'info-sign',
                prefix='fa'
            )
        ).add_to(m)
        
        # 地図表示（全幅）
        st_folium(m, width='100%', height=450, returned_objects=["last_object_clicked"])
        
        # 座標情報の表示
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("📍 緯度", f"{lat:.6f}")
        with col2:
            st.metric("📍 経度", f"{lon:.6f}")
        with col3:
            st.metric("🎯 ズーム", "13")
    
    # ページの絶対最上部マーカー
    st.markdown("""
    <div class="detail-page-container">
        <div id="page-top" style="height: 0; margin: 0; padding: 0; position: absolute; top: 0;"></div>
    </div>
    """, unsafe_allow_html=True)
    
    # 超目立つ詳細ページ開始マーカー
    st.markdown("""
    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 25%, #c0392b 75%, #8b0000 100%); 
                color: white; 
                padding: 2rem; 
                border-radius: 20px; 
                text-align: center; 
                margin: 0 0 2rem 0;
                box-shadow: 0 10px 20px rgba(0,0,0,0.4);
                position: relative;
                z-index: 9999;
                border: 4px solid rgba(255,255,255,0.3);
                animation: glow 2s ease-in-out infinite alternate;">
        <h1 style="margin: 0; color: white; font-size: 2.5rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.7);">
            � 詳細情報ページ 🎯
        </h1>
        <p style="margin: 1rem 0; color: white; font-size: 1.3rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            📖 ここから詳細情報を読み始めてください 📖
        </p>
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.15); border-radius: 15px; border: 2px solid rgba(255,255,255,0.2);">
            <span style="color: white; font-weight: bold; font-size: 1.2rem;">⬇️ 詳細情報開始 ⬇️</span>
        </div>
    </div>
    
    <style>
    @keyframes glow {
        from { box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 0 20px rgba(255,107,107,0.3); }
        to { box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 0 30px rgba(255,107,107,0.6); }
    }
    </style>
    """, unsafe_allow_html=True)
    
    # 戻るボタンと観光地名を上部に配置
    col1, col2, col3 = st.columns([1, 2, 1])
    with col1:
        if st.button("🔙 前のページに戻る", use_container_width=True):
            # 前のページ情報があれば、そのページに戻る
            if 'previous_page' in st.session_state and st.session_state.previous_page:
                st.session_state.current_page = st.session_state.previous_page
            
            # 戻る時の状態を完全リセット
            st.session_state.detail_mode = False
            st.session_state.selected_spot = None
            st.session_state.scroll_to_top = True
            st.session_state.force_scroll_reset = True
            st.session_state.detail_just_opened = False
            st.session_state.page_reset_required = True
            st.rerun()
    
    with col2:
        st.markdown(f"""
        <div style="text-align: center; padding: 1rem; background: linear-gradient(90deg, #3498db, #2980b9); 
                    color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h1 style="margin: 0; color: white; font-size: 1.8rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                🏛️ {spot['name']}
            </h1>
            <p style="margin: 0.5rem 0 0 0; color: white; opacity: 0.9;">詳細情報表示中</p>
        </div>
        """, unsafe_allow_html=True)
    
    # 写真プレースホルダー（将来の拡張用）
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                height: 300px; 
                border-radius: 10px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                color: white; 
                font-size: 24px; 
                margin-bottom: 20px;">
        <div style="text-align: center;">
            📷<br>
            {spot['name']}<br>
            <small style="font-size: 14px;">写真は今後追加予定</small>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # 関連アクション
    st.markdown('<hr class="section-divider">', unsafe_allow_html=True)
    st.markdown("### 🔗 関連アクション")
    
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("🗺️ マップで確認", use_container_width=True):
            st.session_state.detail_mode = False
            st.session_state.selected_spot = None
            # マップページに移動する処理（将来の拡張）
            st.info("マップページでこの観光地を確認できます")
    
    with col2:
        if st.button("📋 観光地一覧", use_container_width=True):
            st.query_params.clear()
            st.session_state.current_page = '📍 観光地一覧'
            st.rerun()
    
    with col3:
        if st.button("�️ マップビュー", use_container_width=True):
            st.query_params.clear()
            st.session_state.current_page = '🗺️ マップ'
            st.rerun()


def show_spots_page(spots):
    """観光地一覧ページ"""
    st.subheader("📍 観光地一覧")
    
    # 高度な検索・フィルター機能
    st.markdown("### 🔍 検索・フィルター")
    
    # テキスト検索
    search_term = st.text_input("🔍 観光地を検索", placeholder="名前や都市名、説明文で検索...")
    
    # フィルター（複数選択対応）- 1列構成
    cities = sorted(set(spot['city'] for spot in spots))
    selected_cities = st.multiselect(
        "🏙️都市を選択（複数選択可）",
        options=cities,
        default=[],
        placeholder="都市を選択してください"
    )
    
    categories = sorted(set(spot['category'] for spot in spots))
    selected_categories = st.multiselect(
        "🎯 カテゴリを選択（複数選択可）",
        options=categories,
        default=[],
        placeholder="カテゴリを選択してください"
    )
    
    # 追加オプション
    col3, col4, col5 = st.columns(3)
    
    with col3:
        show_verified_only = st.checkbox("✅ 認定済みのみ表示")
    
    with col4:
        # 価格フィルター
        price_filter = st.selectbox(
            "💰 価格帯",
            ["すべて", "無料", "有料（500円未満）", "有料（500円以上）"]
        )
    
    with col5:
        # 所要時間フィルター
        duration_filter = st.selectbox(
            "⏱️ 所要時間",
            ["すべて", "短時間（1時間未満）", "中時間（1-3時間）", "長時間（3時間以上）"]
        )
    
    # フィルタリング
    filtered_spots = spots
    
    # テキスト検索（名前、都市、説明文を対象）
    if search_term:
        filtered_spots = [
            spot for spot in filtered_spots 
            if search_term.lower() in spot['name'].lower() or 
               search_term.lower() in spot['city'].lower() or
               search_term.lower() in (spot.get('summary') or spot.get('description', '')).lower()
        ]
    
    # 都市フィルター（複数選択）
    if selected_cities:
        filtered_spots = [spot for spot in filtered_spots if spot['city'] in selected_cities]
    
    # カテゴリフィルター（複数選択）
    if selected_categories:
        filtered_spots = [spot for spot in filtered_spots if spot['category'] in selected_categories]
    
    # 認定済みフィルター
    if show_verified_only:
        filtered_spots = [spot for spot in filtered_spots if spot.get('verified', False)]
    
    # 価格フィルター
    if price_filter != "すべて":
        if price_filter == "無料":
            filtered_spots = [spot for spot in filtered_spots if '無料' in spot.get('price_range', '')]
        elif price_filter == "有料（500円未満）":
            filtered_spots = [spot for spot in filtered_spots 
                            if spot.get('price_range', '') and '無料' not in spot.get('price_range', '') 
                            and any(keyword in spot.get('price_range', '') for keyword in ['10DH', '20DH', '30DH', '50DH'])]
        elif price_filter == "有料（500円以上）":
            filtered_spots = [spot for spot in filtered_spots 
                            if spot.get('price_range', '') and any(keyword in spot.get('price_range', '') for keyword in ['70DH', '130DH', '150DH', '300DH'])]
    
    # 所要時間フィルター
    if duration_filter != "すべて":
        if duration_filter == "短時間（1時間未満）":
            filtered_spots = [spot for spot in filtered_spots 
                            if spot.get('duration', '') and any(keyword in spot.get('duration', '') for keyword in ['30分', '45分'])]
        elif duration_filter == "中時間（1-3時間）":
            filtered_spots = [spot for spot in filtered_spots 
                            if spot.get('duration', '') and any(keyword in spot.get('duration', '') for keyword in ['1時間', '2時間', '1-2時間', '1-3時間'])]
        elif duration_filter == "長時間（3時間以上）":
            filtered_spots = [spot for spot in filtered_spots 
                            if spot.get('duration', '') and any(keyword in spot.get('duration', '') for keyword in ['半日', '1日', '2-3時間', '2日'])]
    
    # 検索結果の統計情報と操作ボタン
    if filtered_spots:
        st.markdown("---")
        col1, col2, col3, col4, col5 = st.columns(5)
        
        with col1:
            st.metric("🔍 検索結果", f"{len(filtered_spots)}件")
        
        with col2:
            result_cities = set(spot['city'] for spot in filtered_spots)
            st.metric("🏙️ 対象都市", f"{len(result_cities)}都市")
        
        with col3:
            result_categories = set(spot['category'] for spot in filtered_spots)
            st.metric("🎯 カテゴリ", f"{len(result_categories)}種類")
        
        with col4:
            verified_count = sum(1 for spot in filtered_spots if spot.get('verified', False))
            st.metric("✅ 認定済み", f"{verified_count}件")
        
        with col5:
            # エクスポート機能
            if st.button("📥 結果をCSVで保存"):
                import pandas as pd
                df = pd.DataFrame(filtered_spots)
                csv = df.to_csv(index=False, encoding='utf-8-sig')
                st.download_button(
                    label="⬇️ CSVダウンロード",
                    data=csv,
                    file_name=f"morocco_spots_{len(filtered_spots)}件.csv",
                    mime="text/csv"
                )
    
    # ソート機能
    if filtered_spots:
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.markdown("### 📋 検索結果一覧")
        
        with col2:
            sort_option = st.selectbox(
                "並び替え",
                ["名前順", "都市順", "カテゴリ順", "認定優先"]
            )
    
    # ソート処理
    if sort_option == "名前順":
        filtered_spots = sorted(filtered_spots, key=lambda x: x['name'])
    elif sort_option == "都市順":
        filtered_spots = sorted(filtered_spots, key=lambda x: x['city'])
    elif sort_option == "カテゴリ順":
        filtered_spots = sorted(filtered_spots, key=lambda x: x['category'])
    elif sort_option == "認定優先":
        filtered_spots = sorted(filtered_spots, key=lambda x: (not x.get('verified', False), x['name']))
    
    # 観光地カード表示（詳細ボタン付き）- 1列構成
    for i, spot in enumerate(filtered_spots):
        with st.container():
            # 追加情報の構築
            additional_info = ""
            if spot.get('best_time'):
                additional_info += f"<br>⏰ <strong>ベストタイム:</strong> {spot['best_time']}"
            if spot.get('duration'):
                additional_info += f"<br>⏱️ <strong>所要時間:</strong> {spot['duration']}"
            if spot.get('price_range'):
                additional_info += f"<br>💰 <strong>料金:</strong> {spot['price_range']}"
            
            # 概要表示（新形式の場合）
            description = spot.get('summary', spot.get('description', ''))
            if len(description) > 100:
                description = description[:100] + "..."
            
            st.markdown(f"""
            <div class="spot-card">
                <div class="spot-title">{spot['name']}</div>
                <div class="spot-meta">
                    📍 {spot['city']} • <span class="category-badge">{spot['category']}</span>
                    {' • <span class="verified-badge">認定済み</span>' if spot.get('verified') else ''}
                </div>
                <p>{description}</p>
                {additional_info}
                <p><small>座標: {spot['lat']:.4f}, {spot['lng']:.4f}</small></p>
            </div>
            """, unsafe_allow_html=True)
            
            # 詳細ボタン
            detail_key = f"detail_{spot['id']}"
            if st.button(f"📖 詳細を見る", key=detail_key, use_container_width=True):
                st.query_params['spot_id'] = spot['id']
                st.rerun()
            
            st.markdown("---")  # 区切り線を追加
    else:
        # 検索結果が0件の場合
        st.warning("🔍 検索条件に一致する観光地が見つかりませんでした。")
        
        st.info("""
        **検索のヒント:**
        - より広い条件で検索してみてください
        - 都市やカテゴリの選択を解除してみてください
        - 検索キーワードを変更してみてください
        """)
        
        if st.button("🔄 フィルターをリセット"):
            st.rerun()
        
        # おすすめ観光地を表示
        st.markdown("### 🌟 おすすめ観光地")
        recommended = [spot for spot in spots if spot.get('verified', False)][:4]
        
        for i, spot in enumerate(recommended):
            st.markdown(f"""
            <div class="spot-card" style="opacity: 0.8;">
                <div class="spot-title">{spot['name']}</div>
                <div class="spot-meta">
                    📍 {spot['city']} • <span class="category-badge">{spot['category']}</span>
                    <span class="verified-badge">認定済み</span>
                </div>
                <p>{(spot.get('summary') or spot.get('description', '詳細情報なし'))[:100]}...</p>
            </div>
            """, unsafe_allow_html=True)
            
            # 詳細ボタン
            if st.button(f"📖 詳細を見る", key=f"home_detail_{spot['id']}", use_container_width=True):
                st.query_params['spot_id'] = spot['id']
                st.rerun()
            
            st.markdown("---")  # 区切り線を追加

def show_culture_history_page():
    """モロッコ文化・歴史ページ"""
    st.subheader("🏛️ モロッコ文化・歴史ガイド")
    
    # タブ形式で情報を整理
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["📚 歴史", "🎨 文化", "🏛️ 建築", "🍽️ グルメ", "🎭 伝統"])
    
    with tab1:
        show_history_section()
    
    with tab2:
        show_culture_section()
    
    with tab3:
        show_architecture_section()
    
    with tab4:
        show_cuisine_section()
    
    with tab5:
        show_traditions_section()

def show_history_section():
    """歴史セクション"""
    st.markdown("### 📚 モロッコの歴史")
    
    # 時代別の歴史
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.markdown("""
        **主要時代**
        - 先史時代・ベルベル時代
        - ローマ時代（42-429年）
        - イスラム征服（681年～）
        - アルモラヴィ朝（1040-1147年）
        - アルモハード朝（1121-1269年）
        - マリーン朝（1244-1465年）
        - サーディアン朝（1549-1659年）
        - アラウィー朝（1666年～現在）
        - フランス保護領（1912-1956年）
        - 独立（1956年）
        """)
    
    with col2:
        st.markdown("""
        #### 🏺 古代・先史時代
        モロッコの歴史は旧石器時代にまで遡ります。原住民であるベルベル人（アマジグ人）は、数千年にわたってこの地域で独自の文化を発達させてきました。
        
        #### 🏛️ ローマ時代
        紀元前146年にカルタゴが滅亡すると、現在のモロッコ北部はローマ帝国の属州となりました。ヴォルビリス遺跡は、この時代の繁栄を物語る貴重な遺産です。
        
        #### ☪️ イスラム時代の始まり
        681年、ウマイヤ朝の軍勢がモロッコに到来し、イスラム教が伝来しました。これにより、モロッコは北アフリカのイスラム文明の中心地の一つとなりました。
        
        #### 👑 栄光の王朝時代
        **アルモラヴィ朝（1040-1147年）**: サハラ砂漠から興った王朝で、マラケシュを首都としてイベリア半島南部まで支配しました。
        
        **アルモハード朝（1121-1269年）**: モロッコ史上最大の版図を築いた王朝。クトゥビア・モスク、ハッサンの塔などの傑作建築を残しました。
        
        **マリーン朝（1244-1465年）**: フェズを首都とし、学問と芸術が花開いた時代。多くのマドラサ（神学校）が建設されました。
        """)
    
    # 現代史
    st.markdown("#### 🇫🇷 保護領時代と独立")
    
    col1, col2 = st.columns(2)
    with col1:
        st.info("""
        **フランス保護領時代（1912-1956年）**
        - 1912年フェズ条約によりフランス保護領となる
        - スルタン制は維持されるが実権はフランスが掌握
        - カサブランカ、ラバトなどの近代都市が発展
        - インフラ整備が進む一方、伝統文化は保護される
        """)
    
    with col2:
        st.success("""
        **独立への道のり**
        - 1944年独立党（イスティクラール党）結成
        - 1953年ムハンマド5世がフランスにより廃位・追放
        - 1955年ムハンマド5世復位
        - 1956年3月2日独立達成
        - 1957年王制に移行、ムハンマド5世が初代国王に
        """)

def show_culture_section():
    """文化セクション"""
    st.markdown("### 🎨 モロッコの豊かな文化")
    
    # 文化の多様性
    st.markdown("#### 🌍 文化の融合")
    st.write("""
    モロッコの文化は、**アラブ**、**ベルベル（アマジグ）**、**アンダルシア**、**アフリカ**の4つの要素が融合した独特のものです。
    この多文化性が、モロッコを世界で最も魅力的な文化的目的地の一つにしています。
    """)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        #### 🏺 ベルベル文化
        - **言語**: タマジグト語（公用語）
        - **芸術**: 絨毯、陶器、金属工芸
        - **音楽**: アフリカのリズムを基調
        - **建築**: 土造りの集落（カスバ）
        - **社会**: 部族社会の伝統
        """)
    
    with col2:
        st.markdown("""
        #### ☪️ アラブ・イスラム文化
        - **言語**: アラビア語（公用語）
        - **宗教**: イスラム教（スンニ派）
        - **芸術**: カリグラフィー、幾何学模様
        - **建築**: モスク、マドラサ
        - **法律**: イスラム法の影響
        """)
    
    with col3:
        st.markdown("""
        #### 🏛️ アンダルシア文化
        - **起源**: 15世紀スペインからの移民
        - **建築**: 精巧な装飾、中庭式住宅
        - **芸術**: タイル装飾（ゼリージュ）
        - **音楽**: アンダルシア音楽
        - **都市**: フェズ、ティトゥアン等
        """)
    
    # 言語と宗教
    st.markdown("#### 🗣️ 言語と宗教")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **公用語**
        - **アラビア語**: 公用語、行政・教育で使用
        - **タマジグト語**: ベルベル語、2011年に公用語化
        
        **その他の言語**
        - **フランス語**: 旧宗主国言語、ビジネスで広く使用
        - **スペイン語**: 北部地域で使用
        - **英語**: 観光業・国際ビジネスで増加傾向
        """)
    
    with col2:
        st.markdown("""
        **宗教**
        - **イスラム教**: 人口の99%（スンニ派）
        - **国王**: 「信者の長（アミール・アル・ムウミニーン）」の称号
        - **宗教的寛容**: キリスト教、ユダヤ教も保護
        - **スーフィズム**: 神秘主義的イスラムの伝統
        - **モラビト**: 聖者廟崇拝の文化
        """)

def show_architecture_section():
    """建築セクション"""
    st.markdown("### 🏛️ モロッコ建築の至宝")
    
    st.write("""
    モロッコ建築は、**イスラム建築**の最高峰の一つとして世界的に評価されています。
    精巧な装飾技術、数学的な幾何学模様、そして機能美を兼ね備えた傑作が数多く残されています。
    """)
    
    # 建築様式
    st.markdown("#### 🏗️ 主要建築様式")
    
    tab1, tab2, tab3, tab4 = st.tabs(["ムーア建築", "アルモハード様式", "マリーン様式", "アラウィー様式"])
    
    with tab1:
        st.markdown("""
        #### 🕌 ムーア建築（8-15世紀）
        **特徴:**
        - 馬蹄形アーチ
        - 複雑な幾何学模様
        - アラベスク装飾
        - 中庭（パティオ）中心の設計
        
        **代表例:**
        - アルハンブラ宮殿（スペイン）
        - フェズ・エル・バリの住宅群
        - ティトゥアンの旧市街
        """)
    
    with tab2:
        st.markdown("""
        #### 🏛️ アルモハード様式（12-13世紀）
        **特徴:**
        - 巨大で荘厳な建築物
        - 簡潔で力強いデザイン
        - 高い正方形のミナレット
        - 赤砂岩の使用
        
        **代表例:**
        - クトゥビア・モスク（マラケシュ）
        - ハッサンの塔（ラバト）
        - ヒラルダの塔（セビリア、スペイン）
        """)
    
    with tab3:
        st.markdown("""
        #### 🎨 マリーン様式（13-15世紀）
        **特徴:**
        - 極めて精巧な装飾
        - ムカルナス（鍾乳石装飾）の発達
        - カリグラフィーの多用
        - ゼリージュ（色タイル）の完成
        
        **代表例:**
        - ボウ・イナニア・マドラサ（フェズ）
        - アッタリーン・マドラサ（フェズ）
        - アルハンブラ宮殿の増築部分
        """)
    
    with tab4:
        st.markdown("""
        #### 👑 アラウィー様式（17世紀～現在）
        **特徴:**
        - 古典様式の復活と発展
        - 宮殿建築の隆盛
        - 現代技術との融合
        - 国際的影響の取り入れ
        
        **代表例:**
        - バイア宮殿（マラケシュ）
        - ハッサン2世モスク（カサブランカ）
        - 王宮群（ラバト、フェズ、マラケシュ、メクネス）
        """)
    
    # 装飾技術
    st.markdown("#### 🎨 モロッコ装飾芸術の技法")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        **ゼリージュ（色タイル装飾）**
        - 幾何学模様のモザイクタイル
        - 主な色：白、青、緑、黄、茶
        - 数学的精密性
        - フェズが生産中心地
        """)
    
    with col2:
        st.markdown("""
        **タドラクト（モロッコ漆喰）**
        - 石灰と石鹸で磨いた壁面仕上げ
        - 防水性と光沢
        - ハマム（浴場）に多用
        - マラケシュ伝統の技法
        """)
    
    with col3:
        st.markdown("""
        **木工細工（メヌイジェリ）**
        - 精密な木材象嵌
        - 幾何学・植物モチーフ
        - シダー材の使用
        - 天井、扉、窓格子に使用
        """)

def show_cuisine_section():
    """グルメセクション"""
    st.markdown("### 🍽️ モロッコ料理の世界")
    
    st.write("""
    モロッコ料理は、**地中海**、**アラブ**、**ベルベル**、**アンダルシア**、**アフリカ**の食文化が融合した、
    世界で最も洗練された料理の一つです。スパイスの芸術的な使い方で知られています。
    """)
    
    # 代表料理
    st.markdown("#### 🥘 代表的なモロッコ料理")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        #### 🍲 タジン（Tajine）
        **特徴:**
        - 円錐形の蓋付き土鍋で調理
        - 蒸し煮による素材の旨味凝縮
        - 肉、野菜、果物の絶妙な組み合わせ
        
        **人気の種類:**
        - **鶏肉とレモンのタジン**: 国民的料理
        - **牛肉とプルーンのタジン**: 甘みとスパイスの調和
        - **野菜タジン**: ベジタリアン対応
        - **魚のタジン**: 沿岸部の特産
        """)
        
        st.markdown("""
        #### 🍚 クスクス（Couscous）
        **特徴:**
        - セモリナ粉から作る粒状パスタ
        - 金曜日の家庭料理として定着
        - 蒸し器で丁寧に調理
        
        **バリエーション:**
        - **野菜クスクス**: 7種の野菜使用
        - **肉クスクス**: ラムや鶏肉と
        - **魚クスクス**: 沿岸部の名物
        - **甘いクスクス**: デザート用
        """)
    
    with col2:
        st.markdown("""
        #### 🥣 ハリラ（Harira）
        **特徴:**
        - トマトベースの栄養豊富なスープ
        - ラマダン月の断食明けに必須
        - レンズ豆、ひよこ豆、米入り
        
        **文化的意義:**
        - 家族の絆を深める料理
        - 地域により味付けが異なる
        - 冬の定番料理
        """)
        
        st.markdown("""
        #### 🥖 モロッコパン
        **種類:**
        - **ホブズ**: 円形の日常パン
        - **バゲット**: フランス統治時代の名残
        - **ムスメン**: 薄く延ばした層状パン
        - **バグリル**: セモリナ粉のパン
        
        **特徴:**
        - 毎食必須のアイテム
        - 地域の小麦粉使用
        - 共同オーブンでの焼成
        """)
    
    # 飲み物文化
    st.markdown("#### 🫖 モロッコの飲み物文化")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        **アタイ（ミントティー）**
        - モロッコの国民的飲み物
        - 緑茶＋ミント＋砂糖
        - おもてなしの象徴
        - 高い位置から注ぐ芸術的所作
        - 1日何度でも飲む習慣
        """)
    
    with col2:
        st.markdown("""
        **フレッシュジュース**
        - オレンジジュース（最も人気）
        - ザクロジュース（健康効果）
        - アボカドジュース（栄養満点）
        - キャロットジュース（ビタミン豊富）
        - 街角の屋台で絞りたて提供
        """)
    
    with col3:
        st.markdown("""
        **コーヒー文化**
        - **カフェ・オ・レ**: フランス式
        - **カフェ・ノワール**: エスプレッソ
        - **カフェ・カッスィール**: 濃いコーヒー
        - カフェ文化はフランス統治時代から
        - 男性の社交場として重要
        """)

def show_traditions_section():
    """伝統セクション"""
    st.markdown("### 🎭 モロッコの伝統と習慣")
    
    # 音楽と舞踊
    st.markdown("#### 🎵 音楽と舞踊")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        #### 🥁 グナワ音楽
        **起源と特徴:**
        - サハラ以南アフリカからの奴隷文化
        - 宗教的・治療的音楽
        - トランス状態を誘発
        - カルカバ（金属カスタネット）使用
        
        **楽器:**
        - **ゲンブリ**: ベース弦楽器
        - **カルカバ**: 金属製響器
        - **ダルブッカ**: ゴブレット型太鼓
        
        **現代への影響:**
        - ジャズとの融合
        - 国際的な評価
        - エッサウィラ・グナワ音楽祭
        """)
    
    with col2:
        st.markdown("""
        #### 🎶 アンダルシア音楽
        **歴史:**
        - 15世紀スペインからの移民が伝承
        - アラブ・アンダルシア古典音楽
        - 宮廷音楽としての発展
        
        **特徴:**
        - 複雑な旋律とリズム
        - 詩的な歌詞
        - 多楽器による合奏
        
        **主要楽器:**
        - **ウード**: リュート族弦楽器
        - **カーヌーン**: ツィター族
        - **ダフ**: フレームドラム
        - **ナイ**: 葦笛
        """)
    
    # 工芸と職人技
    st.markdown("#### 🎨 伝統工芸と職人技")
    
    tab1, tab2, tab3, tab4 = st.tabs(["絨毯・織物", "陶器・金属工芸", "革製品", "木工・石工"])
    
    with tab1:
        st.markdown("""
        #### 🧶 絨毯・織物
        **ベルベル絨毯:**
        - 各部族固有の模様と色彩
        - 羊毛を天然染料で染色
        - 家族の歴史を織り込む
        - アトラス山脈の村々が産地
        
        **都市型絨毯:**
        - ペルシャ様式の影響
        - 絹を使用した高級品
        - 幾何学・植物模様
        - ラバト、サレが有名
        """)
    
    with tab2:
        st.markdown("""
        #### 🏺 陶器・金属工芸
        **フェズ陶器:**
        - 青と白の美しい配色
        - コバルトブルーが特徴
        - 14世紀から続く伝統
        - 実用性と芸術性の両立
        
        **金属工芸:**
        - 銅、真鍮、銀の加工
        - 透かし彫りの技術
        - ティーセット、トレイ製作
        - フェズ、メクネスが中心地
        """)
    
    with tab3:
        st.markdown("""
        #### 👜 革製品
        **特徴:**
        - 世界最高品質の革
        - 天然なめし技術
        - 伝統的な手作業
        - 1000年変わらぬ製法
        
        **主要産地:**
        - **フェズ**: 最高級品
        - **マラケシュ**: 観光客向け
        - **テトゥアン**: 北部の特色
        
        **製品:**
        - バブーシュ（革スリッパ）
        - バッグ、財布
        - 革ジャケット
        """)
    
    with tab4:
        st.markdown("""
        #### 🪵 木工・石工
        **木工芸:**
        - アトラス杉材使用
        - 象嵌技術（マルケッテリ）
        - 幾何学模様の精密加工
        - 家具、建築装飾
        
        **石工芸:**
        - 大理石、石灰岩加工
        - 噴水、柱の製作
        - アラベスク彫刻
        - 建築装飾の専門技術
        """)
    
    # 祭りと年中行事
    st.markdown("#### 🎉 祭りと年中行事")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **宗教的祭典:**
        - **ラマダン**: 断食月（イスラム暦9月）
        - **イード・アル=フィトル**: 断食明け祭
        - **イード・アル=アドハー**: 犠牲祭
        - **ムーリド**: 預言者誕生祭
        - **アーシューラー**: シーア派由来の祭典
        """)
    
    with col2:
        st.markdown("""
        **文化的祭典:**
        - **アーモンド花祭**: タフラウトの春祭り
        - **バラ祭**: ケラア・ムグナのバラ収穫祭
        - **グナワ音楽祭**: エッサウィラの音楽祭
        - **フェズ世界聖音楽祭**: 宗教音楽祭
        - **マラケシュ国際映画祭**: 映画祭
        """)

def show_ai_page(ai_service):
    """AI観光ガイドページ"""
    st.subheader("🤖 高精度AI観光ガイド")
    
    # 機能説明
    st.markdown("""
    **🧠 知識ベース搭載AI**
    - 40の観光地データと詳細な文化・歴史情報を内蔵
    - カテゴリ別専門応答（歴史、文化、料理、建築、旅行、気候、言語）
    - スマートキーワード分析による最適な回答生成
    """)
    
    # API状態の表示（セキュアな方法）
    col1, col2 = st.columns([3, 1])
    with col1:
        if ai_service['available']:
            st.success("✅ OpenAI API + 高精度知識ベース")
        else:
            st.info("🤖 高精度フォールバック応答システム")
    
    with col2:
        if ai_service['available']:
            st.info("🔑 OpenAI: 設定済み")
        else:
            st.warning("🔑 OpenAI: 未設定")
    
    # チャット履歴の初期化
    if "messages" not in st.session_state:
        st.session_state.messages = []
    
    # チャット履歴の表示
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    # おすすめ質問
    st.subheader("💡 おすすめの質問")
    suggestions = [
        "マラケシュのおすすめ観光地を教えて",
        "カサブランカで必見のスポットは？",
        "フェズの歴史について教えて",
        "サハラ砂漠ツアーのアドバイスをください",
        "モロッコ料理のおすすめは？"
    ]
    
    for i, suggestion in enumerate(suggestions):
        if st.button(suggestion, key=f"suggestion_{i}", use_container_width=True):
            st.session_state.messages.append({"role": "user", "content": suggestion})
            response = get_ai_response(suggestion, ai_service)
            st.session_state.messages.append({"role": "assistant", "content": response})
            st.rerun()
    
    # ユーザー入力
    if prompt := st.chat_input("モロッコについて何でも聞いてください！"):
        # ユーザーメッセージを追加
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)
        
        # AI応答を生成
        with st.chat_message("assistant"):
            response = get_ai_response(prompt, ai_service)
            st.markdown(response)
        
        # アシスタントメッセージを追加
        st.session_state.messages.append({"role": "assistant", "content": response})

def get_ai_response(prompt, ai_service):
    """AI応答を生成（高精度フォールバック対応）"""
    if ai_service['available']:
        try:
            # 実際のOpenAI APIを使用する場合の高精度プロンプト
            enhanced_prompt = create_enhanced_prompt(prompt, ai_service['knowledge_base'])
            # return call_openai_api(enhanced_prompt)
            pass
        except Exception as e:
            st.error(f"API呼び出しエラー: {str(e)}")
    
    # 高精度フォールバック応答
    return generate_smart_fallback_response(prompt, ai_service)

def create_enhanced_prompt(user_prompt, knowledge_base):
    """OpenAI API用の強化されたプロンプトを作成"""
    system_prompt = f"""あなたはモロッコ観光の専門ガイドです。以下の知識ベースに基づいて、正確で詳細な情報を提供してください。

【モロッコ基本情報】
国名: {knowledge_base['country_info']['name']}
首都: {knowledge_base['country_info']['capital']}
最大都市: {knowledge_base['country_info']['largest_city']}
人口: {knowledge_base['country_info']['population']}
言語: {', '.join(knowledge_base['country_info']['languages'])}
通貨: {knowledge_base['country_info']['currency']}
宗教: {knowledge_base['country_info']['religion']}

【文化的背景】
- ベルベル文化: {knowledge_base['cultural_context']['berber_heritage']}
- イスラム文化: {knowledge_base['cultural_context']['islamic_influence']}
- アンダルシア文化: {knowledge_base['cultural_context']['andalusian_legacy']}
- フランス植民地影響: {knowledge_base['cultural_context']['french_colonial']}

【旅行のベストシーズン】
春（3-5月): {knowledge_base['travel_tips']['best_seasons']['spring']}
夏（6-8月): {knowledge_base['travel_tips']['best_seasons']['summer']}
秋（9-11月): {knowledge_base['travel_tips']['best_seasons']['autumn']}
冬（12-2月): {knowledge_base['travel_tips']['best_seasons']['winter']}

回答は以下の形式で提供してください：
1. 簡潔な概要（1-2文）
2. 具体的な詳細情報
3. 実践的なアドバイス
4. 関連する文化的背景
5. 追加の推奨事項

日本語で、親しみやすく、かつ専門的な情報を提供してください。"""
    
    return f"{system_prompt}\n\n【ユーザーの質問】\n{user_prompt}"

def generate_smart_fallback_response(prompt, ai_service):
    """スマートフォールバック応答生成"""
    prompt_lower = prompt.lower()
    knowledge_base = ai_service['knowledge_base']
    fallback_responses = ai_service['fallback_responses']
    
    # キーワード分析
    keywords = analyze_prompt_keywords(prompt_lower)
    
    # 都市名検索
    for city, response in fallback_responses.items():
        if city.lower() in prompt_lower:
            return format_enhanced_response(response, keywords, knowledge_base)
    
    # カテゴリ別質問分析
    if any(word in prompt_lower for word in ['歴史', '歴史的', '王朝', '時代']):
        return generate_history_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['文化', '伝統', '習慣', '宗教']):
        return generate_culture_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['料理', 'グルメ', '食事', '食べ物', 'レストラン']):
        return generate_cuisine_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['建築', '建物', 'モスク', '宮殿']):
        return generate_architecture_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['旅行', '観光', 'ツアー', '行き方', 'アクセス']):
        return generate_travel_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['気候', '天気', '季節', 'ベストシーズン']):
        return generate_weather_response(keywords, knowledge_base)
    elif any(word in prompt_lower for word in ['言語', 'アラビア語', 'フランス語', 'ベルベル語']):
        return generate_language_response(keywords, knowledge_base)
    
    # 一般的な応答
    return fallback_responses.get('general', generate_default_response(knowledge_base))

def analyze_prompt_keywords(prompt):
    """プロンプトからキーワードを抽出"""
    keywords = {
        'cities': [],
        'activities': [],
        'interests': [],
        'time_related': [],
        'difficulty': []
    }
    
    # 都市名
    cities = ['マラケシュ', 'カサブランカ', 'フェズ', 'シャウエン', 'エッサウィラ', 'メルズーガ', 'ラバト', 'メクネス', 'タンジェ', 'ティトゥアン']
    for city in cities:
        if city.lower() in prompt:
            keywords['cities'].append(city)
    
    # アクティビティ
    activities = ['ラクダ', 'トレッキング', 'キャンプ', '砂漠', 'サーフィン', '写真', 'ショッピング', 'スパ']
    for activity in activities:
        if activity in prompt:
            keywords['activities'].append(activity)
    
    # 興味分野
    interests = ['建築', '歴史', '文化', '料理', '芸術', '音楽', '自然', '宗教']
    for interest in interests:
        if interest in prompt:
            keywords['interests'].append(interest)
    
    return keywords

def format_enhanced_response(base_response, keywords, knowledge_base):
    """基本応答を強化"""
    enhanced = f"🕌 {base_response}\n\n"
    
    # 実用情報の追加
    enhanced += "**📋 実用情報:**\n"
    enhanced += f"• 通貨: {knowledge_base['country_info']['currency']}\n"
    enhanced += f"• 言語: {', '.join(knowledge_base['country_info']['languages'])}\n"
    enhanced += f"• 時差: {knowledge_base['country_info']['time_zone']}\n\n"
    
    # 文化的エチケット
    enhanced += "**🤝 文化的エチケット:**\n"
    etiquette = knowledge_base['travel_tips']['cultural_etiquette']
    enhanced += f"• 挨拶: {etiquette['greetings']}\n"
    enhanced += f"• 服装: {etiquette['dress_code']}\n"
    enhanced += f"• 撮影: {etiquette['photography']}\n\n"
    
    enhanced += "詳しい情報については、マップや観光地一覧ページをご確認ください。"
    
    return enhanced

def generate_history_response(keywords, knowledge_base):
    """歴史関連の応答生成"""
    return """🏛️ **モロッコの歴史**

モロッコは豊かな歴史を持つ国で、以下の主要時代があります：

**� 古代・先史時代**
• ベルベル人（アマジグ人）が数千年前から居住
• ローマ帝国時代（42-429年）の遺跡が残存

**☪️ イスラム王朝時代**
• アルモラヴィ朝（1040-1147年）: マラケシュを首都
• アルモハード朝（1121-1269年）: 最大版図を築く
• マリーン朝（1244-1465年）: フェズで学問が栄える
• サーディアン朝（1549-1659年）: マラケシュで復活
• アラウィー朝（1666年-現在）: 現王朝

**🇫🇷 近現代**
• フランス保護領（1912-1956年）
• 1956年独立達成、ムハンマド5世が初代国王

**🏛️ 歴史を感じられる観光地**
• ヴォルビリス遺跡: ローマ時代
• フェズ・エル・バリ: イスラム中世都市
• サーディアン朝の墳墓群: 王朝時代の霊廟"""

def generate_culture_response(keywords, knowledge_base):
    """文化関連の応答生成"""
    return """🎨 **モロッコの文化**

モロッコの文化は4つの要素が融合した独特のものです：

**🌍 文化的要素**
• **ベルベル文化**: 北アフリカ先住民の伝統
• **アラブ・イスラム文化**: 7世紀以降の支配的文化
• **アンダルシア文化**: 15世紀スペインからの移民
• **アフリカ文化**: サハラ以南との交流

**🗣️ 言語**
• アラビア語（公用語）: 行政・教育
• タマジグト語（公用語）: ベルベル語、2011年制定
• フランス語: ビジネス・国際関係
• スペイン語: 北部地域

**☪️ 宗教**
• イスラム教スンニ派（99%）
• 国王は「信者の長」の称号
• 宗教的寛容性あり

**🎭 伝統芸能**
• グナワ音楽: アフリカ系宗教音楽
• アンダルシア音楽: 古典宮廷音楽
• ベルベル音楽: 部族の伝統音楽"""

def generate_cuisine_response(keywords, knowledge_base):
    """料理関連の応答生成"""
    return """🍽️ **モロッコ料理ガイド**

モロッコ料理は世界で最も洗練された料理の一つです：

**🥘 代表的料理**
• **タジン**: 円錐形土鍋の蒸し煮料理
  - 鶏肉とレモンのタジン（最も人気）
  - 牛肉とプルーンのタジン（甘みとスパイス）
  - 野菜タジン（ベジタリアン対応）

• **クスクス**: セモリナ粉の粒状パスタ
  - 金曜日の家庭料理として定着
  - 7種の野菜と肉の組み合わせ

• **ハリラ**: 栄養豊富なトマトスープ
  - ラマダン断食明けの定番
  - レンズ豆、ひよこ豆入り

**🫖 飲み物文化**
• **アタイ（ミントティー）**: 国民的飲み物
• **フレッシュジュース**: オレンジが最人気
• **カフェ文化**: フランス統治時代から

**🌶️ スパイス**
• ラス・エル・ハヌート: ミックススパイス
• サフラン: 高級香辛料
• ハリッサ: 辛味調味料

**🍴 食事マナー**
• 右手で食事
• パンで料理をすくう
• 食前食後の手洗い"""

def generate_architecture_response(keywords, knowledge_base):
    """建築関連の応答生成"""
    return """🏛️ **モロッコ建築の芸術**

モロッコはイスラム建築の最高峰を誇ります：

**🕌 建築様式**
• **ムーア建築（8-15世紀）**: 馬蹄形アーチ、幾何学模様
• **アルモハード様式（12-13世紀）**: 巨大で荘厳、高いミナレット
• **マリーン様式（13-15世紀）**: 極めて精巧な装飾
• **アラウィー様式（17世紀-現在）**: 古典様式の復活

**🎨 装飾技術**
• **ゼリージュ**: 幾何学モザイクタイル
• **タドラクト**: モロッコ伝統漆喰仕上げ
• **木工細工**: 精密な象嵌技術
• **ムカルナス**: 鍾乳石装飾

**🏛️ 代表建築**
• **宗教建築**: クトゥビア・モスク、ハッサン2世モスク
• **宮殿建築**: バイア宮殿、王宮群
• **学校建築**: ボウ・イナニア・マドラサ
• **要塞建築**: ウダイヤ・カスバ

**🎯 見学ポイント**
• タイル装飾の数学的精密性
• 光と影の計算された美学
• 中庭を中心とした空間構成
• イスラム文様の意味と象徴"""

def generate_travel_response(keywords, knowledge_base):
    """旅行関連の応答生成"""
    practical = knowledge_base['travel_tips']['practical_info']
    return f"""✈️ **モロッコ旅行ガイド**

**📋 基本情報**
• ビザ: {practical['visa']}
• 健康: {practical['health']}
• 安全: {practical['safety']}
• インターネット: {practical['internet']}
• 交通: {practical['transportation']}

**🌡️ ベストシーズン**
• **春（3-5月）**: 温暖で観光に最適
• **秋（9-11月）**: 過ごしやすく観光シーズン
• **夏（6-8月）**: 沿岸部は涼しい、内陸部は酷暑
• **冬（12-2月）**: 温和、山間部は寒い

**🎯 旅行スタイル別おすすめ**
• **文化重視**: フェズ、マラケシュ、メクネス
• **自然体験**: メルズーガ（砂漠）、シャウエン（山間）
• **リゾート**: エッサウィラ、アガディール
• **現代都市**: カサブランカ、ラバト

**💰 予算目安（1日あたり）**
• バックパッカー: 3,000-5,000円
• 中級旅行: 8,000-15,000円
• 高級旅行: 20,000円以上

**🎒 持参推奨品**
• 日焼け止め、帽子（強い日差し対策）
• 長袖シャツ（宗教施設・砂漠用）
• 歩きやすい靴（石畳の道）
• 現金（カード使用制限あり）"""

def generate_weather_response(keywords, knowledge_base):
    """天気関連の応答生成"""
    seasons = knowledge_base['travel_tips']['best_seasons']
    return f"""🌤️ **モロッコの気候・天気**

**📅 季節別ガイド**
• **春（3-5月）**: {seasons['spring']}
• **夏（6-8月）**: {seasons['summer']}
• **秋（9-11月）**: {seasons['autumn']}
• **冬（12-2月）**: {seasons['winter']}

**🗺️ 地域別気候**
• **沿岸部**: 地中海性気候、年中温和
• **内陸部**: 大陸性気候、昼夜の寒暖差大
• **アトラス山脈**: 高山気候、冬は雪
• **サハラ砂漠**: 乾燥気候、日中は酷暑、夜は寒冷

**🌡️ 月別平均気温（マラケシュ）**
• 1月: 6-18℃ • 7月: 19-37℃
• 4月: 11-24℃ • 10月: 15-28℃

**👕 服装アドバイス**
• **春・秋**: 軽装+羽織物
• **夏**: 薄手の長袖（日焼け防止）
• **冬**: セーター、ジャケット
• **砂漠**: 昼夜の寒暖差対策

**☔ 降水量**
• 雨季: 11月-3月（主に沿岸部）
• 乾季: 4月-10月
• 年間降水量: 300-800mm（地域差大）"""

def generate_language_response(keywords, knowledge_base):
    """言語関連の応答生成"""
    languages = knowledge_base['country_info']['languages']
    etiquette = knowledge_base['travel_tips']['cultural_etiquette']
    return f"""🗣️ **モロッコの言語事情**

**�️ 公用語**
• **アラビア語**: 行政、教育、宗教で使用
• **タマジグト語（ベルベル語）**: 2011年に公用語化

**🌍 その他の主要言語**
• **フランス語**: ビジネス、高等教育で広く使用
• **スペイン語**: 北部地域（旧スペイン領）
• **英語**: 観光業、国際ビジネスで増加傾向

**👋 基本的な挨拶**
• **アラビア語**:
  - こんにちは: アッサラーム・アライクム
  - ありがとう: シュクラン
  - はい/いいえ: ナアム / ラー

• **フランス語**:
  - こんにちは: Bonjour（ボンジュール）
  - ありがとう: Merci（メルシー）
  - すみません: Excusez-moi（エクスキューゼ・モワ）

• **ベルベル語（タマジグト）**:
  - こんにちは: アズール
  - ありがとう: タヌミルト

**💡 旅行者向けアドバイス**
• 観光地では英語・フランス語が通じる
• タクシーや市場では価格交渉が必要
• 宗教的挨拶（アッサラーム・アライクム）は親しみやすさを示す
• ジェスチャーや笑顔でコミュニケーション可能

**📱 便利なアプリ**
• Google翻訳（オフライン対応）
• 指差し会話帳
• アラビア語・フランス語学習アプリ"""

def generate_default_response(knowledge_base):
    """デフォルト応答生成"""
    country_info = knowledge_base['country_info']
    return f"""🕌 **モロッコ王国へようこそ！**

**🌍 基本情報**
• 正式名称: {country_info['name']}
• 首都: {country_info['capital']}
• 最大都市: {country_info['largest_city']}
• 人口: {country_info['population']}
• 面積: {country_info['area']}
• 言語: {', '.join(country_info['languages'])}
• 通貨: {country_info['currency']}
• 宗教: {country_info['religion']}

**🏛️ 主要観光都市（10都市・40観光地）**
• マラケシュ: 「赤い街」帝国都市
• カサブランカ: 経済の中心都市
• フェズ: 1200年の歴史を持つ古都
• シャウエン: 「青い真珠」山間の町
• エッサウィラ: 「風の街」大西洋沿岸

**🎨 文化的特徴**
• アラブ、ベルベル、アンダルシア、アフリカ文化の融合
• 世界有数のイスラム建築
• 洗練されたモロッコ料理
• 伝統工芸の宝庫

**💡 おすすめ体験**
• サハラ砂漠でのラクダトレッキング
• 伝統的なリヤドホテル宿泊
• スークでのお土産探し
• ハマム（モロッコ式スパ）体験

詳しい観光地情報は、マップページや観光地一覧ページをご確認ください！"""

def show_settings_page():
    """設定ページ"""
    st.subheader("⚙️ 設定")
    
    st.markdown("### 🎨 外観設定")
    
    # テーマ設定
    current_theme = st.session_state.get("theme", "ライト")
    theme_index = 0 if current_theme == "ライト" else 1
    
    new_theme = st.selectbox(
        "🌙 テーマ", 
        ["ライト", "ダーク"], 
        index=theme_index,
        help="アプリケーションの外観テーマを選択してください"
    )
    
    # テーマ変更の処理
    if new_theme != current_theme:
        st.session_state.theme = new_theme
        st.success(f"✅ テーマを「{new_theme}」に変更しました")
        st.info("💡 変更が即座に適用されました。他のページでもテーマが反映されます")
        st.balloons()  # テーマ変更を祝う
        st.rerun()
    
    # テーマプレビュー
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("#### 🌞 ライトテーマ")
        st.markdown("""
        <div style="background: white; border: 1px solid #ddd; padding: 1rem; border-radius: 8px; color: black;">
            <h5 style="color: #2c3e50;">モロッコ観光ガイド</h5>
            <p style="color: #7f8c8d;">明るく見やすいライトテーマ</p>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown("#### 🌙 ダークテーマ")
        st.markdown("""
        <div style="background: #2d2d2d; border: 1px solid #444; padding: 1rem; border-radius: 8px; color: white;">
            <h5 style="color: white;">モロッコ観光ガイド</h5>
            <p style="color: #cccccc;">目に優しいダークテーマ</p>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("### 🔧 アプリケーション設定")
    
    # 言語設定
    language = st.selectbox("🌐 言語 / Language", ["日本語", "English"], index=0, 
                           help="アプリケーションの表示言語を選択してください（現在は日本語のみ対応）")
    
    # API設定
    st.markdown("### 🔑 API設定")
    
    # 環境変数からAPIキーの存在を確認
    api_key_status = bool(os.getenv('OPENAI_API_KEY'))
    
    if api_key_status:
        st.success("✅ OpenAI APIキーが設定されています")
        st.info("💡 APIキーは環境変数 `OPENAI_API_KEY` から読み込まれます")
        st.markdown("**🎯 利用可能機能:** OpenAI GPT + 詳細知識ベース + スマート分析")
    else:
        st.warning("⚠️ OpenAI APIキーが設定されていません")
        st.info("💡 AI機能を使用するには、環境変数 `OPENAI_API_KEY` を設定してください")
        st.markdown("**🤖 現在の機能:** 高精度フォールバック応答システム（知識ベース内蔵）")
    
    st.markdown("**セキュリティのため、APIキーは表示されません**")
    
    if st.button("API接続をテスト"):
        if api_key_status:
            st.info("🔄 API接続をテスト中...")
            # 実際のテストは実装しない（セキュリティ上の理由）
            st.success("✅ APIキーが設定されています（接続テストは実装されていません）")
        else:
            st.error("❌ APIキーが設定されていません")
    
    # セキュリティ情報
    st.markdown("### 🔒 セキュリティ情報")
    st.info("""
    **プライバシー保護:**
    - APIキーは環境変数から安全に読み込まれます
    - APIキーは画面に表示されません
    - ユーザーデータは保存されません
    - チャット履歴はセッション終了時にクリアされます
    """)
    
    # テーマ管理セクション
    st.markdown("### 🎨 テーマ管理")
    
    # 現在のテーマ状態
    current_theme = st.session_state.get("theme", "ライト")
    theme_emoji = "🌞" if current_theme == "ライト" else "🌙"
    
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown(f"""
        <div style="text-align: center; padding: 1rem; border-radius: 10px; 
                    background: {'linear-gradient(90deg, #f8f9fa, #e9ecef)' if current_theme == 'ライト' else 'linear-gradient(90deg, #2d2d2d, #3a3a3a)'}; 
                    border: 1px solid {'#dee2e6' if current_theme == 'ライト' else '#444'};">
            <h3>{theme_emoji} {current_theme}テーマ</h3>
            <p>現在適用中</p>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    # テーマ切り替えボタン
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("🌞 ライトテーマに切り替え", 
                    use_container_width=True,
                    disabled=(current_theme == "ライト"),
                    help="明るい背景のライトテーマに変更します"):
            st.session_state.theme = "ライト"
            st.success("✅ ライトテーマに変更しました")
            st.rerun()
    
    with col2:
        if st.button("🌙 ダークテーマに切り替え", 
                    use_container_width=True,
                    disabled=(current_theme == "ダーク"),
                    help="暗い背景のダークテーマに変更します"):
            st.session_state.theme = "ダーク"
            st.success("✅ ダークテーマに変更しました")
            st.rerun()
    
    # テーマリセット
    if st.button("🔄 デフォルトテーマにリセット", help="ライトテーマにリセットします"):
        st.session_state.theme = "ライト"
        st.info("🔄 テーマをライトテーマにリセットしました")
        st.rerun()
    
    # テーマ設定情報
    st.markdown("### 📖 テーマ機能について")
    
    tab1, tab2 = st.tabs(["🌞 ライトテーマ", "🌙 ダークテーマ"])
    
    with tab1:
        st.markdown("""
        **🌞 ライトテーマの特徴:**
        - ✨ 明るい背景で昼間の使用に最適
        - 📖 高いコントラストで文字が読みやすい
        - 🌐 従来のWebサイトに近い表示
        - ⚡ 屋外や明るい環境での視認性が良好
        - 🎨 クリーンで清潔感のあるデザイン
        """)
        
        st.success("**推奨環境:** 昼間・明るい室内・屋外での使用")
    
    with tab2:
        st.markdown("""
        **🌙 ダークテーマの特徴:**
        - 👁️ 暗い背景で目の疲労を軽減
        - 🌃 夜間や暗い環境での使用に最適
        - 🔋 バッテリー消費を抑制（OLED画面）
        - 💻 モダンで洗練されたデザイン
        - 🎯 集中力を高める効果
        """)
        
        st.info("**推奨環境:** 夜間・暗い室内・長時間の作業時")
    
    # システム診断
    st.markdown("### 🔍 システム診断")
    
    if st.button("🏥 システムヘルスチェック", help="アプリケーションの動作状況を確認します"):
        with st.spinner("診断中..."):
            # データ読み込みテスト
            try:
                spots = load_spots_data()
                if spots:
                    st.success(f"✅ データ読み込み正常 ({len(spots)}箇所)")
                else:
                    st.error("❌ データ読み込み失敗")
            except Exception as e:
                st.error(f"❌ データ読み込みエラー: {str(e)}")
            
            # 必須ライブラリテスト
            try:
                import streamlit as st_test
                import folium as folium_test
                import pandas as pd_test
                st.success("✅ 必須ライブラリ正常")
            except Exception as e:
                st.error(f"❌ ライブラリエラー: {str(e)}")
            
            # セッション状態テスト
            if 'theme' in st.session_state:
                st.success(f"✅ セッション状態正常 (テーマ: {st.session_state.theme})")
            else:
                st.warning("⚠️ セッション状態未初期化")
            
            # URLパラメータテスト
            params = st.query_params
            if params:
                st.info(f"ℹ️ URLパラメータ: {dict(params)}")
            else:
                st.success("✅ URLパラメータクリア")
    
    # アプリ情報
    st.markdown("### ℹ️ アプリケーション情報")
    st.write("**バージョン:** 1.4.0")
    st.write("**作成日:** 2025年11月7日")
    st.write("**最終更新:** 2025年11月10日")
    st.write("**フレームワーク:** Streamlit")
    st.write("**観光地データ:** 40箇所")
    st.write("**対象都市:** 10都市")
    st.write("**セキュリティ:** APIキー非表示対応")
    st.write("**外観:** ライト・ダークテーマ対応")
    st.write("**エラーハンドリング:** 高度な例外処理対応")
    st.write("**パフォーマンス:** ログ記録・測定機能付き")
    st.write("**機能:** インタラクティブマップ、高精度AI観光ガイド、詳細検索、文化・歴史ページ")

if __name__ == "__main__":
    try:
        # テーマ初期化
        init_theme()
        # メイン関数実行
        main()
    except Exception as e:
        st.error(f"❌ アプリケーション初期化エラー: {str(e)}")
        st.info("🔄 ページを再読み込みしてください")
        with st.expander("🔍 エラー詳細"):
            st.code(traceback.format_exc())