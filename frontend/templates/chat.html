{% extends "base.html" %}

{% block title %}AIè¦³å…‰æ¡ˆå†… - ãƒ¢ãƒ­ãƒƒã‚³è¦³å…‰ã‚¬ã‚¤ãƒ‰{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-robot text-primary"></i> AIè¦³å…‰æ¡ˆå†…ãƒãƒ£ãƒƒãƒˆ</h4>
                <p class="mb-0 text-muted">ãƒ¢ãƒ­ãƒƒã‚³ã®è¦³å…‰ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„</p>
            </div>
            <div class="card-body">
                <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message bot">
                        <strong>ğŸ¤– AIæ¡ˆå†…:</strong><br>
                        <div class="formatted-response">
                            <h4>ğŸ‡²ğŸ‡¦ Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… (ã‚¢ãƒƒã‚µãƒ©ãƒ¼ãƒ ãƒ»ã‚¢ãƒ©ã‚¤ã‚¯ãƒ ) ã“ã‚“ã«ã¡ã¯ï¼</h4>
                            <p>ç§ã¯ã‚ãªãŸå°‚ç”¨ã®ãƒ¢ãƒ­ãƒƒã‚³è¦³å…‰ã‚¬ã‚¤ãƒ‰ã€Œãƒãƒƒã‚µãƒ³ã€ã§ã™âœ¨<br>
                            20å¹´ä»¥ä¸Šãƒ¢ãƒ­ãƒƒã‚³å…¨åœŸã‚’ã”æ¡ˆå†…ã—ã¦ããŸçµŒé¨“ã‚’æ´»ã‹ã—ã€æœ€é«˜ã®æ—…ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ï¼</p>
                            <h5>ğŸ—ºï¸ ä»Šæ—¥ã¯ã©ã‚“ãªã“ã¨ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ</h5>
                            <ul>
                                <li><strong>éƒ½å¸‚æ¡ˆå†…</strong> - ãƒãƒ©ã‚±ã‚·ãƒ¥ã€ãƒ•ã‚§ã‚ºã€ã‚·ãƒ£ã‚¦ã‚¨ãƒ³ã€ã‚µãƒãƒ©ç ‚æ¼ </li>
                                <li><strong>ã‚°ãƒ«ãƒ¡æƒ…å ±</strong> - æœ¬å ´ã®ã‚¿ã‚¸ãƒ³ã€éš ã‚ŒãŸååº—ã€å±‹å°ã‚°ãƒ«ãƒ¡</li>
                                <li><strong>æ—…è¡Œè¨ˆç”»</strong> - ãƒ™ã‚¹ãƒˆãƒ«ãƒ¼ãƒˆã€äºˆç®—ç›¸è«‡ã€å­£ç¯€ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</li>
                                <li><strong>æ–‡åŒ–ä½“é¨“</strong> - ãƒ™ãƒ«ãƒ™ãƒ«æ–‡åŒ–ã€ã‚¤ã‚¹ãƒ©ãƒ æ–‡åŒ–ã€ä¼çµ±å·¥èŠ¸</li>
                            </ul>
                            <p><strong>é æ…®ãªãä½•ã§ã‚‚ãŠèããã ã•ã„ï¼</strong> ğŸ˜Š</p>
                        </div>
                    </div>
                </div>
                
                <!-- ææ¡ˆãƒœã‚¿ãƒ³ -->
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted fw-bold">ğŸ’¡ ãŠã™ã™ã‚ã®è³ªå•:</small>
                            <div class="chat-suggestions mt-2" id="popularSuggestions">
                                <!-- äººæ°—ã®è³ªå• -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted fw-bold">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ã«æ¢ã™:</small>
                            <div class="chat-suggestions mt-2" id="randomSuggestions">
                                <!-- ãƒ©ãƒ³ãƒ€ãƒ è³ªå• -->
                            </div>
                            <button class="btn btn-outline-info btn-sm mt-2" onclick="loadRandomSuggestions()">
                                <i class="fas fa-sync-alt"></i> ä»–ã®è³ªå•ã‚’è¦‹ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="mt-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="ä¾‹ï¼šãƒãƒ©ã‚±ã‚·ãƒ¥ã§ãŠã™ã™ã‚ã®ãƒªãƒ¤ãƒ‰ã¯ï¼Ÿ" onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i> é€ä¿¡
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i> 
                        ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ç›´æ¥è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allSuggestions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSuggestions();
});

async function loadSuggestions() {
    try {
        const response = await fetch('/api/chat/suggestions');
        const data = await response.json();
        
        if (data.success) {
            allSuggestions = data.suggestions;
            displayPopularSuggestions();
            loadRandomSuggestions();
        }
    } catch (error) {
        console.error('ææ¡ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
    }
}

function displayPopularSuggestions() {
    const container = document.getElementById('popularSuggestions');
    container.innerHTML = '';
    
    // äººæ°—ã®è³ªå•ï¼ˆæœ€åˆã®6å€‹ï¼‰
    const popularQuestions = allSuggestions.slice(0, 6);
    
    popularQuestions.forEach(suggestion => {
        const button = createSuggestionButton(suggestion);
        container.appendChild(button);
    });
}

function loadRandomSuggestions() {
    const container = document.getElementById('randomSuggestions');
    container.innerHTML = '';
    
    // ãƒ©ãƒ³ãƒ€ãƒ ã«6å€‹é¸æŠï¼ˆäººæ°—ã®è³ªå•ä»¥å¤–ã‹ã‚‰ï¼‰
    const otherSuggestions = allSuggestions.slice(6);
    const randomSuggestions = getRandomElements(otherSuggestions, 6);
    
    randomSuggestions.forEach(suggestion => {
        const button = createSuggestionButton(suggestion);
        container.appendChild(button);
    });
}

function createSuggestionButton(suggestion) {
    const button = document.createElement('button');
    button.className = 'btn btn-outline-primary btn-sm mb-2 me-2';
    button.textContent = suggestion;
    button.style.cssText = 'font-size: 0.75rem; border-radius: 20px; padding: 0.4rem 0.8rem;';
    button.onclick = () => {
        document.getElementById('messageInput').value = suggestion;
        sendMessage();
    };
    return button;
}

function getRandomElements(array, count) {
    const shuffled = [...array].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessageToChat(message, 'user');
    messageInput.value = '';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<div class="loading"></div>';
    
    try {
        // AIã«é€ä¿¡
        const response = await fetch('/api/chat/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // AIå¿œç­”ã‚’è¡¨ç¤º
            addMessageToChat(data.response, 'bot');
        } else {
            addMessageToChat('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
        }
    } catch (error) {
        console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        addMessageToChat('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'bot');
    } finally {
        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> é€ä¿¡';
    }
}

function addMessageToChat(message, type) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    
    if (type === 'user') {
        messageDiv.innerHTML = `<strong>ğŸ«µ ã‚ãªãŸ:</strong><br>${escapeHtml(message)}`;
    } else {
        const formattedMessage = formatBotResponse(message);
        messageDiv.innerHTML = `<strong>ğŸ¤– AIæ¡ˆå†…:</strong><br><div class="formatted-response">${formattedMessage}</div>`;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function formatBotResponse(message) {
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’æœ€åˆã«å®Ÿè¡Œ
    let formatted = escapeHtml(message);
    
    // Markdownãƒ©ã‚¤ã‚¯ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°
    
    // çµµæ–‡å­—ä»˜ããƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ**ğŸŒŸ ãƒ†ã‚­ã‚¹ãƒˆ** â†’ h4ï¼‰
    formatted = formatted.replace(/\*\*([ğŸŒŸğŸ¯ğŸ—ºï¸ğŸ›ï¸ğŸ½ï¸ğŸš…ğŸ’°ğŸ“…ğŸ›¡ï¸ğŸ‡²ğŸ‡¦ğŸŒ¡ï¸ğŸ•ŒğŸ­ğŸ”ğŸ“ğŸ¨ğŸªğŸ€ğŸŒ™ğŸŠ].*?)\*\*/g, '<h4>$1</h4>');
    
    // é€šå¸¸ã®ãƒœãƒ¼ãƒ«ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ**ãƒ†ã‚­ã‚¹ãƒˆ:** â†’ h5ï¼‰
    formatted = formatted.replace(/\*\*([^ğŸ¯ğŸ—ºï¸ğŸ›ï¸ğŸ½ï¸ğŸš…ğŸ’°ğŸ“…ğŸ›¡ï¸ğŸ‡²ğŸ‡¦ğŸŒ¡ï¸ğŸ•ŒğŸ­ğŸ”ğŸ“ğŸ¨ğŸªğŸ€ğŸŒ™ğŸŠ]*?):\*\*/g, '<h5>$1:</h5>');
    
    // æ®‹ã‚Šã®ãƒœãƒ¼ãƒ«ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ**ãƒ†ã‚­ã‚¹ãƒˆ** â†’ strongï¼‰
    formatted = formatted.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    
    // ç®‡æ¡æ›¸ãï¼ˆâ€¢ ãƒ†ã‚­ã‚¹ãƒˆ â†’ liï¼‰
    formatted = formatted.replace(/^â€¢ (.+?)$/gm, '<li>$1</li>');
    
    // é€£ç¶šã™ã‚‹liã‚¿ã‚°ã‚’ulã§å›²ã‚€
    formatted = formatted.replace(/(<li>.*?<\/li>)(?:\n<li>.*?<\/li>)*/g, function(match) {
        return '<ul>' + match.replace(/\n/g, '') + '</ul>';
    });
    
    // æ•°å­—ä»˜ããƒªã‚¹ãƒˆï¼ˆ1. ãƒ†ã‚­ã‚¹ãƒˆ â†’ liï¼‰
    formatted = formatted.replace(/^(\d+)\. (.+?)$/gm, '<li>$2</li>');
    
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šï¼ˆè¤‡æ•°ã®æ”¹è¡Œã‚’åŒºåˆ‡ã‚Šã«å¤‰æ›ï¼‰
    formatted = formatted.replace(/\n\n\n+/g, '<div class="section-divider"></div>');
    
    // æ®µè½ï¼ˆäºŒé‡æ”¹è¡Œï¼‰
    formatted = formatted.replace(/\n\n/g, '</p><p>');
    formatted = '<p>' + formatted + '</p>';
    
    // å˜ä¸€æ”¹è¡Œã‚’brã«å¤‰æ›
    formatted = formatted.replace(/(?<!<\/[^>]+>)\n(?![<])/g, '<br>');
    
    // ç©ºã®æ®µè½ã‚’å‰Šé™¤
    formatted = formatted.replace(/<p><\/p>/g, '');
    formatted = formatted.replace(/<p>\s*<\/p>/g, '');
    
    // é‡è¦ãªæƒ…å ±ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆDHé€šè²¨ã€æ™‚é–“ã€æ¸©åº¦ãªã©ï¼‰
    formatted = formatted.replace(/(\d+(?:-\d+)?(?:DH|ãƒ‡ã‚£ãƒ«ãƒãƒ |å††|åº¦|æ™‚é–“|æ—¥é–“|Â°C))/g, '<span class="highlight">$1</span>');
    
    // æ™‚åˆ»ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    formatted = formatted.replace(/(\d{1,2}:\d{2}(?:-\d{1,2}:\d{2})?)/g, '<span class="highlight">$1</span>');
    
    // é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const keywords = ['ãŠã™ã™ã‚', 'ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³', 'æ³¨æ„', 'å¿…é ˆ', 'ã‚¬ã‚¤ãƒ‰ã®ã‚³ãƒ„', 'æ··é›‘å›é¿', 'ç¯€ç´„ã®ã‚³ãƒ„', 'æ’®å½±ãƒã‚¤ãƒ³ãƒˆ', 'ãŠã‚‚ã¦ãªã—'];
    keywords.forEach(keyword => {
        const regex = new RegExp(`(${keyword})`, 'gi');
        formatted = formatted.replace(regex, '<strong class="text-primary">$1</strong>');
    });
    
    return formatted;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}