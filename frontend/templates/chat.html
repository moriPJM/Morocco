{% extends "base.html" %}

{% block title %}AIè¦³å…‰æ¡ˆå†… - ãƒ¢ãƒ­ãƒƒã‚³è¦³å…‰ã‚¬ã‚¤ãƒ‰{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-robot text-primary"></i> AIè¦³å…‰æ¡ˆå†…ãƒãƒ£ãƒƒãƒˆ</h4>
                <p class="mb-0 text-muted">ãƒ¢ãƒ­ãƒƒã‚³ã®è¦³å…‰ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„</p>
            </div>
            <div class="card-body">
                <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message bot">
                        <strong>AIæ¡ˆå†…:</strong><br>
                        ã“ã‚“ã«ã¡ã¯ï¼ãƒ¢ãƒ­ãƒƒã‚³è¦³å…‰ã®AIæ¡ˆå†…ã§ã™ğŸ‡²ğŸ‡¦<br>
                        è¦³å…‰åœ°ã€æ–‡åŒ–ã€æ°—å€™ã€äº¤é€šãªã©ã€ä½•ã§ã‚‚ãŠèããã ã•ã„ï¼
                    </div>
                </div>
                
                <!-- ææ¡ˆãƒœã‚¿ãƒ³ -->
                <div class="mt-3">
                    <small class="text-muted">ã‚ˆãã‚ã‚‹è³ªå•:</small><br>
                    <div class="btn-group-vertical w-100 mt-2" id="suggestions">
                        <!-- å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                    </div>
                </div>
                
                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="mt-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i> é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSuggestions();
});

async function loadSuggestions() {
    try {
        const response = await fetch('/api/chat/suggestions');
        const data = await response.json();
        
        if (data.success) {
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.innerHTML = '';
            
            data.suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-secondary btn-sm mb-2';
                button.textContent = suggestion;
                button.onclick = () => {
                    document.getElementById('messageInput').value = suggestion;
                    sendMessage();
                };
                suggestionsContainer.appendChild(button);
            });
        }
    } catch (error) {
        console.error('ææ¡ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessageToChat(message, 'user');
    messageInput.value = '';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<div class="loading"></div>';
    
    try {
        // AIã«é€ä¿¡
        const response = await fetch('/api/chat/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // AIå¿œç­”ã‚’è¡¨ç¤º
            addMessageToChat(data.response, 'bot');
        } else {
            addMessageToChat('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
        }
    } catch (error) {
        console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        addMessageToChat('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'bot');
    } finally {
        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> é€ä¿¡';
    }
}

function addMessageToChat(message, type) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    
    if (type === 'user') {
        messageDiv.innerHTML = `<strong>ã‚ãªãŸ:</strong><br>${message}`;
    } else {
        messageDiv.innerHTML = `<strong>AIæ¡ˆå†…:</strong><br>${message}`;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}
</script>
{% endblock %}