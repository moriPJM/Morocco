{% extends "base.html" %}

{% block title %}お気に入り - モロッコ観光ガイド{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-heart text-danger"></i> お気に入りスポット</h2>
        <p class="lead">あなたが気になった観光スポットを保存して、旅行プランを立てましょう。</p>
        
        <!-- お気に入りが空の場合 -->
        <div id="emptyFavorites" class="text-center py-5" style="display: none;">
            <i class="fas fa-heart fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">まだお気に入りがありません</h4>
            <p class="text-muted">観光スポットページでハートマークをクリックして、気になる場所を保存しましょう。</p>
            <a href="{{ url_for('spots') }}" class="btn btn-primary">
                <i class="fas fa-map-marker-alt"></i> 観光スポットを見る
            </a>
        </div>
        
        <!-- お気に入り一覧 -->
        <div id="favoritesContainer">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="favoriteSearch" placeholder="お気に入りを検索...">
                        <button class="btn btn-outline-primary" onclick="searchFavorites()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success" onclick="createTravelPlan()">
                        <i class="fas fa-route"></i> 旅行プランを作成
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearAllFavorites()">
                        <i class="fas fa-trash"></i> すべて削除
                    </button>
                </div>
            </div>
            
            <div class="row" id="favoritesList">
                <!-- 動的に読み込み -->
            </div>
        </div>
        
        <!-- 統計情報 -->
        <div class="row mt-4" id="favoritesStats" style="display: none;">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary" id="totalFavorites">0</h3>
                        <p class="card-text">お気に入り数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success" id="totalCities">0</h3>
                        <p class="card-text">都市数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning" id="recommendedDays">0</h3>
                        <p class="card-text">推奨日数</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 旅行プラン作成モーダル -->
<div class="modal fade" id="travelPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-route"></i> 旅行プラン作成
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>選択した観光スポット</h6>
                        <div id="selectedSpotsList" class="border rounded p-3 mb-3">
                            <!-- 選択されたスポット一覧 -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>旅行設定</h6>
                        <form id="travelPlanForm">
                            <div class="mb-3">
                                <label class="form-label">旅行期間</label>
                                <select class="form-select" id="travelDuration">
                                    <option value="3">3-4日間</option>
                                    <option value="7" selected>7日間</option>
                                    <option value="10">10日間</option>
                                    <option value="14">2週間</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">旅行スタイル</label>
                                <select class="form-select" id="travelStyle">
                                    <option value="relaxed">ゆったり観光</option>
                                    <option value="standard" selected>標準的なペース</option>
                                    <option value="intensive">詰め込み型</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">予算レベル</label>
                                <select class="form-select" id="budgetLevel">
                                    <option value="budget">エコノミー</option>
                                    <option value="standard" selected>スタンダード</option>
                                    <option value="luxury">ラグジュアリー</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>おすすめプラン</h6>
                    <div id="generatedPlan" class="alert alert-info">
                        設定を選択して「プラン生成」ボタンを押してください。
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="generatePlan()">
                    <i class="fas fa-magic"></i> プラン生成
                </button>
                <button type="button" class="btn btn-success" onclick="savePlan()" id="savePlanBtn" style="display: none;">
                    <i class="fas fa-save"></i> プランを保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let favoriteSpots = [];
let allSpots = []; // 全スポットデータ

document.addEventListener('DOMContentLoaded', function() {
    loadFavorites();
    loadAllSpots();
});

function loadAllSpots() {
    // 実際のアプリでは /api/spots/ から取得
    allSpots = [
        {
            id: 1,
            name: 'ジャマ・エル・フナ広場',
            city: 'マラケシュ',
            category: '広場・市場',
            description: 'マラケシュの中心部にある賑やかな広場'
        },
        {
            id: 2,
            name: 'サハラ砂漠',
            city: 'メルズーガ',
            category: '自然',
            description: '世界最大の砂漠でのラクダツアー体験'
        },
        {
            id: 3,
            name: 'シャウエン',
            city: 'シャウエン',
            category: '都市・建築',
            description: '青い街として有名な美しい山間の町'
        }
    ];
}

function loadFavorites() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    favoriteSpots = allSpots.filter(spot => favorites.includes(spot.id.toString()));
    
    displayFavorites();
    updateStats();
}

function displayFavorites() {
    const container = document.getElementById('favoritesList');
    const emptyDiv = document.getElementById('emptyFavorites');
    const favoritesContainer = document.getElementById('favoritesContainer');
    
    if (favoriteSpots.length === 0) {
        emptyDiv.style.display = 'block';
        favoritesContainer.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    favoritesContainer.style.display = 'block';
    container.innerHTML = '';
    
    favoriteSpots.forEach(spot => {
        const spotCard = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">${spot.name}</h6>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite(${spot.id})">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        <p class="card-text text-muted small">
                            <i class="fas fa-map-marker-alt"></i> ${spot.city} · ${spot.category}
                        </p>
                        <p class="card-text">${spot.description}</p>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewSpotDetail(${spot.id})">
                                詳細
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += spotCard;
    });
}

function updateStats() {
    const statsDiv = document.getElementById('favoritesStats');
    
    if (favoriteSpots.length === 0) {
        statsDiv.style.display = 'none';
        return;
    }
    
    statsDiv.style.display = 'block';
    
    // 統計計算
    const totalCount = favoriteSpots.length;
    const cities = [...new Set(favoriteSpots.map(spot => spot.city))];
    const recommendedDays = Math.max(3, Math.min(14, totalCount * 1.5));
    
    document.getElementById('totalFavorites').textContent = totalCount;
    document.getElementById('totalCities').textContent = cities.length;
    document.getElementById('recommendedDays').textContent = Math.round(recommendedDays);
}

function removeFavorite(spotId) {
    if (confirm('このスポットをお気に入りから削除しますか？')) {
        app.removeFavorite(spotId.toString());
        loadFavorites();
    }
}

function clearAllFavorites() {
    if (confirm('すべてのお気に入りを削除しますか？この操作は取り消せません。')) {
        localStorage.setItem('favorites', '[]');
        loadFavorites();
    }
}

function searchFavorites() {
    const query = document.getElementById('favoriteSearch').value.toLowerCase();
    const filtered = favoriteSpots.filter(spot => 
        spot.name.toLowerCase().includes(query) ||
        spot.city.toLowerCase().includes(query) ||
        spot.description.toLowerCase().includes(query)
    );
    
    const container = document.getElementById('favoritesList');
    container.innerHTML = '';
    
    filtered.forEach(spot => {
        // displayFavorites()と同じカード生成ロジック
        const spotCard = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">${spot.name}</h6>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite(${spot.id})">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        <p class="card-text text-muted small">
                            <i class="fas fa-map-marker-alt"></i> ${spot.city} · ${spot.category}
                        </p>
                        <p class="card-text">${spot.description}</p>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewSpotDetail(${spot.id})">
                                詳細
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += spotCard;
    });
}

function createTravelPlan() {
    if (favoriteSpots.length === 0) {
        alert('お気に入りスポットを追加してから旅行プランを作成してください。');
        return;
    }
    
    // 選択したスポット一覧を表示
    const selectedList = document.getElementById('selectedSpotsList');
    selectedList.innerHTML = favoriteSpots.map(spot => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span><i class="fas fa-map-marker-alt text-primary"></i> ${spot.name}</span>
            <small class="text-muted">${spot.city}</small>
        </div>
    `).join('');
    
    const modal = new bootstrap.Modal(document.getElementById('travelPlanModal'));
    modal.show();
}

function generatePlan() {
    const duration = document.getElementById('travelDuration').value;
    const style = document.getElementById('travelStyle').value;
    const budget = document.getElementById('budgetLevel').value;
    
    // 簡単なプラン生成ロジック
    const cities = [...new Set(favoriteSpots.map(spot => spot.city))];
    const daysPerCity = Math.max(1, Math.floor(duration / cities.length));
    
    let planText = `**${duration}日間 ${getStyleText(style)}モロッコ旅行プラン**\n\n`;
    
    cities.forEach((city, index) => {
        const citySpots = favoriteSpots.filter(spot => spot.city === city);
        const startDay = index * daysPerCity + 1;
        const endDay = Math.min(startDay + daysPerCity - 1, duration);
        
        planText += `**第${startDay}${startDay !== endDay ? `-${endDay}` : ''}日目: ${city}**\n`;
        citySpots.forEach(spot => {
            planText += `• ${spot.name} - ${spot.description}\n`;
        });
        planText += '\n';
    });
    
    planText += `**予算レベル:** ${getBudgetText(budget)}\n`;
    planText += `**移動:** 鉄道・バス・タクシーを組み合わせ\n`;
    planText += `**宿泊:** ${budget === 'luxury' ? '高級リヤド・ホテル' : budget === 'budget' ? 'ゲストハウス・エコノミーホテル' : '中級リヤド・ホテル'}`;
    
    document.getElementById('generatedPlan').innerHTML = planText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    document.getElementById('savePlanBtn').style.display = 'inline-block';
}

function getStyleText(style) {
    switch(style) {
        case 'relaxed': return 'ゆったり';
        case 'intensive': return '詰め込み';
        default: return '';
    }
}

function getBudgetText(budget) {
    switch(budget) {
        case 'budget': return 'エコノミー（1日5,000-8,000円）';
        case 'luxury': return 'ラグジュアリー（1日20,000円以上）';
        default: return 'スタンダード（1日10,000-15,000円）';
    }
}

function savePlan() {
    alert('旅行プランが保存されました！\n\n実際のサービスでは、PDFダウンロードやメール送信機能を提供します。');
}

function viewSpotDetail(spotId) {
    window.location.href = `/spots#${spotId}`;
}
</script>
{% endblock %}