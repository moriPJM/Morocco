{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- ページヘッダー -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 text-primary mb-1">
                        <i class="fas fa-map me-2"></i>
                        マップ
                    </h1>
                    <p class="text-muted mb-0">モロッコの観光地を地図で探索</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="toggleSidebar()">
                        <i class="fas fa-list me-1"></i>リスト
                    </button>
                    <button class="btn btn-outline-primary" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow me-1"></i>現在地
                    </button>
                    <a href="/spots" class="btn btn-primary">
                        <i class="fas fa-th me-1"></i>グリッド表示
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- サイドバー -->
        <div class="col-lg-3 col-md-4" id="mapSidebar">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- 検索 -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="mapSearchInput" 
                               placeholder="観光地を検索..." onkeypress="if(event.key==='Enter') searchOnMap()">
                        <button class="btn btn-primary" onclick="searchOnMap()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <!-- フィルター -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">カテゴリー</label>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="宗教建築" id="map-mosque" checked>
                            <label class="form-check-label" for="map-mosque">宗教建築</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="歴史建築" id="map-historical" checked>
                            <label class="form-check-label" for="map-historical">歴史建築</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="都市・建築" id="map-urban" checked>
                            <label class="form-check-label" for="map-urban">都市・建築</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="自然" id="map-nature" checked>
                            <label class="form-check-label" for="map-nature">自然・景観</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="広場・市場" id="map-market" checked>
                            <label class="form-check-label" for="map-market">広場・市場</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="博物館" id="map-museum" checked>
                            <label class="form-check-label" for="map-museum">博物館</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="伝統工芸" id="map-craft" checked>
                            <label class="form-check-label" for="map-craft">伝統工芸</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="文化施設" id="map-culture" checked>
                            <label class="form-check-label" for="map-culture">文化施設</label>
                        </div>
                    </div>

                    <!-- 都市選択 -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">都市</label>
                        <select class="form-select" id="cityMapFilter" onchange="filterByCity()">
                            <option value="">すべての都市</option>
                            <option value="マラケシュ">マラケシュ</option>
                            <option value="カサブランカ">カサブランカ</option>
                            <option value="フェズ">フェズ</option>
                            <option value="メルズーガ">メルズーガ</option>
                            <option value="シャウエン">シャウエン</option>
                            <option value="エッサウィラ">エッサウィラ</option>
                        </select>
                            <option value="メルズーガ">メルズーガ</option>
                            <option value="エッサウィラ">エッサウィラ</option>
                        </select>
                    </div>

                    <button class="btn btn-success w-100" onclick="applyMapFilters()">
                        <i class="fas fa-filter me-1"></i>フィルター適用
                    </button>
                </div>
            </div>

            <!-- 観光地リスト -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        観光地一覧 (<span id="spotCount">0</span>)
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div id="spotsList" class="list-group list-group-flush">
                        <!-- 動的に読み込まれます -->
                    </div>
                </div>
            </div>
        </div>

        <!-- マップエリア -->
        <div class="col-lg-9 col-md-8" id="mapContainer">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; border-radius: 10px;">
                        <!-- 地図が表示されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細情報ポップアップ -->
    <div class="modal fade" id="spotModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spotModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="spotModalBody">
                    <!-- 動的に読み込まれます -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="askAIBtn">
                        <i class="fas fa-robot me-1"></i>AIに質問
                    </button>
                    <button type="button" class="btn btn-primary" id="viewDetailBtn">
                        詳細ページを見る
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// グローバル変数
let map;
let markersGroup;
let allSpots = [];
let filteredSpots = [];
let currentSpotModal = null;

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadSpots();
    setupEventListeners();
    
    // URLパラメーターをチェック
    const urlParams = new URLSearchParams(window.location.search);
    const lat = urlParams.get('lat');
    const lng = urlParams.get('lng');
    const name = urlParams.get('name');
    
    if (lat && lng) {
        setTimeout(() => {
            map.setView([parseFloat(lat), parseFloat(lng)], 15);
            if (name) {
                const spot = allSpots.find(s => s.name === decodeURIComponent(name));
                if (spot) {
                    showSpotModal(spot);
                }
            }
        }, 1000);
    }
});

function initMap() {
    // モロッコ中央の座標
    map = L.map('map').setView([31.7917, -7.0926], 6);
    
    // OpenStreetMap タイル
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // マーカーグループ
    markersGroup = L.layerGroup().addTo(map);
    
    // モロッコの境界を表示（簡易版）
    const moroccoCenter = L.circle([31.7917, -7.0926], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.1,
        radius: 400000
    }).addTo(map);
}

function setupEventListeners() {
    // カテゴリーフィルター
    document.querySelectorAll('.category-filter').forEach(checkbox => {
        checkbox.addEventListener('change', applyMapFilters);
    });
    
    // モーダルイベント
    document.getElementById('askAIBtn').addEventListener('click', function() {
        if (currentSpotModal) {
            askAIAboutSpot(currentSpotModal.name);
        }
    });
    
    document.getElementById('viewDetailBtn').addEventListener('click', function() {
        if (currentSpotModal) {
            window.location.href = `/spots/${currentSpotModal.id}`;
        }
    });
}

function loadSpots() {
    console.log('Loading spots from API...');
    
    // APIからデータを取得
    fetch('/api/spots')
        .then(response => {
            console.log('API Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: 観光地データの取得に失敗しました`);
            }
            return response.json();
        })
        .then(apiResponse => {
            console.log('API Response:', apiResponse);
            
            // APIレスポンスの構造をチェック
            if (apiResponse.success && apiResponse.data) {
                allSpots = apiResponse.data;
                console.log(`Successfully loaded ${allSpots.length} spots`);
                
                // データの検証と座標フィールドの正規化
                const validSpots = allSpots.filter(spot => {
                    if (!spot || !spot.name || !spot.city || !spot.category) return false;
                    
                    // 座標データの確認と正規化
                    if (spot.location && spot.location.lat && spot.location.lng) {
                        spot.lat = spot.location.lat;
                        spot.lng = spot.location.lng;
                        return true;
                    } else if (spot.lat && spot.lng) {
                        return true;
                    }
                    
                    return false;
                });
                
                if (validSpots.length !== allSpots.length) {
                    console.warn(`Warning: ${allSpots.length - validSpots.length} spots have incomplete data`);
                }
                
                allSpots = validSpots;
                console.log(`Validated ${allSpots.length} spots with coordinates`);
                
            } else if (Array.isArray(apiResponse)) {
                // 万が一直接配列が返された場合の後方互換性
                allSpots = apiResponse;
                console.log(`Loaded ${allSpots.length} spots (direct array)`);
            } else {
                throw new Error('APIレスポンスの形式が不正です');
            }
            
            filteredSpots = [...allSpots];
            applyMapFilters();
        })
        .catch(error => {
            console.error('Error loading spots:', error);
            showMapError(error.message);
        });
}

function showMapError(errorMessage = '不明なエラー') {
    console.error('Map error:', errorMessage);
    
    const sidebarContent = document.querySelector('.card-body');
    sidebarContent.innerHTML = `
        <div class="alert alert-warning text-center">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>データを取得できませんでした</h6>
            <p class="small mb-2">観光地情報の読み込みに失敗しました。</p>
            <details class="small text-muted mb-3">
                <summary>エラー詳細</summary>
                <code>${errorMessage}</code>
            </details>
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-primary" onclick="loadSpots()">
                    <i class="fas fa-redo me-1"></i>再読み込み
                </button>
                <a href="/spots" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-th me-1"></i>一覧ページへ
                </a>
            </div>
        </div>
    `;
}

function applyMapFilters() {
    const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
    const selectedCity = document.getElementById('cityMapFilter').value;
    const searchQuery = document.getElementById('mapSearchInput').value.toLowerCase().trim();
    
    filteredSpots = allSpots.filter(spot => {
        // カテゴリーフィルター
        if (selectedCategories.length > 0 && !selectedCategories.includes(spot.category)) {
            return false;
        }
        
        // 都市フィルター
        if (selectedCity && spot.city !== selectedCity) {
            return false;
        }
        
        // 検索フィルター
        if (searchQuery && !spot.name.toLowerCase().includes(searchQuery) && 
            !spot.city.toLowerCase().includes(searchQuery)) {
            return false;
        }
        
        return true;
    });
    
    updateMap();
    updateSpotsList();
}

function updateMap() {
    console.log(`Updating map with ${filteredSpots.length} spots`);
    
    // 既存のマーカーをクリア
    markersGroup.clearLayers();
    
    // 新しいマーカーを追加
    filteredSpots.forEach((spot, index) => {
        if (!spot.lat || !spot.lng) {
            console.warn(`Spot ${spot.name} has invalid coordinates:`, spot.lat, spot.lng);
            return;
        }
        
        console.log(`Adding marker ${index + 1}: ${spot.name} at [${spot.lat}, ${spot.lng}]`);
        
        const marker = L.marker([spot.lat, spot.lng])
            .bindPopup(createPopupContent(spot))
            .on('click', function() {
                showSpotModal(spot);
            });
        
        markersGroup.addLayer(marker);
    });
    
    console.log(`Added ${markersGroup.getLayers().length} markers to map`);
    
    // マーカーに合わせてマップの表示範囲を調整
    if (filteredSpots.length > 0) {
        const group = new L.featureGroup(markersGroup.getLayers());
        if (filteredSpots.length === 1) {
            map.setView([filteredSpots[0].lat, filteredSpots[0].lng], 12);
        } else if (markersGroup.getLayers().length > 0) {
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
}

function createPopupContent(spot) {
    return `
        <div class="text-center" style="min-width: 200px;">
            <h6 class="mb-1">${spot.name}</h6>
            <p class="text-muted small mb-2">
                <i class="fas fa-map-marker-alt text-primary me-1"></i>
                ${spot.city} · ${spot.category}
                ${spot.verified ? '<br><i class="fas fa-check-circle text-success me-1"></i>公式認定' : ''}
            </p>
            <div class="mb-2">
                <span class="badge bg-info">信頼できるスポット</span>
            </div>
            <button class="btn btn-primary btn-sm" onclick="showSpotModal(${JSON.stringify(spot).replace(/"/g, '&quot;')})">
                詳細を見る
            </button>
        </div>
    `;
}

function updateSpotsList() {
    const container = document.getElementById('spotsList');
    const countElement = document.getElementById('spotCount');
    
    countElement.textContent = filteredSpots.length;
    container.innerHTML = '';
    
    filteredSpots.forEach(spot => {
        const listItem = document.createElement('div');
        listItem.className = 'list-group-item list-group-item-action cursor-pointer';
        listItem.onclick = () => {
            map.setView([spot.lat, spot.lng], 15);
            showSpotModal(spot);
        };
        
        listItem.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${spot.name}</h6>
                    <p class="text-muted small mb-1">
                        <i class="fas fa-map-marker-alt text-primary me-1"></i>
                        ${spot.city}
                        ${spot.verified ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}
                    </p>
                    <div class="small">
                        <span class="badge bg-info">信頼スポット</span>
                    </div>
                </div>
                <span class="badge bg-primary">${spot.category}</span>
            </div>
        `;
        
        container.appendChild(listItem);
    });
}

function showSpotModal(spot) {
    currentSpotModal = spot;
    
    document.getElementById('spotModalTitle').textContent = spot.name;
    document.getElementById('spotModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <span class="badge bg-primary me-2">${spot.category}</span>
                    <span class="text-muted">
                        <i class="fas fa-map-marker-alt text-primary me-1"></i>
                        ${spot.city}
                    </span>
                    ${spot.verified ? '<span class="badge bg-success ms-2"><i class="fas fa-check-circle me-1"></i>公式認定</span>' : ''}
                </div>
                <div class="mb-3">
                    <span class="badge bg-info">信頼できる観光スポット</span>
                </div>
                <p>${spot.description}</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    この観光地の情報は公式機関により認定されています。実際のレビューシステムでは、訪問者による評価が表示されます。
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="centerOnSpot(${spot.lat}, ${spot.lng})">
                        <i class="fas fa-crosshairs me-1"></i>地図で中央表示
                    </button>
                    <button class="btn btn-outline-success" onclick="openInGoogleMaps(${spot.lat}, ${spot.lng})">
                        <i class="fas fa-external-link-alt me-1"></i>Google マップで開く
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('spotModal'));
    modal.show();
}

function generateStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 !== 0;
    let stars = '';
    
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star text-warning"></i>';
    }
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt text-warning"></i>';
    }
    const remainingStars = 5 - Math.ceil(rating);
    for (let i = 0; i < remainingStars; i++) {
        stars += '<i class="far fa-star text-warning"></i>';
    }
    
    return `<span>${stars}</span><span class="fw-bold text-warning ms-1">${rating}</span>`;
}

function searchOnMap() {
    applyMapFilters();
}

function filterByCity() {
    applyMapFilters();
}

function toggleSidebar() {
    const sidebar = document.getElementById('mapSidebar');
    const mapContainer = document.getElementById('mapContainer');
    
    if (sidebar.style.display === 'none') {
        sidebar.style.display = 'block';
        mapContainer.className = 'col-lg-9 col-md-8';
    } else {
        sidebar.style.display = 'none';
        mapContainer.className = 'col-12';
    }
    
    // マップサイズを再調整
    setTimeout(() => {
        map.invalidateSize();
    }, 300);
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                map.setView([lat, lng], 10);
                
                L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup('現在地')
                    .openPopup();
            },
            function(error) {
                alert('現在地を取得できませんでした: ' + error.message);
            }
        );
    } else {
        alert('このブラウザは位置情報をサポートしていません。');
    }
}

function centerOnSpot(lat, lng) {
    map.setView([lat, lng], 15);
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('spotModal'));
    modal.hide();
}

function openInGoogleMaps(lat, lng) {
    const url = `https://www.google.com/maps?q=${lat},${lng}`;
    window.open(url, '_blank');
}

function askAIAboutSpot(spotName) {
    const message = `${spotName}について詳しく教えてください。アクセス方法や観光のポイントを知りたいです。`;
    window.location.href = `/ai?question=${encodeURIComponent(message)}`;
}
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#map {
    border: 2px solid #dee2e6;
}

.modal-content {
    border-radius: 15px;
}

.card {
    border-radius: 10px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    #mapSidebar {
        margin-bottom: 1rem;
    }
    
    #map {
        height: 400px !important;
    }
}
</style>
{% endblock %}