{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- ページヘッダー -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 text-primary mb-2">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        観光地一覧
                    </h1>
                    <p class="text-muted">モロッコの美しい観光スポットを探索しましょう</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="showMapView()">
                        <i class="fas fa-map me-1"></i>マップ表示
                    </button>
                    <button class="btn btn-primary" onclick="toggleFilters()">
                        <i class="fas fa-filter me-1"></i>フィルター
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索とフィルター -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- 検索バー -->
                    <div class="row mb-3">
                        <div class="col-lg-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="観光地名、都市名、キーワードで検索..." 
                                       onkeypress="if(event.key==='Enter') performSearch()">
                                <button class="btn btn-primary" onclick="performSearch()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <select class="form-select" id="sortSelect" onchange="applySorting()">
                                <option value="verified">公式認定順</option>
                                <option value="name">名前順</option>
                                <option value="city">都市別</option>
                                <option value="category">カテゴリー別</option>
                            </select>
                        </div>
                    </div>

                    <!-- フィルター -->
                    <div id="filterPanel" class="collapse">
                        <hr class="mb-3">
                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label fw-bold">カテゴリー</label>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="宗教建築" id="mosque">
                                    <label class="form-check-label" for="mosque">宗教建築</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="歴史建築" id="historical">
                                    <label class="form-check-label" for="historical">歴史建築</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="都市・建築" id="urban">
                                    <label class="form-check-label" for="urban">都市・建築</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="自然" id="nature">
                                    <label class="form-check-label" for="nature">自然・景観</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="広場・市場" id="market">
                                    <label class="form-check-label" for="market">広場・市場</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="博物館" id="museum">
                                    <label class="form-check-label" for="museum">博物館</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="伝統工芸" id="craft">
                                    <label class="form-check-label" for="craft">伝統工芸</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input category-filter" type="checkbox" value="文化施設" id="culture">
                                    <label class="form-check-label" for="culture">文化施設</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label fw-bold">都市</label>
                                <select class="form-select" id="cityFilter">
                                    <option value="">すべての都市</option>
                                    <option value="マラケシュ">マラケシュ</option>
                                    <option value="カサブランカ">カサブランカ</option>
                                    <option value="フェズ">フェズ</option>
                                    <option value="メルズーガ">メルズーガ</option>
                                    <option value="シャウエン">シャウエン</option>
                                    <option value="エッサウィラ">エッサウィラ</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label fw-bold">認定状況</label>
                                <select class="form-select" id="trustFilter">
                                    <option value="">すべて</option>
                                    <option value="verified">公式認定のみ</option>
                                    <option value="unesco">ユネスコ世界遺産</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label fw-bold">アクション</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm" onclick="applyFilters()">
                                        <i class="fas fa-filter me-1"></i>フィルター適用
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                        <i class="fas fa-times me-1"></i>クリア
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果表示 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div id="resultCount" class="text-muted">
                    <!-- 動的に更新されます -->
                </div>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="gridView">
                        <i class="fas fa-th"></i>
                    </label>
                    <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
                    <label class="btn btn-outline-secondary btn-sm" for="listView">
                        <i class="fas fa-list"></i>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 観光地リスト -->
    <div id="spotsContainer" class="row">
        <!-- 動的に読み込まれます -->
    </div>

    <!-- ページネーション -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="観光地ページネーション">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- 動的に生成されます -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- ローディング -->
    <div id="loadingSpinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">読み込み中...</span>
        </div>
        <p class="mt-2 text-muted">観光地を読み込んでいます...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// グローバル変数
let currentSpots = [];
let filteredSpots = [];
let currentPage = 1;
const spotsPerPage = 12;

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    loadSpots();
    setupEventListeners();
    
    // URLパラメーターをチェック
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('search');
    const categoryQuery = urlParams.get('category');
    
    if (searchQuery) {
        document.getElementById('searchInput').value = searchQuery;
    }
    if (categoryQuery) {
        const categoryCheckbox = document.querySelector(`input[value="${categoryQuery}"]`);
        if (categoryCheckbox) {
            categoryCheckbox.checked = true;
        }
    }
});

function setupEventListeners() {
    // ビューモード変更
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            displaySpots(filteredSpots);
        });
    });
    
    // カテゴリーフィルター変更
    document.querySelectorAll('.category-filter').forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
    });
    
    // 都市・認定状況フィルター変更
    document.getElementById('cityFilter').addEventListener('change', applyFilters);
    document.getElementById('trustFilter').addEventListener('change', applyFilters);
}

function loadSpots() {
    showLoading(true);
    
    // APIからデータを取得
    fetch('/api/spots')
        .then(response => {
            if (!response.ok) {
                throw new Error('観光地データの取得に失敗しました');
            }
            return response.json();
        })
        .then(apiResponse => {
            console.log('API Response:', apiResponse);
            // APIレスポンスの構造に対応
            if (apiResponse.success && apiResponse.data) {
                currentSpots = apiResponse.data;
            } else if (Array.isArray(apiResponse)) {
                currentSpots = apiResponse;
            } else {
                throw new Error('予期しないAPIレスポンス形式');
            }
            
            // フィーチャーが存在しない場合はデフォルト値を設定
            currentSpots = currentSpots.map(spot => ({
                ...spot,
                features: spot.features || ['観光地'],
                verified: spot.verified || false,
                unesco: spot.unesco || false
            }));
            
            filteredSpots = [...currentSpots];
            applyFilters();
            showLoading(false);
        })
        .catch(error => {
            console.error('Error loading spots:', error);
            showLoading(false);
            showNoDataMessage();
        });
}

function showNoDataMessage() {
    const container = document.getElementById('spotsContainer');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <h4><i class="fas fa-exclamation-triangle me-2"></i>データを取得できませんでした</h4>
                <p>観光地情報の読み込みに失敗しました。しばらく時間をおいて再度お試しください。</p>
                <button class="btn btn-primary" onclick="loadSpots()">再読み込み</button>
            </div>
        </div>
    `;
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const container = document.getElementById('spotsContainer');
    
    if (show) {
        spinner.classList.remove('d-none');
        container.innerHTML = '';
    } else {
        spinner.classList.add('d-none');
    }
}

function displaySpots(spots) {
    const container = document.getElementById('spotsContainer');
    const isListView = document.getElementById('listView').checked;
    
    const startIndex = (currentPage - 1) * spotsPerPage;
    const endIndex = startIndex + spotsPerPage;
    const spotsToShow = spots.slice(startIndex, endIndex);
    
    container.innerHTML = '';
    
    spotsToShow.forEach(spot => {
        const spotElement = createSpotElement(spot, isListView);
        container.appendChild(spotElement);
    });
    
    updatePagination(spots.length);
    updateResultCount(spots.length);
}

function createSpotElement(spot, isListView) {
    const div = document.createElement('div');
    
    if (isListView) {
        div.className = 'col-12 mb-3';
        div.innerHTML = `
            <div class="card h-100 hover-card">
                <div class="row g-0">
                    <div class="col-md-12">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">${spot.name}</h5>
                                <span class="badge bg-primary">${spot.category}</span>
                            </div>
                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-map-marker-alt text-primary me-1"></i>
                                ${spot.city}
                                ${spot.verified ? '<i class="fas fa-check-circle text-success ms-2" title="公式認定スポット"></i>' : ''}
                                ${spot.unesco ? '<i class="fas fa-globe text-primary ms-1" title="ユネスコ世界遺産"></i>' : ''}
                            </p>
                            <p class="card-text">${spot.description}</p>
                            <div class="mb-3">
                                ${(spot.features || []).map(feature => `<span class="badge bg-light text-dark me-1">${feature}</span>`).join('')}
                            </div>
                            <button class="btn btn-primary" onclick="viewSpotDetail(${spot.id})">
                                詳細を見る
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        div.className = 'col-lg-4 col-md-6 mb-4';
        div.innerHTML = `
            <div class="card h-100 hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">${spot.name}</h5>
                        <span class="badge bg-primary">${spot.category}</span>
                    </div>
                    <p class="card-text text-muted small mb-2">
                        <i class="fas fa-map-marker-alt text-primary me-1"></i>
                        ${spot.city}
                        ${spot.verified ? '<i class="fas fa-check-circle text-success ms-2" title="公式認定スポット"></i>' : ''}
                        ${spot.unesco ? '<i class="fas fa-globe text-primary ms-1" title="ユネスコ世界遺産"></i>' : ''}
                    </p>
                    <p class="card-text">${spot.description}</p>
                    <div class="mb-3">
                        ${(spot.features || []).slice(0, 2).map(feature => `<span class="badge bg-light text-dark me-1">${feature}</span>`).join('')}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="viewSpotDetail(${spot.id})">
                        詳細を見る
                    </button>
                </div>
            </div>
        `;
    }
    
    return div;
}

function generateStars(rating) {
    if (!rating) return '';
    
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 !== 0;
    let stars = '';
    
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star text-warning"></i>';
    }
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt text-warning"></i>';
    }
    const remainingStars = 5 - Math.ceil(rating);
    for (let i = 0; i < remainingStars; i++) {
        stars += '<i class="far fa-star text-warning"></i>';
    }
    
    return `<span class="me-1">${stars}</span><span class="fw-bold text-warning">${rating}</span>`;
}

function performSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    applyFilters();
}

function applyFilters() {
    const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
    const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
    const selectedCity = document.getElementById('cityFilter').value;
    const selectedTrust = document.getElementById('trustFilter').value;
    
    filteredSpots = currentSpots.filter(spot => {
        // 検索フィルター
        if (searchQuery && !spot.name.toLowerCase().includes(searchQuery) && 
            !spot.city.toLowerCase().includes(searchQuery) && 
            !spot.description.toLowerCase().includes(searchQuery)) {
            return false;
        }
        
        // カテゴリーフィルター
        if (selectedCategories.length > 0 && !selectedCategories.includes(spot.category)) {
            return false;
        }
        
        // 都市フィルター
        if (selectedCity && spot.city !== selectedCity) {
            return false;
        }
        
        // 認定状況フィルター
        if (selectedTrust === 'verified' && !spot.verified) {
            return false;
        }
        if (selectedTrust === 'unesco' && !spot.unesco) {
            return false;
        }
        
        return true;
    });
    
    currentPage = 1;
    applySorting();
}

function applySorting() {
    const sortBy = document.getElementById('sortSelect').value;
    
    switch (sortBy) {
        case 'verified':
            filteredSpots.sort((a, b) => {
                if (a.verified && !b.verified) return -1;
                if (!a.verified && b.verified) return 1;
                return a.name.localeCompare(b.name);
            });
            break;
        case 'name':
            filteredSpots.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'city':
            filteredSpots.sort((a, b) => a.city.localeCompare(b.city));
            break;
        case 'category':
            filteredSpots.sort((a, b) => a.category.localeCompare(b.category));
            break;
    }
    
    displaySpots(filteredSpots);
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
    document.getElementById('cityFilter').value = '';
    document.getElementById('trustFilter').value = '';
    
    filteredSpots = [...currentSpots];
    currentPage = 1;
    applySorting();
}

function toggleFilters() {
    const filterPanel = document.getElementById('filterPanel');
    if (filterPanel.classList.contains('show')) {
        filterPanel.classList.remove('show');
    } else {
        filterPanel.classList.add('show');
    }
}

function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / spotsPerPage);
    const pagination = document.getElementById('pagination');
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 前のページ
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">前へ</a>`;
    pagination.appendChild(prevItem);
    
    // ページ番号
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            pagination.appendChild(pageItem);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const ellipsis = document.createElement('li');
            ellipsis.className = 'page-item disabled';
            ellipsis.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(ellipsis);
        }
    }
    
    // 次のページ
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">次へ</a>`;
    pagination.appendChild(nextItem);
}

function updateResultCount(totalItems) {
    const resultCount = document.getElementById('resultCount');
    const startIndex = (currentPage - 1) * spotsPerPage + 1;
    const endIndex = Math.min(currentPage * spotsPerPage, totalItems);
    
    resultCount.textContent = `${totalItems}件中 ${startIndex}-${endIndex}件を表示`;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredSpots.length / spotsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displaySpots(filteredSpots);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function showMapView() {
    window.location.href = '/map';
}

function viewSpotDetail(spotId) {
    window.location.href = `/spots/${spotId}`;
}
</script>

<style>
.hover-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 15px;
    overflow: hidden;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.form-check-input:checked {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
}

.badge {
    font-size: 0.75em;
}

.pagination .page-link {
    border-radius: 8px;
    margin: 0 2px;
    border: none;
    color: var(--bs-primary);
}

.pagination .page-item.active .page-link {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
}

.card-footer {
    border-top: none;
}
</style>
{% endblock %}