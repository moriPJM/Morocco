"""
AIチャット機能API
"""

from flask import Blueprint, jsonify, request
import re
import os

# GPTサービスをインポート（オプション）
try:
    from backend.services.gpt_service import MoroccoTourismGPT
    gpt_service = MoroccoTourismGPT()
except ImportError:
    gpt_service = None

chat_bp = Blueprint('chat', __name__)

def get_morocco_guide_response(user_message):
    """モロッコ観光ガイドとしての専門的な応答を生成"""
    
    # メッセージを小文字化して解析
    message_lower = user_message.lower()
    
    # モロッコ観光ガイドとしての挨拶
    greeting_patterns = ['こんにちは', 'はじめまして', 'hello', 'hi', 'salut']
    if any(pattern in message_lower for pattern in greeting_patterns):
        return """🇲🇦 السلام عليكم (アッサラーム・アライクム) こんにちは！

私はあなた専用のモロッコ観光ガイド「ハッサン」です✨
20年以上モロッコ全土をご案内してきた経験を活かし、最高の旅をサポートします！

**� 今日はどんなことをお手伝いしましょうか？**

**📍 エリア別ガイド**
• マラケシュ - 赤い街の魅力と必見スポット
• フェズ - 千年の歴史が息づく迷宮都市
• シャウエン - インスタ映え抜群の青い街
• サハラ砂漠 - 一生の思い出になる砂漠体験

**🎯 目的別おすすめ**
• 初回訪問 - 王道7日間コース
• 冒険派 - 砂漠キャンプ＆トレッキング
• グルメ旅 - 本場のタジン＆市場探索
• 文化体験 - ベルベル文化＆伝統工芸

**実際の現地情報や隠れた名店も教えます！**
遠慮なく何でもお聞きください 😊"""

    # 都市・地域に関する質問
    if any(keyword in message_lower for keyword in ['マラケシュ', 'marrakech', 'marrakesh', '隠れた名店', '名店', 'レストラン']):
        return """🌅 **マラケシュ完全ガイド - 赤い街の魅力**

**🏛️ 絶対に見逃せないスポット**

**🌟 ジャマ・エル・フナ広場**
• **昼間（9:00-17:00）**: オレンジジュース屋台（3-5DH）、ヘナタトゥー（50-100DH）
• **夕方（17:00-19:00）**: 屋台グルメが登場（タジン25-45DH、クスクス35-60DH）
• **夜（19:00以降）**: 大道芸人、グナワ音楽家の競演
• **ガイドのコツ**: カフェ・ド・フランス2階テラスから全景撮影（ドリンク代20DH）
• **注意**: スリに注意、貴重品は分散して持つ

**🕌 クトゥビアモスク**
• 12世紀建造、高さ77m、マラケシュのシンボル
• **ベスト撮影時間**: 日没1時間前（ゴールデンアワー）
• **夜間ライトアップ**: 日没～23:00
• **📸 絶景ポイント**: アルメナラ庭園（入場無料）、クトゥビア公園

**🏰 バイア宮殿**
• **入場料**: 70DH（学生50DH、12歳以下無料）
• **開館時間**: 9:00-16:45（金曜14:30-16:45）
• **所要時間**: 45分-1時間
• **見どころ**: 大理石の中庭、精巧なゼリージュタイル、ムカルナス装飾
• **混雑回避**: 朝9:00-10:00、昼食時間帯（13:00-14:00）

**🌺 マジョレル庭園**
• **入場料**: 庭園150DH、美術館込み250DH
• **開館時間**: 8:00-18:00（10月-3月は17:30まで）
• **イヴ・サンローラン記念館**: 別途100DH
• **混雑回避**: 朝8:00開園直後が最も美しく、人も少ない
• **カフェ**: 園内レ・ジャルダン・ド・ラ・クトゥビアでランチ（平均200-300DH）

**🍽️ 現地ガイド厳選！隠れた名店**

**🥘 伝統料理の名店**
• **Dar Yacout** - 旧市街の高級リヤドレストラン
  料金: 固定メニュー800-1200DH、要予約（+212 524 38 29 29）
  名物: ラム肉のタジン、パスティラ、伝統的なモロッコ宮廷料理

• **Al Fassia** - 女性シェフチーム運営の老舗
  料金: タジン80-120DH、クスクス（金曜のみ）150DH
  場所: 新市街ギリーズ地区、タクシーで「アル・ファシア」と言えばOK
  営業: 12:00-15:00、19:30-23:00（月曜定休）

• **Le Foundouk** - フランス・モロッコ融合料理
  料金: ランチ280DH、ディナー480DH
  場所: 旧市街カート・ベン・ナヒド地区
  雰囲気: 中庭のテラス席が絶景、要予約

**🍃 地元民の隠れ家**
• **Chez Lamine Hadj Mustapha** - 創業60年の老舗タジン専門店
  料金: タジン25-40DH（観光地価格の半分！）
  場所: 旧市街スーク内、革市場の奥
  注文方法: 「タジン・ポレ・オ・シトロン」（チキンレモンタジン）がおすすめ

• **Henna Art Café** - 屋上テラスの絶景カフェ
  料金: アタイ（ミントティー）15DH、軽食50-80DH
  営業: 9:00-22:00
  特色: ジャマ・エル・フナ広場を見下ろす最高のロケーション

**🛍️ スーク攻略法**

**🎯 効率的な回り方**
• **午前中（9:00-12:00）**: 比較的涼しく、商人も交渉しやすい
• **避ける時間**: 13:00-15:00（昼休み）、金曜礼拝時間
• **ルート**: 青い門→革製品スーク→絨毯スーク→スパイススーク→金属工芸品スーク

**💰 値段交渉の極意**
• **基本**: 言い値の1/4から開始、最終的に1/3程度で妥結
• **革製品**: バッグ（言い値800DH→実際200-250DH）
• **絨毯**: 小サイズ（言い値5000DH→実際1200-1500DH）
• **スパイス**: サフラン1g（言い値100DH→実際20-30DH）

**🏨 宿泊エリア別ガイド**

**🕌 旧市街（メディナ）**
• **リヤド予算**: 800-3000DH/泊
• **おすすめ**: Riad Yasmine（1200DH/泊）、伝統的な中庭、屋上テラス
• **メリット**: 雰囲気抜群、徒歩で観光地回れる
• **デメリット**: 車でのアクセス不可、荷物運びが大変

**🏙️ 新市街（ギリーズ）**
• **ホテル予算**: 600-2000DH/泊
• **おすすめ**: Hotel Islane（800DH/泊）、プール付き、無料WiFi
• **メリット**: 現代的施設、タクシーアクセス良好
• **デメリット**: モロッコらしさは少ない

**🚗 移動・アクセス情報**

**✈️ 空港アクセス**
• **バス**: 19番線（30DH）、45分間隔、所要時間45分
• **タクシー**: 定額100DH（昼間）、130DH（夜間20:00-6:00）
• **送迎サービス**: ホテル手配200-300DH

**🚗 市内移動**
• **プチタクシー**: 初乗り7DH、メーター使用必須
• **馬車**: 観光用100-150DH/30分、要交渉
• **徒歩**: 旧市街内は徒歩が基本、スニーカー必須

**⚠️ 現地ガイドからの重要アドバイス**

**👮 安全対策**
• **貴重品**: パスポートコピー携帯、現金は分散
• **スリ対策**: ジャマ・エル・フナ広場夜間、スーク内人混み
• **ニセガイド**: 「自分は学生」と近づく人は要注意

**🌡️ 季節別のコツ**
• **夏（6-8月）**: 朝7:00-10:00、夕方17:00以降に活動
• **冬（12-2月）**: 昼間は暖かいが夜は10度以下、防寒具必要
• **春・秋**: ベストシーズン、朝晩冷えるので羽織り物を

**💡 プロのワンポイント**
• アタイ（ミントティー）は必ず3杯飲むのがマナー
• 金曜日午後は多くの店が閉店（礼拝のため）
• チップ文化：レストラン10-15%、ホテル10-20DH/日

具体的な場所や予算について、さらに詳しく知りたいことがあれば遠慮なくお聞きください！✨"""

    elif any(city in message_lower for city in ['フェズ', 'fez', 'fès']):
        return """📚 **フェズ完全ガイド - 千年の学問都市**

**🏛️ 歴史的価値と必見スポット**

**🎓 カラウィーン大学・モスク**
• **創立**: 859年、世界最古の現存大学（ギネス認定）
• **入場**: イスラム教徒のみ、外部から見学可能
• **見学時間**: 9:00-17:00（礼拝時間は避ける）
• **撮影ポイント**: 中庭入口から、美しい緑のタイル屋根

**🎨 ブー・イナニア・マドラサ（神学校）**
• **入場料**: 30DH
• **開館時間**: 9:00-18:00（礼拝時間は中断）
• **見どころ**: 精巧な木彫り、ゼリージュタイル、アラビア書道
• **所要時間**: 30-45分
• **ベスト撮影**: 中庭の水盤に映る装飾が美しい

**🏺 タンネリー（皮なめし場）**
• **見学料**: 50-100DH（ガイド付き）
• **営業時間**: 8:00-18:00（金曜午後は休み）
• **おすすめ時間**: 午前中（臭いが比較的マシ）
• **注意**: ミント葉を鼻に当てる（無料提供）
• **お土産**: 革製品30-50%安く購入可能

**🚪 バブ・ブージュルード（青い門）**
• **フェズ旧市街**: メイン入口、写真スポット
• **夜間ライトアップ**: 日没-23:00
• **周辺**: カフェ、レストラン、お土産店

**🍽️ フェズ美食体験**

**🥘 伝統料理レストラン**
• **Palais de Fès** - 宮殿を改装した高級レストラン
  料金: 固定メニュー600-900DH、要予約
  名物: フェズ風パスティラ（鳩肉のパイ）、ラム肉のタジン

• **Café Clock** - 若者に人気のモダンカフェ
  料金: 80-150DH、ラクダバーガー120DH
  営業: 10:00-23:00、屋上テラス有り
  WiFi: 無料、英語メニュー有り

• **Restaurant Medina** - 地元民御用達
  料金: タジン40-60DH、クスクス（金曜）80DH
  場所: タンネリー近く、看板なし（現地の人に聞く）

**🛍️ フェズ・スーク攻略法**

**🗺️ エリア別ガイド**
• **アッタリン・スーク**: スパイス・香水・薬草
• **フォンドゥーク・ネジャリン**: 木工職人街、美術館
• **スーク・フェズ・ジュディド**: 新市街の現代的な市場

**💰 価格の目安と交渉術**
• **陶器**: フェズブルーの皿（言い値500DH→実際100-150DH）
• **絨毯**: 中サイズ（言い値8000DH→実際2000-3000DH）
• **銀製品**: ベルベルジュエリー（言い値800DH→実際200-300DH）

**🏨 宿泊おすすめ**

**🕌 旧市街（フェズ・エル・バリ）**
• **Riad Rcif** - 1400DH/泊、伝統的なリヤド、屋上テラス
• **Dar Seffarine** - 2200DH/泊、ブティックホテル、スパ付き
• **予算重視**: Riad Louna（800DH/泊）、清潔、朝食込み

**🏙️ 新市街（ヴィルヌーヴェル）**
• **Hotel Zalagh Parc Palace** - 1800DH/泊、プール・ジム
• **Ibis Fes** - 900DH/泊、現代的設備、無料WiFi

**🚗 移動・アクセス**

**✈️ フェズ・サイス空港から市内**
• **タクシー**: 定額150DH（30分）
• **バス**: 16番線、15DH（45分）

**🚌 他都市からのアクセス**
• **カサブランカから**: 電車4時間（2等135DH、1等200DH）
• **マラケシュから**: バス7時間（150DH）
• **シャウエンから**: バス4時間（70DH）

**🚶 旧市街内の移動**
• **徒歩**: 基本は徒歩、迷子になりやすい
• **公認ガイド**: 200-300DH/半日、観光案内所で手配
• **非公認ガイド**: 断固拒否（トラブルの元）

**⚠️ フェズ特有の注意点**

**🧭 迷子対策**
• **GPS**: 旧市街では機能しない場合多い
• **目印**: 主要モスクの名前を覚える
• **緊急時**: 「バブ・ブージュルード」と言えば青い門に案内される

**👔 服装のマナー**
• **モスク見学**: 長袖・長ズボン必須
• **女性**: スカーフ持参、露出は避ける
• **靴**: 歩きやすいスニーカー（石畳で滑りやすい）

**🕐 時間帯のコツ**
• **午前中**: 涼しく、職人の作業見学に最適
• **昼食後（14:00-16:00）**: 多くの店が休憩
• **夕方**: カフェテラスでアタイを楽しむ

**💡 現地ガイドの秘訣**
• **フェズブルーの秘密**: コバルトとクロムで作る独特の青色
• **迷路の歴史**: 外敵から街を守るため意図的に複雑に設計
• **職人街の見学**: 早朝（8:00-9:00）が作業を見るベストタイム

**🌟 隠れたフォトスポット**
• **ホテル・サハライ屋上**: フェズ全景（カフェ利用で撮影OK）
• **ボルジュ・ノール砦**: 旧市街パノラマビュー（タクシー必要）
• **ネジャリン博物館屋上**: 木工スークを見下ろす

フェズの特定の場所や体験について、より詳しい情報が必要でしたら遠慮なくお聞きください！📚✨"""

    elif any(city in message_lower for city in ['シャウエン', 'chefchaouen', 'chaouen']):
        return """💙 **シャウエン - 青い真珠**

**魅力:**
• 建物の壁が青く塗られた美しい街並み
• インスタグラム映えスポットとして世界的に有名
• リフ山脈の麓の涼しい気候

**おすすめ活動:**
• 旧市街の散策（特に朝の光がベスト）
• ウタ・エル・ハマム広場でカフェタイム
• 地元のベルベル織物ショッピング
• スペイン・モスクからの街の全景

**アクセス:** フェズから車で約4時間、カサブランカから約5時間

**撮影のコツ:** 午前中の柔らかい日光が青い壁を美しく照らします📸"""

    # サハラ砂漠関連
    elif any(keyword in message_lower for keyword in ['サハラ', 'sahara', '砂漠', 'desert', 'キャンプ', 'ラクダ']):
        return """🐪 **サハラ砂漠完全攻略ガイド - 黄金の海への冒険**

**🗺️ 砂漠拠点別ガイド**

**🌟 メルズーガ（エルグ・シェビ）- 最もおすすめ！**
• **砂丘の高さ**: 最大150m、モロッコ最大級
• **アクセス**: マラケシュから車で8-9時間、フェズから7-8時間
• **ベストシーズン**: 10月-4月（昼25°C、夜5-10°C）
• **村の設備**: ATM、薬局、スーパー、ガソリンスタンド有り

**🏜️ ザゴラ（エルグ・リアッド）- 手軽に砂漠体験**
• **砂丘の高さ**: 50-80m、比較的小規模
• **アクセス**: マラケシュから車で4-5時間
• **特徴**: 時間制約がある方におすすめ
• **宿泊**: 基本的にロッジ・ホテル（テントキャンプは少ない）

**🎯 砂漠ツアー種類と料金**

**🐪 日帰りラクダトレッキング**
• **料金**: 400-600DH/人
• **所要時間**: 2-3時間
• **含まれるもの**: ラクダ乗り、ガイド、ミントティー
• **おすすめ時間**: 夕日鑑賞ツアー（16:00-19:00）

**⭐ 1泊2日砂漠キャンプ（スタンダード）**
• **料金**: 800-1200DH/人
• **宿泊**: 共同テント（4-6人用）、共同トイレ・シャワー
• **食事**: ベルベル料理（タジン、パン、フルーツ）
• **アクティビティ**: ラクダトレッキング、星空観察、ベルベル音楽

**💎 1泊2日砂漠キャンプ（ラグジュアリー）**
• **料金**: 2000-3500DH/人
• **宿泊**: 個室テント、専用バスルーム、エアコン
• **食事**: フルコース料理、ワイン・ビール有り
• **サービス**: 専属ガイド、写真撮影、送迎車グレードアップ

**🌅 2泊3日完全砂漠体験**
• **料金**: 2500-4500DH/人
• **特別体験**: 砂漠奥地キャンプ、サンドボード、星空撮影講座
• **ルート**: アイト・ベン・ハドゥ→トドラ渓谷→メルズーガ

**🎒 砂漠持参必須アイテム**

**👕 服装（季節別）**
• **夏（6-8月）**: 薄手長袖、帽子、サングラス、日焼け止めSPF50+
• **冬（12-2月）**: 防寒着、手袋、毛糸帽（夜間0°C以下）
• **通年**: 砂嵐用スカーフ、歩きやすいスニーカー

**📱 撮影・記録用品**
• **カメラ保護**: ジップロック（砂対策）、予備バッテリー
• **スマホ**: 防塵ケース、ポータブル充電器
• **三脚**: 星空撮影用（レンタル有り：50DH/日）

**💊 健康・安全用品**
• **薬**: 胃腸薬、頭痛薬、目薬（砂対策）
• **水**: 1日3-4リットル必要、電解質サプリ
• **その他**: ウェットティッシュ、マスク、懐中電灯

**🌅 砂漠での1日タイムテーブル**

**📅 典型的なスケジュール**
• **15:00**: メルズーガ村到着、荷物預け
• **16:00**: ラクダトレッキング開始（90分）
• **17:30**: 砂丘頂上で夕日鑑賞（30分）
• **18:30**: キャンプ地到着、テント設営見学
• **19:30**: ベルベル料理の夕食
• **21:00**: 焚き火を囲んでベルベル音楽鑑賞
• **22:00**: 満天の星空観察（天の川撮影）
• **06:00**: 砂漠の日の出鑑賞
• **07:30**: 朝食（パン、ジャム、ミントティー）
• **08:30**: ラクダで村へ帰還

**🍽️ 砂漠グルメ体験**

**🥘 ベルベル伝統料理**
• **タジン・ベルベル**: 羊肉、野菜、プルーン、アーモンド
• **砂漠パン**: 砂の中で焼く伝統的なパン
• **メクルッド**: デーツとナッツの砂漠菓子

**� 飲み物**
• **アタイ・サハラウィ**: 砂漠風ミントティー（より甘い）
• **ラクダミルク**: 新鮮なラクダの乳（有料、50DH）

**⭐ 星空観察ガイド**

**🌌 ベスト観察時期**
• **新月前後**: 最も星がよく見える
• **時間**: 22:00-4:00（最も暗い時間帯）
• **見られる星座**: オリオン座、カシオペア座、北極星

**📷 撮影テクニック**
• **カメラ設定**: ISO3200、F2.8、30秒露光
• **構図**: 砂丘のシルエットと星空のコントラスト
• **レンタル**: 星空撮影機材（200DH/日、指導付き）

**🚗 アクセス・移動情報**

**🚌 公共交通機関**
• **CTMバス**: マラケシュ→ザゴラ（4.5時間、90DH）
• **乗合タクシー**: ザゴラ→メルズーガ（2時間、50DH/人）
• **注意**: 金曜午後は便数激減

**🚗 レンタカー**
• **4WD必須**: 砂漠手前30kmは舗装なし
• **GPS**: オフライン地図ダウンロード必須
• **燃料**: メルズーガで満タンに（次の町まで200km）

**💰 予算プランニング**

**🎒 バックパッカー（1泊2日）**
• **総額**: 1200-1500DH
• **内訳**: バス代180DH、ツアー800DH、食事200DH、その他

**👨‍👩‍👧‍👦 ファミリー（1泊2日）**
• **総額**: 8000-12000DH（4人家族）
• **内訳**: 専用車6000DH、ラグジュアリーキャンプ4000DH、食事2000DH

**� カップル・ハネムーン（2泊3日）**
• **総額**: 15000-25000DH
• **内訳**: プライベートツアー、5つ星砂漠キャンプ、特別ディナー

**⚠️ 現地ガイドからの重要アドバイス**

**🌡️ 健康管理**
• **脱水症状**: 喉が渇く前に水分補給
• **砂目対策**: 目薬持参、コンタクトより眼鏡推奨
• **日焼け**: 砂からの反射で想像以上に焼ける

**🐪 ラクダ乗りのコツ**
• **乗車姿勢**: 背筋を伸ばし、手綱は軽く握る
• **立ち上がり時**: 後ろに倒れるような感覚、慌てない
• **降車**: ガイドの指示に従い、ゆっくりと

**💡 写真撮影の秘訣**
• **ゴールデンアワー**: 日出30分前〜日出後30分が最美
• **人物撮影**: 砂丘のラインを活かした構図
• **動画**: 360度カメラで砂漠の壮大さを記録

砂漠体験は一生に一度の特別な体験です。具体的な日程やご予算に合わせたプランニングについて、遠慮なくご相談ください！🌟"""

    # 食事・グルメ関連
    elif any(keyword in message_lower for keyword in ['料理', '食べ物', 'グルメ', 'タジン', 'クスクス', 'food', 'ミントティー', 'お茶']):
        return """🍽️ **モロッコ美食完全ガイド - 味覚の宝庫を探検**

**🥘 必食！代表的なモロッコ料理**

**🍖 タジン（Tajine）**
• **チキン・レモン・オリーブ**: 最もポピュラー（50-80DH）
• **ラム肉・プルーン・アーモンド**: 甘じょっぱい絶品（70-100DH）
• **野菜タジン**: ベジタリアン向け（40-60DH）
• **魚タジン**: 沿岸部でおすすめ（60-90DH）
• **調理のコツ**: 円錐型の蓋で蒸し煮、低温でじっくり

**🍚 クスクス（Couscous）**
• **金曜日の伝統料理**: 家族で食べる神聖な食事
• **セブンベジタブル**: 7種類の野菜（幸運の象徴）
• **羊肉クスクス**: 最も一般的（80-120DH）
• **チキンクスクス**: 軽やか（70-100DH）
• **食べ方**: 右手で小さく丸めて口に運ぶ

**🥧 パスティラ（Pastilla）**
• **鳩肉のパイ**: フェズの名物、甘じょっぱい（150-250DH）
• **シーフードパスティラ**: 沿岸部の現代版（120-200DH）
• **特徴**: アーモンド、シナモン、粉砂糖の組み合わせ

**🍲 ハリラ（Harira）**
• **レンズ豆スープ**: ラマダン明けの定番（20-30DH）
• **材料**: トマト、レンズ豆、ひよこ豆、香草
• **付け合わせ**: デーツ、シェバキア（お菓子）

**🍃 アタイ（Atay）- モロッコ・ミントティー**

**🫖 正しい淹れ方と作法**
• **材料**: 緑茶、生ミント、角砂糖3-5個
• **淹れ方**: 
  1. 緑茶を軽く洗う（苦みを取る）
  2. 生ミントと砂糖を加える
  3. 高い位置から注ぐ（泡立てるため）
• **3杯の作法**: 「1杯目は死のように苦く、2杯目は人生のように甘く、3杯目は愛のように優しい」

**⏰ 1日のティータイム**
• **朝食後**: 軽めの1杯
• **午後**: 最も重要なティータイム（14:00-16:00）
• **夕食後**: 消化を助ける1杯
• **客人への作法**: 必ず3杯出す、拒否は失礼

**🏪 エリア別グルメスポット**

**🌟 マラケシュの名店**
• **Le Jardin**: 緑豊かな中庭、インスタ映え（200-300DH）
• **Nomad**: 屋上テラス、モダン・モロッコ料理（250-400DH）
• **Pepe Nero**: イタリア・モロッコ融合（300-500DH）
• **地元の隠れ家**: Haj Mustapha（タジン25DH、現地人だらけ）

**📚 フェズの老舗**
• **Restaurant Medina**: 70年続く老舗（60-100DH）
• **Palais de Fès**: 宮殿レストラン（600-900DH）
• **Café Clock**: 若者の聖地、ラクダバーガー（120DH）

**💙 シャウエンの山の味**
• **Casa Hassan**: 屋上テラス、山の景色（80-150DH）
• **Beldi Bab Ssour**: ベルベル料理専門（100-180DH）

**🛒 食材ショッピングガイド**

**🌶️ スパイス市場攻略法**
• **サフラン**: 最高級品1g（50-80DH）、偽物注意
• **ラス・エル・ハヌート**: 「店の頂上」30種のミックススパイス（30DH/100g）
• **タジンスパイス**: 家庭用ブレンド（20DH/100g）
• **保存方法**: 密閉容器、冷暗所保存

**🫒 その他の名産品**
• **アルガンオイル**: 食用（150DH/250ml）、美容用（200DH/250ml）
• **ハチミツ**: アカシア（80DH/kg）、ユーカリ（100DH/kg）
• **オリーブ**: マラケシュ・グリーン（40DH/kg）、ブラック（60DH/kg）
• **デーツ**: メジュール（最高級、120DH/kg）

**🍷 モロッコの飲み物文化**

**🍇 ワイン（一部レストランで提供）**
• **灰色ワイン（Gris de Boulaouane）**: モロッコ独特のロゼ
• **赤ワイン**: Cabernet、Merlot品種
• **価格**: レストランで200-400DH/ボトル

**🥤 ノンアルコール飲料**
• **アボカドジュース**: 濃厚（25-35DH）
• **オレンジジュース**: 絞りたて（10-15DH）
• **アーモンドミルク**: 伝統的（20-30DH）

**🍽️ 食事マナーとエチケット**

**🤲 基本的なマナー**
• **右手で食事**: 左手は不浄とされる
• **パンの重要性**: タジンをすくって食べる、絶対に無駄にしない
• **共同皿**: 自分の前の部分のみ食べる
• **食事前**: 「ビスミッラー」（神の名において）と言う

**🚫 注意すべきこと**
• **足の裏**: 人に向けない
• **左手**: 食事に使わない
• **豚肉**: イスラム教のため提供されない
• **アルコール**: 一部の観光客向けレストランのみ

**💰 予算別レストランガイド**

**💸 格安（50DH以下/人）**
• **街角食堂**: タジン25-40DH、クスクス35-50DH
• **屋台**: スープ15DH、パン・オリーブ10DH
• **パン屋**: 焼きたてパン2-3DH

**💳 中級（100-200DH/人）**
• **観光客向けレストラン**: セットメニュー150DH
• **リヤドレストラン**: 雰囲気重視、180DH
• **カフェレストラン**: 軽食とドリンク120DH

**💎 高級（300DH以上/人）**
• **宮殿レストラン**: フルコース500-800DH
• **国際ホテル**: ブッフェ400DH、アラカルト600DH
• **特別体験**: 料理教室込み800DH

**👩‍🍳 料理教室体験**

**🥘 人気の料理教室**
• **La Maison Arabe（マラケシュ）**: 4時間コース（800DH）
• **Riad Monceau（マラケシュ）**: 市場ツアー込み（1200DH）
• **Riad Rcif（フェズ）**: フェズ料理専門（600DH）

**📋 学べる料理**
• **タジン**: 3種類の作り方
• **クスクス**: 手作り麺から
• **パスティラ**: 伝統的なレシピ
• **モロッコサラダ**: 付け合わせ各種

**🎁 料理教室の特典**
• **レシピブック**: 英語・フランス語版
• **スパイスセット**: お土産用
• **修了証**: 参加証明書
• **写真**: 調理過程の記録

**⚠️ 食事の健康・安全情報**

**💧 水と衛生**
• **水**: ボトル水推奨（10DH/1.5L）
• **氷**: 観光地以外は避ける
• **生野菜**: 皮をむけない物は避ける
• **乳製品**: 常温保存の物は注意

**💊 お腹の調子対策**
• **胃腸薬**: 日本から持参推奨
• **プロバイオティクス**: 旅行前から摂取
• **BRAT diet**: 調子悪い時（バナナ、米、りんご、トースト）

モロッコの食文化について、特定の料理や地域について、より詳しく知りたいことがあれば遠慮なくお聞きください！🍽️✨"""

    # 文化・宗教関連
    elif any(keyword in message_lower for keyword in ['文化', 'イスラム', '宗教', 'ベルベル', 'アラブ']):
        return """🕌 **モロッコの豊かな文化**

**民族構成:**
• **ベルベル人** - モロッコ先住民（40%）
• **アラブ人** - 7世紀以降の移住（40%）
• その他（ユダヤ系、サハラ系など）

**言語:**
• アラビア語（公用語）
• ベルベル語（アマジグ語、公用語）
• フランス語（旧宗主国、ビジネス語）
• 英語（観光地で通じる）

**宗教・習慣:**
• イスラム教スンニ派（95%）
• 1日5回の礼拝（アザーンの声が響く）
• 金曜日は聖なる日
• ラマダン月は日中断食

**伝統工芸:**
• 絨毯・キリム織り
• 陶器（フェズブルー）
• 革製品
• 金属細工

**音楽:** グナワ音楽、ベルベル音楽、アンダルス音楽

文化について何か特定の質問はありますか？🎭"""

    # 気候・季節関連
    elif any(keyword in message_lower for keyword in ['気候', '天気', '季節', 'ベストシーズン', 'いつ']):
        return """🌡️ **モロッコの気候とベストシーズン**

**地域別気候:**
• **沿岸部**（カサブランカ）- 地中海性気候、温暖
• **内陸部**（マラケシュ）- 大陸性、昼夜の温度差大
• **山岳部**（アトラス山脈）- 冬は雪、夏は涼しい
• **砂漠部**（サハラ）- 乾燥、昼暑く夜寒い

**季節ごとの特徴:**

**🌸 春（3-5月）**
• 気温: 15-25°C
• 花が咲き乱れる美しい季節
• 観光に最適

**☀️ 夏（6-8月）**
• 気温: 25-45°C
• 沿岸部は涼しい、内陸は酷暑
• 早朝・夕方の活動推奨

**🍂 秋（9-11月）**
• 気温: 20-30°C
• 最高の観光シーズン
• 砂漠ツアーに最適

**❄️ 冬（12-2月）**
• 気温: 5-20°C
• 雨季、山は雪
• 暖かい服装必須

**総合ベストシーズン:** 10月〜4月 🎯"""

    # 交通・アクセス関連
    elif any(keyword in message_lower for keyword in ['交通', 'アクセス', '移動', '電車', 'バス', 'タクシー']):
        return """🚅 **モロッコの交通手段**

**鉄道（ONCF）:**
• カサブランカ ⇔ マラケシュ（約3時間）
• カサブランカ ⇔ フェズ（約4時間）
• TGV：カサブランカ-タンジェ高速鉄道
• 快適で時間通り、おすすめ！

**長距離バス:**
• CTM・スプラツアーズが主要会社
• 鉄道が通らない地域へのアクセス
• シャウエン、ザゴラなど

**市内交通:**
• **プチタクシー**（市内、メーター制）
• **グランタクシー**（都市間、相乗り）
• **トラム**（カサブランカ、ラバト）

**レンタカー:**
• 国際免許証必要
• 山道・砂漠道注意
• 都市部は運転困難

**配車アプリ:** Careem、InDriver（カサブランカ・ラバト）

**おすすめルート:**
カサブランカ→ラバト→フェズ→シャウエン→マラケシュ→サハラ

移動について具体的な質問はありますか？🗺️"""

    # 通貨・お金関連
    elif any(keyword in message_lower for keyword in ['通貨', 'お金', 'ディルハム', '両替', 'atm']):
        return """💰 **モロッコの通貨・お金情報**

**通貨:**
• **モロッコ・ディルハム（MAD）**
• 1ディルハム = 約15円（レート変動あり）
• 紙幣: 20, 50, 100, 200ディルハム
• 硬貨: 1, 2, 5, 10ディルハム、20, 50サンチーム

**両替:**
• 空港・銀行・両替所で可能
• ユーロ・USD・円対応
• レシート保管（再両替時必要）

**ATM:**
• 主要都市に多数設置
• Visa・MasterCard利用可
• 手数料: 約200-300円/回

**クレジットカード:**
• ホテル・レストランで利用可
• 伝統的な店・市場は現金のみ
• タッチ決済も普及中

**チップ文化:**
• レストラン: 10-15%
• ホテル: 10-20ディルハム
• ガイド: 50-100ディルハム/日
• タクシー: 端数切り上げ

**予算目安（1日）:**
• バックパッカー: 300-500ディルハム
• 中級: 800-1200ディルハム
• 高級: 1500ディルハム以上

💡 **節約のコツ:** 地元レストラン利用、交渉、グループ割引活用"""

    # その他の一般的な質問
    elif any(keyword in message_lower for keyword in ['おすすめ', 'プラン', '日程', 'ルート']):
        return """📅 **モロッコ観光おすすめプラン**

**🚀 初回訪問 7日間プラン:**

**Day 1-2: カサブランカ & ラバト**
• ハッサン2世モスク見学
• 首都ラバトの王宮・カスバ

**Day 3-4: フェズ**
• 世界遺産旧市街探索
• 伝統工芸品ショッピング

**Day 5: シャウエン**
• 青い街散策・撮影

**Day 6-7: マラケシュ**
• ジャマ・エル・フナ広場
• バイア宮殿・マジョレル庭園

**🌟 リピーター向け 10日間プラン:**
上記 + サハラ砂漠2泊3日

**⚡ 週末旅行 3日間:**
マラケシュ集中プラン

**🎯 テーマ別おすすめ:**
• **歴史好き:** フェズ→メクネス→ヴォルビリス
• **自然好き:** アトラス山脈→砂漠
• **グルメ好き:** マラケシュ料理教室ツアー

どのプランに興味がありますか？詳細をお教えします！✨"""

    # 安全・治安関連
    elif any(keyword in message_lower for keyword in ['安全', '治安', '危険', 'セキュリティ']):
        return """🛡️ **モロッコの安全・治安情報**

**全体的な治安:**
• 観光地は比較的安全
• 重大犯罪は少ない
• スリ・ぼったくりに注意

**注意すべきこと:**
• 夜間の単独行動避ける
• 貴重品管理徹底
• 法外な料金の交渉に注意
• 写真撮影許可確認

**女性旅行者への注意:**
• 保守的な服装推奨
• 夜間の外出は控えめに
• グループ行動推奨

**緊急連絡先:**
• 警察: 19
• 消防: 15
• 救急: 141
• 観光警察: 0537-20-94-94

**安全な地域:**
• マラケシュ新市街
• カサブランカ中心部
• 主要ホテル周辺

**避けるべき地域:**
• 夜間の旧市街裏通り
• 人気のない郊外
• 国境地域

**健康面:**
• 水道水は避ける（ボトル水推奨）
• 生野菜・氷に注意
• 日焼け対策必須

常識的な注意を払えば、素晴らしい旅行体験ができます！🌟"""

    # デフォルト応答
    else:
        return f"""🇲🇦 **「{user_message}」についてお答えします！**

申し訳ございません、より具体的にお聞かせください。
私はモロッコのことなら何でも知っているので、遠慮なくどうぞ！

**🗂️ よくご質問いただくトピック**

**�️ 都市・観光地情報**
• 「マラケシュの見どころは？」
• 「フェズで絶対行くべき場所」
• 「シャウエンの青い街について」
• 「サハラ砂漠ツアーの詳細」

**🍽️ グルメ・食文化**
• 「本場のタジン料理が食べたい」
• 「モロッコのお菓子おすすめは？」
• 「ミントティーの正しい飲み方」
• 「屋台で食べても安全？」

**✈️ 旅行計画・実用情報**
• 「7日間のベストルートを教えて」
• 「予算はどのくらい必要？」
• 「現地の交通手段について」
• 「服装や持ち物のアドバイス」

**�️ 文化・歴史・言語**
• 「イスラム文化で注意すべきことは？」
• 「ベルベル文化って何？」
• 「簡単なアラビア語を教えて」
• 「お土産におすすめの伝統工芸品」

**💡 こんな聞き方もOK！**
• 「友達3人で週末旅行したい」
• 「一人女性旅行で安全な場所は？」
• 「子連れファミリー向けスポット」
• 「写真映えするインスタスポット」

**あなたの旅が最高の体験になるよう、現地ガイド20年の経験を活かしてサポートします！**

どんな小さなことでも大丈夫です。遠慮なくお聞きください 😊✨"""

@chat_bp.route('/message', methods=['POST'])
def send_message():
    """チャットメッセージ処理"""
    try:
        data = request.get_json()
        user_message = data.get('message', '')
        
        # まずGPTサービスを試行
        if gpt_service and gpt_service.is_available():
            gpt_response = gpt_service.get_tourism_response(user_message)
            if gpt_response:
                return jsonify({
                    'success': True,
                    'response': gpt_response,
                    'source': 'gpt',
                    'timestamp': '2025-11-01T12:00:00Z'
                })
        
        # GPTが利用できない場合は従来のルールベース応答
        response = get_morocco_guide_response(user_message)
        
        return jsonify({
            'success': True,
            'response': response,
            'source': 'rule_based',
            'timestamp': '2025-11-01T12:00:00Z'
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@chat_bp.route('/suggestions')
def get_suggestions():
    """チャット提案取得"""
    suggestions = [
        # 🌟 人気の観光地
        "🌟 マラケシュで絶対行くべきスポット",
        "🏛️ フェズの迷宮都市を上手に歩くコツ",
        "💙 シャウエンのインスタ映えスポット",
        "🐪 サハラ砂漠キャンプの楽しみ方",
        
        # 🍽️ グルメ・食文化
        "🍽️ 本場のタジン料理おすすめ店",
        "🥘 地元民が通う隠れた名店",
        "🍃 モロッコミントティーの正しい飲み方",
        "🛒 スパイス市場での賢い買い物術",
        
        # ✈️ 旅行計画・実用情報
        "✈️ 初めてのモロッコ7日間プラン",
        "💰 予算別おすすめコース",
        "🚗 都市間の移動手段比較",
        "🧳 モロッコ旅行の持ち物リスト",
        
        # 👥 旅行スタイル別
        "👩‍🦱 女性一人旅の安全ガイド",
        "👨‍👩‍👧‍👦 子連れファミリー向けスポット",
        "💑 カップルにおすすめロマンチック旅",
        "🎒 バックパッカー向け格安旅行術",
        
        # 🎨 文化・体験
        "🎨 ベルベル文化体験ツアー",
        "🏺 伝統工芸品の見分け方",
        "🕌 イスラム文化のマナー",
        "💬 現地で使える簡単アラビア語",
        
        # 🛍️ ショッピング・お土産
        "🛍️ 値段交渉の成功テクニック",
        "🎁 日本人に人気のお土産ランキング",
        "🧶 本物のベルベル絨毯の選び方",
        "🥄 アルガンオイル購入ガイド",
        
        # 🌡️ 季節・気候
        "🌡️ モロッコ旅行のベストシーズン",
        "🌧️ 雨季でも楽しめる屋内スポット",
        "🌞 夏の暑さ対策アドバイス",
        "❄️ 冬のアトラス山脈の魅力",
        
        # 🏨 宿泊・アコモデーション
        "🏨 リヤド宿泊の楽しみ方",
        "⭐ エリア別ホテル選びのコツ",
        "🏕️ 砂漠キャンプの種類と違い",
        "💎 一度は泊まりたい高級リゾート"
    ]
    
    return jsonify({
        'success': True,
        'suggestions': suggestions
    })