"""
AIチャット機能API
"""

from flask import Blueprint, jsonify, request
import re

chat_bp = Blueprint('chat', __name__)

def get_morocco_guide_response(user_message):
    """モロッコ観光ガイドとしての専門的な応答を生成"""
    
    # メッセージを小文字化して解析
    message_lower = user_message.lower()
    
    # モロッコ観光ガイドとしての挨拶
    greeting_patterns = ['こんにちは', 'はじめまして', 'hello', 'hi', 'salut']
    if any(pattern in message_lower for pattern in greeting_patterns):
        return """مرحبا! (マルハバン - こんにちは)

私はモロッコ観光専門のAIガイドです🇲🇦

モロッコの魅力をご紹介させていただきます：
• 🏛️ **歴史的建造物**: フェズの旧市街、ハッサン2世モスク
• 🏔️ **自然景観**: サハラ砂漠、アトラス山脈
• 🎨 **文化体験**: ベルベル文化、伝統工芸
• 🍽️ **グルメ**: タジン料理、ミントティー

何について知りたいですか？お気軽にお聞きください！"""

    # 都市・地域に関する質問
    if any(city in message_lower for city in ['マラケシュ', 'marrakech', 'marrakesh']):
        return """🌅 **マラケシュ - 赤い街**

**必見スポット:**
• ジャマ・エル・フナ広場 - 夕方〜夜が最高！
• クトゥビアモスク - 12世紀の美しいミナレット
• バイア宮殿 - 精緻なイスラム建築
• マジョレル庭園 - イヴ・サンローランが愛した庭

**おすすめ体験:**
• 夜の屋台でタジン料理
• スーク（市場）でのお買い物
• 伝統的なハマム（公衆浴場）

**ベストシーズン:** 10月〜4月（涼しくて過ごしやすい）

他に知りたいことはありますか？"""

    elif any(city in message_lower for city in ['フェズ', 'fez', 'fès']):
        return """📚 **フェズ - 学問の都**

**歴史的価値:**
• 世界最古の大学「カラウィーン大学」(859年創立)
• ユネスコ世界遺産の旧市街（メディナ）
• 中世イスラム文化の宝庫

**見どころ:**
• フェズ・エル・バリ - 迷路のような旧市街
• ブー・イナニア・マドラサ - 美しい神学校
• 皮なめし場 - 伝統的な革製品工場
• 青い門（バブ・ブージュルード）

**文化体験:** 伝統工芸品（陶器、絨毯、革製品）の製作見学

**注意点:** 旧市街は迷いやすいので、ガイド同行推奨です。"""

    elif any(city in message_lower for city in ['シャウエン', 'chefchaouen', 'chaouen']):
        return """💙 **シャウエン - 青い真珠**

**魅力:**
• 建物の壁が青く塗られた美しい街並み
• インスタグラム映えスポットとして世界的に有名
• リフ山脈の麓の涼しい気候

**おすすめ活動:**
• 旧市街の散策（特に朝の光がベスト）
• ウタ・エル・ハマム広場でカフェタイム
• 地元のベルベル織物ショッピング
• スペイン・モスクからの街の全景

**アクセス:** フェズから車で約4時間、カサブランカから約5時間

**撮影のコツ:** 午前中の柔らかい日光が青い壁を美しく照らします📸"""

    # サハラ砂漠関連
    elif any(keyword in message_lower for keyword in ['サハラ', 'sahara', '砂漠', 'desert']):
        return """🐪 **サハラ砂漠 - 黄金の海**

**主要拠点:**
• **メルズーガ** - エルグ・シェビ大砂丘の玄関口
• **ザゴラ** - 小規模だが手軽にアクセス可能

**体験プログラム:**
• 🐪 ラクダトレッキング（1時間〜数日）
• ⭐ 砂漠キャンプ（星空観察）
• 🏕️ ベルベルテント宿泊
• 🌄 日の出・日の出鑑賞

**持参推奨品:**
• 日焼け止め・サングラス
• 防寒着（夜は0度近くまで下がります）
• カメラの砂対策

**ベストシーズン:** 10月〜4月（昼夜の温度差に注意）

砂漠での体験は一生の思い出になりますよ！🌟"""

    # 食事・グルメ関連
    elif any(keyword in message_lower for keyword in ['料理', '食べ物', 'グルメ', 'タジン', 'クスクス', 'food']):
        return """🍽️ **モロッコ料理の魅力**

**代表的な料理:**
• **タジン** - 円錐形の鍋で蒸し煮した料理
  - チキンタジン（レモンとオリーブ）
  - 牛肉タジン（プルーンとアーモンド）
• **クスクス** - 金曜日の伝統料理
• **パスティラ** - 甘じょっぱいパイ料理
• **ハリラ** - レンズ豆のスープ

**飲み物:**
• 🍃 **アタイ** - 甘いミントティー（おもてなしの象徴）
• ☕ **カフェ・オ・レ** - フランス風コーヒー

**スイーツ:**
• **ガズィーユ** - アーモンドクッキー
• **チェバキア** - 蜂蜜とゴマのお菓子

**食事マナー:** 右手で食べる、パンでタジンをすくう

どの料理について詳しく知りたいですか？🥘"""

    # 文化・宗教関連
    elif any(keyword in message_lower for keyword in ['文化', 'イスラム', '宗教', 'ベルベル', 'アラブ']):
        return """🕌 **モロッコの豊かな文化**

**民族構成:**
• **ベルベル人** - モロッコ先住民（40%）
• **アラブ人** - 7世紀以降の移住（40%）
• その他（ユダヤ系、サハラ系など）

**言語:**
• アラビア語（公用語）
• ベルベル語（アマジグ語、公用語）
• フランス語（旧宗主国、ビジネス語）
• 英語（観光地で通じる）

**宗教・習慣:**
• イスラム教スンニ派（95%）
• 1日5回の礼拝（アザーンの声が響く）
• 金曜日は聖なる日
• ラマダン月は日中断食

**伝統工芸:**
• 絨毯・キリム織り
• 陶器（フェズブルー）
• 革製品
• 金属細工

**音楽:** グナワ音楽、ベルベル音楽、アンダルス音楽

文化について何か特定の質問はありますか？🎭"""

    # 気候・季節関連
    elif any(keyword in message_lower for keyword in ['気候', '天気', '季節', 'ベストシーズン', 'いつ']):
        return """🌡️ **モロッコの気候とベストシーズン**

**地域別気候:**
• **沿岸部**（カサブランカ）- 地中海性気候、温暖
• **内陸部**（マラケシュ）- 大陸性、昼夜の温度差大
• **山岳部**（アトラス山脈）- 冬は雪、夏は涼しい
• **砂漠部**（サハラ）- 乾燥、昼暑く夜寒い

**季節ごとの特徴:**

**🌸 春（3-5月）**
• 気温: 15-25°C
• 花が咲き乱れる美しい季節
• 観光に最適

**☀️ 夏（6-8月）**
• 気温: 25-45°C
• 沿岸部は涼しい、内陸は酷暑
• 早朝・夕方の活動推奨

**🍂 秋（9-11月）**
• 気温: 20-30°C
• 最高の観光シーズン
• 砂漠ツアーに最適

**❄️ 冬（12-2月）**
• 気温: 5-20°C
• 雨季、山は雪
• 暖かい服装必須

**総合ベストシーズン:** 10月〜4月 🎯"""

    # 交通・アクセス関連
    elif any(keyword in message_lower for keyword in ['交通', 'アクセス', '移動', '電車', 'バス', 'タクシー']):
        return """🚅 **モロッコの交通手段**

**鉄道（ONCF）:**
• カサブランカ ⇔ マラケシュ（約3時間）
• カサブランカ ⇔ フェズ（約4時間）
• TGV：カサブランカ-タンジェ高速鉄道
• 快適で時間通り、おすすめ！

**長距離バス:**
• CTM・スプラツアーズが主要会社
• 鉄道が通らない地域へのアクセス
• シャウエン、ザゴラなど

**市内交通:**
• **プチタクシー**（市内、メーター制）
• **グランタクシー**（都市間、相乗り）
• **トラム**（カサブランカ、ラバト）

**レンタカー:**
• 国際免許証必要
• 山道・砂漠道注意
• 都市部は運転困難

**配車アプリ:** Careem、InDriver（カサブランカ・ラバト）

**おすすめルート:**
カサブランカ→ラバト→フェズ→シャウエン→マラケシュ→サハラ

移動について具体的な質問はありますか？🗺️"""

    # 通貨・お金関連
    elif any(keyword in message_lower for keyword in ['通貨', 'お金', 'ディルハム', '両替', 'atm']):
        return """💰 **モロッコの通貨・お金情報**

**通貨:**
• **モロッコ・ディルハム（MAD）**
• 1ディルハム = 約15円（レート変動あり）
• 紙幣: 20, 50, 100, 200ディルハム
• 硬貨: 1, 2, 5, 10ディルハム、20, 50サンチーム

**両替:**
• 空港・銀行・両替所で可能
• ユーロ・USD・円対応
• レシート保管（再両替時必要）

**ATM:**
• 主要都市に多数設置
• Visa・MasterCard利用可
• 手数料: 約200-300円/回

**クレジットカード:**
• ホテル・レストランで利用可
• 伝統的な店・市場は現金のみ
• タッチ決済も普及中

**チップ文化:**
• レストラン: 10-15%
• ホテル: 10-20ディルハム
• ガイド: 50-100ディルハム/日
• タクシー: 端数切り上げ

**予算目安（1日）:**
• バックパッカー: 300-500ディルハム
• 中級: 800-1200ディルハム
• 高級: 1500ディルハム以上

💡 **節約のコツ:** 地元レストラン利用、交渉、グループ割引活用"""

    # その他の一般的な質問
    elif any(keyword in message_lower for keyword in ['おすすめ', 'プラン', '日程', 'ルート']):
        return """📅 **モロッコ観光おすすめプラン**

**🚀 初回訪問 7日間プラン:**

**Day 1-2: カサブランカ & ラバト**
• ハッサン2世モスク見学
• 首都ラバトの王宮・カスバ

**Day 3-4: フェズ**
• 世界遺産旧市街探索
• 伝統工芸品ショッピング

**Day 5: シャウエン**
• 青い街散策・撮影

**Day 6-7: マラケシュ**
• ジャマ・エル・フナ広場
• バイア宮殿・マジョレル庭園

**🌟 リピーター向け 10日間プラン:**
上記 + サハラ砂漠2泊3日

**⚡ 週末旅行 3日間:**
マラケシュ集中プラン

**🎯 テーマ別おすすめ:**
• **歴史好き:** フェズ→メクネス→ヴォルビリス
• **自然好き:** アトラス山脈→砂漠
• **グルメ好き:** マラケシュ料理教室ツアー

どのプランに興味がありますか？詳細をお教えします！✨"""

    # 安全・治安関連
    elif any(keyword in message_lower for keyword in ['安全', '治安', '危険', 'セキュリティ']):
        return """🛡️ **モロッコの安全・治安情報**

**全体的な治安:**
• 観光地は比較的安全
• 重大犯罪は少ない
• スリ・ぼったくりに注意

**注意すべきこと:**
• 夜間の単独行動避ける
• 貴重品管理徹底
• 法外な料金の交渉に注意
• 写真撮影許可確認

**女性旅行者への注意:**
• 保守的な服装推奨
• 夜間の外出は控えめに
• グループ行動推奨

**緊急連絡先:**
• 警察: 19
• 消防: 15
• 救急: 141
• 観光警察: 0537-20-94-94

**安全な地域:**
• マラケシュ新市街
• カサブランカ中心部
• 主要ホテル周辺

**避けるべき地域:**
• 夜間の旧市街裏通り
• 人気のない郊外
• 国境地域

**健康面:**
• 水道水は避ける（ボトル水推奨）
• 生野菜・氷に注意
• 日焼け対策必須

常識的な注意を払えば、素晴らしい旅行体験ができます！🌟"""

    # デフォルト応答
    else:
        return f"""🇲🇦 **モロッコ観光について「{user_message}」ですね！**

申し訳ございませんが、より具体的な質問をしていただけますでしょうか？

**以下のようなトピックでお手伝いできます:**
• 🏛️ **都市・観光地** (マラケシュ、フェズ、シャウエン、サハラ砂漠など)
• 🍽️ **グルメ・料理** (タジン、クスクス、ミントティーなど)
• 🚌 **交通・移動** (電車、バス、タクシー情報)
• 🏨 **宿泊・ホテル** (リヤド、ホテル選びのコツ)
• 💰 **予算・通貨** (ディルハム、両替、チップ)
• 🌡️ **気候・服装** (ベストシーズン、持ち物)
• 🛡️ **安全・治安** (注意点、緊急連絡先)
• 🎭 **文化・習慣** (イスラム文化、ベルベル文化)

例: 「マラケシュのおすすめスポットは？」
「サハラ砂漠ツアーについて教えて」
「モロッコ料理で絶対食べるべきものは？」

遠慮なくお聞きください！موفق (ムワッファク - 幸運を)！✨"""

@chat_bp.route('/message', methods=['POST'])
def send_message():
    """チャットメッセージ処理"""
    try:
        data = request.get_json()
        user_message = data.get('message', '')
        
        # モロッコ観光ガイドとしてのAI応答
        response = get_morocco_guide_response(user_message)
        
        return jsonify({
            'success': True,
            'response': response,
            'timestamp': '2025-11-01T12:00:00Z'
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@chat_bp.route('/suggestions')
def get_suggestions():
    """チャット提案取得"""
    suggestions = [
        "マラケシュのおすすめスポットを教えて",
        "サハラ砂漠ツアーについて知りたい",
        "モロッコの気候・ベストシーズンは？",
        "フェズの旧市街について教えて",
        "シャウエン（青い街）の魅力は？",
        "モロッコ料理で絶対食べるべきものは？",
        "現地の通貨・両替について",
        "7日間のモロッコ周遊プランを教えて",
        "ミントティーの文化について",
        "モロッコの安全・治安情報を教えて",
        "ベルベル文化について知りたい",
        "カサブランカからの移動手段は？"
    ]
    
    return jsonify({
        'success': True,
        'suggestions': suggestions
    })